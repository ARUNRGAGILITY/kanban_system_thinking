<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board Software</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
   <style>
    * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}

/* Navigation */
.navbar {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 20px rgba(0,0,0,0.1);
}

.logo {
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
}

.nav-links {
    display: flex;
    gap: 2rem;
    align-items: center;
}

.nav-link {
    color: white;
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.nav-link:hover, .nav-link.active {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

/* Avatar */
.avatar-selector {
    position: relative;
}

.avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #4CAF50;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    cursor: pointer;
    border: 2px solid white;
}

.avatar-dropdown {
    position: absolute;
    top: 50px;
    right: 0;
    background: white;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    min-width: 200px;
    display: none;
    z-index: 1000;
}

.avatar-option {
    padding: 1rem;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.avatar-option:hover {
    background: #f5f5f5;
}

/* Main Content */
.main-content {
    padding: 2rem;
    width: 100%;
    margin: 0 auto;
}

.page {
    display: none;
}

.page.active {
    display: block;
}

/* Board Container */
.board-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    width: 100%;
    box-sizing: border-box;
}
.board-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.board-title {
    font-size: 2rem;
    color: #333;
    margin: 0;
}

/* Board Layout */
/* Board Layout */
.kanban-board {
    display: flex;
    gap: 1rem;
    width: 100%;
    padding-bottom: 1rem;
}

.board-with-policies {
    display: flex;
    gap: 1rem;
    width: 100%;
    padding-bottom: 1rem;
    align-items: stretch;
    min-height: 650px;
}

.column-with-policies {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-width: 0;
    align-items: stretch;
    height: 100%;
}

.column {
    flex: 1;
    min-width: 0;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 0.75rem;
    border: 2px solid #e9ecef;
    margin-bottom: 1rem;
    display: flex;
    flex-direction: column;
    min-height: 500px;
}

.column-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #dee2e6;
}

.column-title {
    font-weight: bold;
    color: #495057;
}

.wip-limit {
    background: #dc3545;
    color: white;
    border-radius: 15px;
    padding: 0.2rem 0.8rem;
    font-size: 0.8rem;
}

.wip-limit.ok {
    background: #28a745;
}

.column-content {
    min-height: 400px;
    flex: 1;
    display: flex;
    flex-direction: column;
}

/* Cards */
.card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    cursor: grab;
    border-left: 4px solid #007bff;
    position: relative;
    transition: all 0.3s ease;
}

.card:active {
    cursor: grabbing;
}

.card.blocked {
    border-left-color: #dc3545;
    border: 2px solid #dc3545;
    background: #fff5f5;
}

.card.my-card {
    border-left-color: #28a745 !important;
}

.card.other-card {
    border-left-color: #6c757d !important;
}

.card-ghost {
    opacity: 0.5;
    transform: rotate(5deg);
}

.card-chosen {
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.card-title {
    font-weight: bold;
    color: #333;
    flex-grow: 1;
}

.card-age {
    display: flex;
    gap: 2px;
}

.age-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #ffc107;
}

.age-dot.old {
    background: #dc3545;
}

.card-assignee {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
}

.card.other-card .card-assignee {
    color: #fd7e14;
    font-weight: bold;
}

.card.my-card .card-assignee {
    color: #28a745;
    font-weight: bold;
}

.card-description {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.5rem;
}

.card-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

/* Buttons */
.btn {
    padding: 0.4rem 0.8rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-1px);
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
}

.btn-warning {
    background: #ffc107;
    color: #212529;
}

.icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.3rem;
    border-radius: 3px;
    font-size: 1rem;
    transition: all 0.2s ease;
}

.icon-btn:hover {
    background: rgba(0, 0, 0, 0.1);
    transform: scale(1.1);
}

.icon-btn.edit {
    color: #007bff;
}

.icon-btn.block {
    color: #ffc107;
}

.icon-btn.blocked {
    color: #dc3545;
}

.icon-btn.delete {
    color: #dc3545;
}

/* Modals */
.modal, .attendee-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
}

.attendee-modal {
    z-index: 1100;
    background: rgba(0,0,0,0.6);
}

.modal-content {
    background: white;
    margin: 5% auto;
    padding: 2rem;
    border-radius: 15px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.attendee-modal-content {
    background: white;
    margin: 10% auto;
    padding: 2rem;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #eee;
}

.close {
    font-size: 2rem;
    cursor: pointer;
    color: #999;
}

/* Forms */
.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: bold;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 0.8rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

/* Board Title Input */
.board-title-input:focus {
    outline: 2px solid #007bff;
    border-radius: 5px;
    background: rgba(255, 255, 255, 0.9);
}

/* Sub-columns */
.sub-column {
    margin-bottom: 1rem;
}

.sub-column-title {
    background: #e9ecef;
    padding: 0.5rem;
    border-radius: 5px 5px 0 0;
    font-size: 0.85rem;
    font-weight: bold;
    color: #495057;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sub-column-title.doing {
    background: #fff3cd;
    color: #856404;
}

.sub-column-title.done {
    background: #d1ecf1;
    color: #0c5460;
}

.sub-column-content {
    background: #f8f9fa;
    padding: 0.5rem;
    border-radius: 0 0 5px 5px;
    border: 1px solid #e9ecef;
    border-top: none;
    min-height: 80px;
}

.buffer-column .sub-column-title {
    background: #f8d7da;
    color: #721c24;
}

/* Column Policies */

.policies-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    font-weight: bold;
    color: #495057;
    font-size: 0.8rem;
}

.policy-edit-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.3rem;
    border-radius: 4px;
    font-size: 1rem;
    color: #007bff;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    min-height: 24px;
    opacity: 0;
    visibility: hidden;
}

.policy-edit-btn:hover {
    background: rgba(0, 123, 255, 0.1);
    transform: scale(1.1);
}

.column-policies:hover .policy-edit-btn,
.policies-section:hover .policy-edit-btn {
    opacity: 1;
    visibility: visible;
}





.policy-bullet::before {
    content: "•";
    color: #007bff;
    font-weight: bold;
    flex-shrink: 0;
}

.policy-placeholder {
    color: #999;
    font-style: italic;
    text-align: center;
    padding: 0.8rem;
    font-size: 0.8rem;
    border: 1px dashed #dee2e6;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.policy-placeholder:hover {
    background: rgba(0, 123, 255, 0.05);
    border-color: #007bff;
    color: #007bff;
}

/* Common Policies */
.policies-section {
    margin-top: 3rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 10px;
}

.policies-header-common {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.policies-header-common h3 {
    margin: 0;
    color: #333;
}

.common-policies-content {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e9ecef;
}

.common-policies-content .policy-bullet {
    margin-bottom: 0.8rem;
    padding: 0.5rem;
    background: white;
    border-radius: 5px;
    border-left: 3px solid #007bff;
    font-size: 0.9rem;
}

.common-policies-content .policy-bullet:last-child {
    margin-bottom: 0;
}

.policy-item {
    background: white;
    margin: 0.5rem 0;
    padding: 0.8rem;
    border-radius: 5px;
    border-left: 3px solid #007bff;
    line-height: 1.5;
}

.policy-item strong {
    color: #333;
}

/* Swimlanes */
.swimlanes-container {
    display: table;
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.swimlane-header-row {
    display: table-row;
    background: #f8f9fa;
    font-weight: bold;
}

.swimlane-assignee-header,
.swimlane-column-header {
    display: table-cell;
    padding: 1rem;
    border: 1px solid #dee2e6;
    text-align: center;
    vertical-align: middle;
    background: #e9ecef;
}

.swimlane-assignee-header {
    min-width: 150px;
    background: #007bff;
    color: white;
}

.swimlane {
    display: table-row;
}

.swimlane-assignee {
    display: table-cell;
    padding: 1rem;
    border: 1px solid #dee2e6;
    vertical-align: top;
    background: #f8f9fa;
    font-weight: bold;
    min-width: 150px;
    text-align: center;
}

.swimlane-column {
    display: table-cell;
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    vertical-align: top;
    min-width: 200px;
    background: white;
}

.swimlane-content {
    min-height: 100px;
}

/* Classes of Service */
.cos-container {
    display: table;
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.cos-header-row {
    display: table-row;
    background: #f8f9fa;
    font-weight: bold;
}

.cos-class-header,
.cos-column-header {
    display: table-cell;
    padding: 1rem;
    border: 1px solid #dee2e6;
    text-align: center;
    vertical-align: middle;
    background: #e9ecef;
}

.cos-class-header {
    min-width: 200px;
    background: #6f42c1;
    color: white;
}

.cos-lane {
    display: table-row;
}

.cos-class {
    display: table-cell;
    padding: 1rem;
    border: 1px solid #dee2e6;
    vertical-align: top;
    min-width: 200px;
    text-align: center;
}

.cos-column {
    display: table-cell;
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    vertical-align: top;
    min-width: 200px;
    background: white;
}

.cos-content {
    min-height: 100px;
}

/* Reviews */
.review-content {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.review-list {
    display: grid;
    gap: 1rem;
    margin-top: 2rem;
}

.review-item {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
}

.review-item.service-review {
    border-left-color: #28a745;
}

.review-item.operations-review {
    border-left-color: #fd7e14;
}

.review-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.review-item-title {
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 0.5rem;
}

.review-item-date {
    font-size: 0.9rem;
    color: #6c757d;
    background: #f8f9fa;
    padding: 0.25rem 0.5rem;
    border-radius: 15px;
}

.review-item-actions {
    display: flex;
    gap: 0.5rem;
}

.review-item-content {
    color: #666;
    line-height: 1.6;
    margin-bottom: 1rem;
}

.review-item-attendees {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
}

.review-item-outcomes {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
}

.sort-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
}

.sort-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.2s;
}

.sort-btn:hover, .sort-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.trash-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px solid #dee2e6;
}

.trash-item {
    opacity: 0.6;
    border-left-color: #dc3545 !important;
}

.restore-btn {
    background: #28a745;
    color: white;
}

.review-tab {
    display: none;
}

.review-tab.active {
    display: block;
}

/* Review Tab Navigation */
.review-tab-nav {
    display: flex;
    gap: 1rem;
    justify-content: flex-start;
    margin-bottom: 2rem;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0;
}

.review-tab-btn {
    background: #6c757d;
    color: white;
    text-decoration: none;
    padding: 0.75rem 1.5rem;
    border-radius: 10px 10px 0 0;
    transition: all 0.3s ease;
    cursor: pointer;
    border: none;
    font-size: 1rem;
    font-weight: 500;
    position: relative;
    top: 2px;
}

.review-tab-btn:hover {
    background: #28a745;
    transform: translateY(-2px);
    color: white;
}

.review-tab-btn.active {
    background: #007bff;
    color: white;
    transform: translateY(0);
}

/* Attendee Selection */
.attendee-list {
    max-height: 300px;
    overflow-y: auto;
    margin: 1rem 0;
}

.attendee-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 0.5rem;
    background: #f8f9fa;
}

.attendee-item input[type="checkbox"] {
    margin-right: 0.5rem;
}

.select-all-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    margin-bottom: 1rem;
}

.select-all-btn:hover {
    background: #0056b3;
}

.additional-attendees {
    margin-top: 1rem;
}

.additional-attendees textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    min-height: 60px;
    resize: vertical;
}

/* Experiments */
.experiment-tab-nav {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0;
}

.experiment-view-btn {
    background: #6c757d;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 10px 10px 0 0;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s ease;
    position: relative;
    top: 2px;
}

.experiment-view-btn:hover {
    background: #28a745;
    transform: translateY(-2px);
}

.experiment-view-btn.active {
    background: #007bff;
    transform: translateY(0);
}

.experiment-view {
    display: none;
}

.experiment-view.active {
    display: block;
}

/* Experiment Cards */
.experiment-card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    cursor: grab;
    border-left: 4px solid #007bff;
    position: relative;
    animation: slideIn 0.3s ease-out;
}

.experiment-card:active {
    cursor: grabbing;
}

.experiment-card.high-impact {
    border-left-color: #dc3545;
}

.experiment-card.low-impact {
    border-left-color: #6c757d;
}

.experiment-card.easy-implementation {
    background: linear-gradient(to right, white 95%, #28a745 5%);
}

.experiment-card.hard-implementation {
    background: linear-gradient(to right, white 95%, #ffc107 5%);
}

.experiment-priority-badges {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.priority-badge {
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: bold;
    display: inline-block;
}

.impact-high,
.priority-badge.impact-high {
    background: #dc3545;
    color: white;
}

.impact-low,
.priority-badge.impact-low {
    background: #6c757d;
    color: white;
}

.implementation-easy,
.priority-badge.implementation-easy {
    background: #28a745;
    color: white;
}

.implementation-hard,
.priority-badge.implementation-hard {
    background: #ffc107;
    color: #212529;
}

/* Matrix Experiment Cards */
.matrix-experiment-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 0.8rem;
    margin-bottom: 0.6rem;
    box-shadow: 0 3px 12px rgba(0,0,0,0.15);
    cursor: grab;
    border: 1px solid rgba(0,0,0,0.1);
    font-size: 0.85rem;
    backdrop-filter: blur(8px);
    transition: all 0.3s ease;
    position: relative;
    animation: slideIn 0.3s ease-out;
}

.matrix-experiment-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    background: rgba(255, 255, 255, 1);
}

.matrix-experiment-card:active {
    cursor: grabbing;
    transform: translateY(0) scale(0.98);
}

.matrix-experiment-card .card-title {
    font-weight: bold;
    margin-bottom: 0.4rem;
    font-size: 0.95rem;
    line-height: 1.3;
    color: #333;
}

.matrix-experiment-card .card-description {
    color: #666;
    font-size: 0.8rem;
    margin-bottom: 0.4rem;
    line-height: 1.4;
    word-wrap: break-word;
}

.matrix-experiment-card .card-assignee {
    font-size: 0.75rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
}

.matrix-experiment-card .card-actions {
    display: flex;
    gap: 0.4rem;
    margin-top: 0.5rem;
    justify-content: flex-end;
}

.matrix-experiment-card .icon-btn {
    padding: 0.3rem;
    font-size: 0.9rem;
    min-width: 24px;
    min-height: 24px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.matrix-experiment-card .icon-btn:hover {
    transform: scale(1.1);
}

.card-ghost.matrix-experiment-card {
    opacity: 0.5;
    transform: rotate(5deg) scale(0.9);
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    background: rgba(255, 255, 255, 0.8);
}

/* Prioritize Matrix */
.prioritize-matrix {
    margin-top: 2rem;
    background: white;
    border-radius: 10px;
    padding: 2rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.matrix-labels {
    display: flex;
    align-items: stretch;
    min-height: 400px;
}

.y-axis-label {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    font-weight: bold;
    font-size: 1.2rem;
    color: #333;
    margin-right: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.matrix-container {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.x-axis-labels {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-weight: bold;
    color: #333;
    padding: 0 1rem;
}

.matrix-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: auto auto;
    gap: 2px;
    border: 2px solid #333;
    flex: 1;
}

.quadrant {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    position: relative;
    min-height: 200px;
    transition: min-height 0.3s ease;
}

.quadrant:hover .quadrant-content {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
}

.quadrant-title {
    font-weight: bold;
    text-align: center;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    line-height: 1.2;
    color: #495057;
    flex-shrink: 0;
    padding: 0.5rem;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 5px;
    backdrop-filter: blur(5px);
}

.quadrant-content {
    flex: 1;
    overflow: visible;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding-top: 0.5rem;
}

.quadrant-content:empty::after {
    content: "Drop experiments here";
    color: #999;
    font-style: italic;
    text-align: center;
    padding: 2rem 1rem;
    border: 2px dashed #ccc;
    border-radius: 8px;
    display: block;
    background: rgba(255, 255, 255, 0.5);
}

.quadrant-content.drag-over {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    outline: 2px dashed #007bff;
    outline-offset: -2px;
}

.high-impact-hard {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-color: #856404;
}

.high-impact-easy {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    border-color: #0c5460;
}

.low-impact-hard {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    border-color: #721c24;
}

.low-impact-easy {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border-color: #155724;
}

.axis-labels {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    margin-left: 1rem;
    font-weight: bold;
    color: #333;
    align-self: stretch;
}

.y-high {
    align-self: flex-start;
    padding-top: 1rem;
}

.y-low {
    align-self: flex-end;
    padding-bottom: 1rem;
}

/* Business Document */
.business-document {
    max-width: 1000px;
    margin: 2rem auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    padding: 3rem;
    line-height: 1.8;
}

.business-doc-section {
    margin-bottom: 3rem;
    position: relative;
}

.business-doc-section:last-child {
    margin-bottom: 0;
}

.business-doc-title {
    color: #333;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #007bff;
}

.business-doc-content {
    min-height: 80px;
    padding: 1.5rem;
    border-radius: 8px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    background: #f8f9fa;
    color: #333;
    white-space: pre-wrap;
}

.business-doc-content:hover {
    border-color: #007bff;
    background: #fff;
    box-shadow: 0 4px 12px rgba(0,123,255,0.15);
    transform: translateY(-2px);
}

.business-doc-content:empty::before {
    content: "Click to add content...";
    color: #999;
    font-style: italic;
}

.edit-overlay {
    position: absolute;
    top: 10px;
    right: 15px;
    background: #007bff;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.business-doc-content:hover .edit-overlay {
    opacity: 1;
}

.business-doc-content .mermaid {
    text-align: center;
    margin: 1rem 0;
    background: white;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.business-doc-content h3 {
    color: #007bff;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
}

.business-doc-content ul,
.business-doc-content ol {
    margin: 1rem 0;
    padding-left: 2rem;
}

.business-doc-content li {
    margin-bottom: 0.5rem;
}

.business-doc-content blockquote {
    border-left: 4px solid #007bff;
    padding-left: 1rem;
    margin: 1rem 0;
    font-style: italic;
    color: #666;
}

.business-doc-content code {
    background: #f1f3f4;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: monospace;
}

.business-doc-content pre {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 5px;
    overflow-x: auto;
    margin: 1rem 0;
}

/* Business Page */
.business-section {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.business-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
}

.business-header h3 {
    margin: 0;
    color: #333;
}

.business-display {
    min-height: 60px;
    line-height: 1.6;
    color: #666;
    white-space: pre-wrap;
}

.business-display:empty::after {
    content: "Click Edit to add content...";
    color: #999;
    font-style: italic;
}

/* Business Main Tab Navigation */
.business-main-tab-nav {
    display: flex;
    gap: 1rem;
    justify-content: flex-start;
    margin-bottom: 2rem;
    border-bottom: 3px solid #e9ecef;
    padding-bottom: 0;
}

.business-main-tab-btn {
    background: #6c757d;
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 15px 15px 0 0;
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    position: relative;
    top: 3px;
    min-width: 180px;
}

.business-main-tab-btn:hover {
    background: #28a745;
    transform: translateY(-3px);
}

.business-main-tab-btn.active {
    background: #007bff;
    transform: translateY(0);
    box-shadow: 0 -2px 10px rgba(0,123,255,0.3);
}

.business-main-tab-content {
    display: none;
    animation: fadeIn 0.3s ease-in;
}

.business-main-tab-content.active {
    display: block;
}

/* VSM Container */
.vsm-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    padding: 2rem;
    margin-top: 2rem;
}

.vsm-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #28a745;
}

.vsm-header h2 {
    color: #28a745;
    font-size: 1.8rem;
    margin-bottom: 0.5rem;
}

.vsm-header p {
    color: #666;
    font-size: 1rem;
}

/* VSM Sub-tab Navigation */
.vsm-sub-tab-nav {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0;
    justify-content: center;
}

.vsm-sub-tab-btn {
    background: #6c757d;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 10px 10px 0 0;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s ease;
    position: relative;
    top: 2px;
    min-width: 140px;
}

.vsm-sub-tab-btn:hover {
    background: #28a745;
    transform: translateY(-2px);
}

.vsm-sub-tab-btn.active {
    background: #007bff;
    transform: translateY(0);
}

.vsm-sub-tab-content {
    display: none;
}

.vsm-sub-tab-content.active {
    display: block;
}

/* Steps Management */
.steps-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.steps-header h3 {
    color: #333;
    margin: 0;
    font-size: 1.3rem;
}

.steps-list {
    display: grid;
    gap: 1rem;
    max-width: 800px;
    margin: 0 auto;
}

.step-item {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    border-left: 4px solid #007bff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: grab;
    transition: all 0.3s ease;
    position: relative;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.step-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

.step-item:active {
    cursor: grabbing;
}

.step-item.trigger {
    border-left-color: #6f42c1;
    background: linear-gradient(45deg, #e2d9f3, #ffffff);
}

.step-item.value {
    border-left-color: #28a745;
    background: linear-gradient(45deg, #d4edda, #ffffff);
}

.step-item.process {
    border-left-color: #007bff;
    background: linear-gradient(45deg, #cce7ff, #ffffff);
}

.step-content {
    flex: 1;
    text-align: center;
}

.step-title {
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

.step-description {
    color: #495057;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    line-height: 1.4;
}

.step-metrics {
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
    color: #495057;
    justify-content: center;
    font-weight: 500;
}

.step-actions {
    display: flex;
    gap: 0.5rem;
}

.drag-handle {
    color: #495057;
    cursor: grab;
    font-size: 1.2rem;
    margin-right: 1rem;
    font-weight: bold;
}

/* VSM Metrics Card */
.vsm-metrics-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.vsm-metrics-card h3 {
    margin: 0 0 1.5rem 0;
    text-align: center;
    font-size: 1.5rem;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.metric-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 1rem;
    border-radius: 10px;
    text-align: center;
    backdrop-filter: blur(10px);
}

.metric-item.highlight {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.metric-label {
    display: block;
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 0.5rem;
}

.metric-value {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
}

/* Value Stream Flow */
.flow-legend {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: #495057;
    font-weight: 500;
}

.value-indicator,
.delay-indicator,
.trigger-indicator,
.outcome-indicator {
    width: 20px;
    height: 20px;
    border-radius: 50%;
}

.value-indicator {
    background: #28a745;
}

.delay-indicator {
    background: #ffc107;
}

.trigger-indicator {
    background: #6f42c1;
}

.outcome-indicator {
    background: #28a745;
}

.flow-container {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 2rem;
    min-height: 300px;
    position: relative;
    overflow-x: auto;
    text-align: center;
}

.flow-step {
    display: inline-block;
    background: white;
    border-radius: 10px;
    padding: 1rem;
    margin: 0 1rem;
    min-width: 150px;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    position: relative;
    vertical-align: top;
}

.flow-step.trigger {
    border-top: 4px solid #6f42c1;
}

.flow-step.value {
    border-top: 4px solid #28a745;
}

.flow-step.process {
    border-top: 4px solid #007bff;
}

.flow-step-name {
    font-weight: bold;
    margin-bottom: 0.5rem;
    color: #2c3e50;
    font-size: 1rem;
}

.flow-step-times {
    font-size: 0.8rem;
    color: #495057;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.flow-step-accuracy {
    font-size: 0.8rem;
    color: #2c3e50;
    background: #e9ecef;
    padding: 0.2rem 0.5rem;
    border-radius: 15px;
    font-weight: 500;
}

.flow-arrow {
    display: inline-block;
    font-size: 1.5rem;
    color: #007bff;
    vertical-align: middle;
    margin: 0 0.5rem;
}

.time-indicator {
    position: absolute;
    bottom: -25px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
    color: white;
    font-weight: 500;
}

.time-indicator.value-added {
    background: #28a745;
}

.time-indicator.delay {
    background: #ffc107;
    color: #333;
}

/* VSM Help */
.vsm-help-content {
    max-width: 900px;
    margin: 2rem auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    padding: 3rem;
    line-height: 1.8;
}

.help-intro {
    text-align: center;
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 2px solid #28a745;
}

.help-intro h2 {
    color: #28a745;
    font-size: 2rem;
    margin-bottom: 1rem;
}

.help-intro p {
    color: #666;
    font-size: 1.1rem;
}

.help-section {
    margin-bottom: 3rem;
}

.help-section h3 {
    color: #2c3e50;
    font-size: 1.4rem;
    margin-bottom: 1rem;
    border-left: 4px solid #007bff;
    padding-left: 1rem;
}

.help-section p,
.help-section li {
    color: #495057;
    margin-bottom: 0.8rem;
}

.help-section ul {
    margin-left: 1.5rem;
}

.help-benefits {
    background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
    padding: 2rem;
    border-radius: 10px;
    border-left: 4px solid #28a745;
}

.help-example {
    background: #f8f9fa;
    padding: 2rem;
    border-radius: 10px;
    margin: 1rem 0;
    border-left: 4px solid #007bff;
}

.help-tip {
    background: linear-gradient(135deg, #fff3cd 0%, #fef9e7 100%);
    padding: 1.5rem;
    border-radius: 10px;
    margin: 1rem 0;
    border-left: 4px solid #ffc107;
}

.help-tip strong {
    color: #856404;
}

/* Help Page */
.help-content {
    max-width: 1000px;
    margin: 2rem auto;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 3rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}

.help-content h1 {
    max-width: 800px;
    margin: 0 auto 2rem auto;
    text-align: center;
}

.help-section {
    margin-bottom: 3rem;
}

.help-section h2 {
    color: #333;
    margin-bottom: 1rem;
    border-bottom: 2px solid #007bff;
    padding-bottom: 0.5rem;
}

.help-section h3 {
    color: #666;
    margin: 1.5rem 0 0.5rem 0;
}

.help-section ul {
    margin-left: 1.5rem;
    margin-top: 1rem;
}

.help-section ul li {
    margin-bottom: 0.8rem;
    line-height: 1.6;
}

.values-list,
.principles-list,
.practices-list {
    list-style: none;
    padding-left: 0;
}

.values-list li,
.principles-list li,
.practices-list li {
    background: #f8f9fa;
    margin-bottom: 1rem;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

/* Metrics */
.metrics-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}

.metric-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.metric-title {
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 1rem;
    color: #333;
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: orange;
    margin-bottom: 0.5rem;
}

.chart-container {
    position: relative;
    height: 300px;
    margin-top: 2rem;
}

/* Team */
.team-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}

.team-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
}

.team-member {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    text-align: center;
}

.member-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #007bff;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0 auto 1rem;
}

.member-name {
    font-weight: bold;
    color: #333;
    margin-bottom: 0.5rem;
}

.member-role {
    color: #666;
    font-size: 0.9rem;
}

/* Delete confirmation modal specific styles */
#experimentToDelete {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}

/* Animations */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
/* Responsive Design */
@media (max-width: 1200px) {
    .matrix-labels {
        min-height: 350px;
    }
    
    .quadrant {
        min-height: 150px;
        padding: 0.8rem;
    }
    
    .column {
        padding: 0.5rem;
        min-height: 400px;
    }
    
    .board-with-policies {
        gap: 0.75rem;
    }
}

@media (max-width: 992px) {
    .column {
        padding: 0.5rem;
        min-height: 350px;
    }
    
    .column-policies {
        min-height: 100px;
        padding: 0.5rem;
    }
    
    .card {
        padding: 0.75rem;
        margin-bottom: 0.75rem;
    }
}

@media (max-width: 768px) {
    .nav-links {
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .main-content {
        padding: 1rem;
    }
    
    .board-container {
        padding: 1rem;
    }
    
    .column {
        padding: 0.5rem;
        min-height: 300px;
    }
    
    .column-policies {
        min-height: 80px;
        padding: 0.5rem;
        font-size: 0.8rem;
    }
    
    .card {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    .card-title {
        font-size: 0.9rem;
        line-height: 1.3;
    }
    
    .card-description {
        font-size: 0.8rem;
        line-height: 1.4;
    }
    
    .card-actions {
        gap: 0.25rem;
    }
    
    .icon-btn {
        padding: 0.2rem;
        font-size: 0.9rem;
    }
    
    /* ... keep all your existing mobile styles ... */
}

@media (max-width: 576px) {
    .board-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .column {
        min-height: 250px;
        padding: 0.4rem;
    }
    
    .column-header {
        padding: 0.5rem 0;
        font-size: 0.9rem;
    }
    
    .card {
        padding: 0.4rem;
        margin-bottom: 0.4rem;
        font-size: 0.85rem;
    }
    
    .card-title {
        font-size: 0.85rem;
    }
    
    .card-description {
        font-size: 0.75rem;
    }
    
    .card-assignee {
        font-size: 0.7rem;
    }
    
    .column-policies {
        display: none !important;
    }
}

@media (max-width: 768px) {
    .nav-links {
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .kanban-board {
        flex-direction: column;
    }
    
    .column {
        min-width: unset;
    }
    
    .swimlanes-container {
        display: block;
    }
    
    .swimlane-header-row,
    .swimlane {
        display: block;
    }
    
    .swimlane-assignee-header,
    .swimlane-column-header,
    .swimlane-assignee,
    .swimlane-column {
        display: block;
        width: 100%;
    }
    
    .metrics-grid {
        grid-template-columns: 1fr;
    }
    
    .flow-legend {
        gap: 1rem;
    }
    
    .steps-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .step-metrics {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .prioritize-matrix {
        padding: 1rem;
    }
    
    .matrix-labels {
        min-height: 300px;
    }
    
    .matrix-grid {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
    }
    
    .y-axis-label {
        writing-mode: sideways-lr;
        text-orientation: mixed;
        margin-right: 0;
        margin-bottom: 1rem;
        order: -1;
    }
    
    .x-axis-labels {
        order: -1;
        margin-bottom: 1rem;
    }
    
    .quadrant {
        min-height: 120px;
        padding: 0.6rem;
    }
    
    .matrix-experiment-card {
        padding: 0.6rem;
        font-size: 0.8rem;
    }
}
   </style>

<style>
    /* Sub-column styling */
.sub-column {
    margin-bottom: 1rem;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: #ffffff;
    min-width: 0; /* Add this */
    overflow: hidden; /* Add this */
}



.sub-column-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    border-radius: 8px 8px 0 0;
    font-size: 0.9rem;
    font-weight: 500;
}

.sub-column-header.todo {
    background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
    border-left: 4px solid #6c757d;
    color: #495057;
}

.sub-column-header.in-progress {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-left: 4px solid #ffc107;
    color: #856404;
}

.sub-column-header.done {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    border-left: 4px solid #28a745;
    color: #0c5460;
}

.sub-column-content {
    padding: 0.75rem;
    min-height: 100px;
    background: #fefefe;
    border-radius: 0 0 8px 8px;
    min-width: 0; /* Add this */
}

/* Buffer column pair styling */
.buffer-pair-container {
    display: flex;
    margin: 1rem 0;
    border-radius: 10px;
    overflow: hidden;
    border: 2px solid #dee2e6;
    min-height: 120px;
}

.buffer-pair-container.column {
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    border-color: #ff9800;
}

.buffer-pair-container.subColumn {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-color: #2196f3;
    margin-left: 1.5rem;
    margin-top: 0.75rem;
}

.buffer-column {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.buffer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    font-size: 0.9rem;
    font-weight: 600;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.buffer-column.doing .buffer-header {
    background: rgba(255, 193, 7, 0.2);
    color: #856404;
    border-left: 3px solid #ffc107;
}

.buffer-column.done .buffer-header {
    background: rgba(40, 167, 69, 0.2);
    color: #155724;
    border-left: 3px solid #28a745;
}


.buffer-content {
    flex: 1;
    padding: 0.75rem;
    min-height: 80px;
    background: rgba(255, 255, 255, 0.8);
    min-width: 0; /* Add this */
    overflow: hidden; /* Add this */
}

.buffer-separator {
    width: 3px;
    background: repeating-linear-gradient(
        to bottom,
        #333 0px,
        #333 10px,
        transparent 10px,
        transparent 20px
    );
    margin: 8px 0;
}

/* Card count badges */
.card-count {
    background: rgba(0, 0, 0, 0.1);
    padding: 0.25rem 0.6rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
    min-width: 20px;
    text-align: center;
}

/* Column-level policies visibility */
.column-policies {
    margin-top: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 0.75rem;
    border: 1px solid #e9ecef;
    font-size: 0.85rem;
    width: 100%;
    flex-shrink: 0;
    height: 420px;
    overflow-y: auto;
}

.policies-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    font-weight: bold;
    color: #495057;
    font-size: 0.9rem;
}

.policy-edit-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.3rem;
    border-radius: 4px;
    font-size: 1rem;
    color: #007bff;
    transition: all 0.2s;
    opacity: 0;
    visibility: hidden;
}

.policy-edit-btn:hover {
    background: rgba(0, 123, 255, 0.1);
    transform: scale(1.1);
}

.column-policies:hover .policy-edit-btn {
    opacity: 1;
    visibility: visible;
}

.policies-content {
    line-height: 1.4;
}

.policy-bullet {
    margin-bottom: 0.6rem;
    color: #666;
    font-size: 0.85rem;
    display: flex;
    align-items: flex-start;
    gap: 0.4rem;
    padding: 0.4rem;
    background: white;
    border-radius: 5px;
    border-left: 3px solid #007bff;
}

.policy-bullet::before {
    content: "•";
    color: #007bff;
    font-weight: bold;
    flex-shrink: 0;
}

.policy-bullet:last-child {
    margin-bottom: 0;
}

.policy-placeholder {
    color: #999;
    font-style: italic;
    text-align: center;
    padding: 1rem;
    font-size: 0.85rem;
    border: 2px dashed #dee2e6;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
}

.policy-placeholder:hover {
    background: rgba(0, 123, 255, 0.05);
    border-color: #007bff;
    color: #007bff;
}

/* Ensure column-with-policies maintains proper flex layout */
.column-with-policies {
    display: flex;
    flex-direction: column;
    min-width: 320px;
    flex: 1;
    align-items: stretch;
    height: 100%;
}

/* Make sure policies are always visible when enabled */
.board-with-policies .column-policies {
    display: block !important;
}

/* Vertical buffer layout */
.buffer-pair-vertical {
    display: flex;
    flex-direction: column;
    margin: 0.5rem 0;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    overflow: hidden;
}

.buffer-pair-vertical.column {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-color: #ffc107;
}

.buffer-pair-vertical.subColumn {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    border-color: #17a2b8;
    margin-left: 1rem;
}

.buffer-separator-horizontal {
    height: 2px;
    background: repeating-linear-gradient(
        to right,
        #333 0px,
        #333 8px,
        transparent 8px,
        transparent 16px
    );
    margin: 0 8px;
}

/* Fix card display issues */
.card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    cursor: grab;
    border-left: 4px solid #007bff;
    position: relative;
    transition: all 0.3s ease;
    word-wrap: break-word; /* Add this */
    overflow-wrap: break-word; /* Add this */
    min-width: 0; /* Add this */
    max-width: 100%; /* Add this */
}

.card-title, .card-description {
    word-wrap: break-word; /* Add this */
    overflow-wrap: break-word; /* Add this */
    hyphens: auto; /* Add this */
    min-width: 0; /* Add this */
}
/* Column policies visibility */


/* Vertical buffer layout */
.buffer-pair-vertical {
    display: flex;
    flex-direction: column;
    margin: 0.5rem 0;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    overflow: hidden;
    min-width: 0; /* Add this */
}


.buffer-pair-vertical.column {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-color: #ffc107;
}

.buffer-pair-vertical.subColumn {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    border-color: #17a2b8;
    margin-left: 1rem;
}

.buffer-separator-horizontal {
    height: 2px;
    background: repeating-linear-gradient(
        to right,
        #333 0px,
        #333 8px,
        transparent 8px,
        transparent 16px
    );
    margin: 0 8px;
}

/* Fix card display issues */
.card {
    word-wrap: break-word;
    overflow-wrap: break-word;
    min-height: auto;
    max-width: 100%;
}

.card-title, .card-description {
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
}



.backlog-item.boarded-item {
    border-left: 4px solid #17a2b8;
    background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
}

.location-badge {
    background: #17a2b8 !important;
    color: white !important;
}



</style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="logo">Kanban System</div>
        <div class="nav-links">
            <a href="#" class="nav-link active" data-page="home">Home</a>
            <a href="#" class="nav-link" data-page="business">Business</a>
            <a href="#" class="nav-link" data-page="backlog">Backlog</a>
            <a href="#" class="nav-link" data-page="board">Board</a>
            <a href="#" class="nav-link" data-page="team">Team</a>
            <a href="#" class="nav-link" data-page="admin">Admin</a>
            <a href="#" class="nav-link" data-page="metrics">Metrics</a>
            <a href="#" class="nav-link" data-page="reviews">Reviews</a>
            <div class="avatar-selector">
                <div class="avatar" id="currentAvatar">A</div>
                <div class="avatar-dropdown" id="avatarDropdown"></div>
            </div>
            <a href="#" class="nav-link" data-page="help">Help</a>
        </div>
    </nav>

    <div class="main-content">
        <!-- Home Page -->
        <div id="home" class="page active">
            <div class="board-container">
                <h1>Welcome to Kanban System</h1>
                <p>Select a page from the navigation to get started. Use the avatar selector to switch between team members and experience different roles in the system.</p>
                <div style="margin-top: 2rem;">
                    <h3>Quick Start Guide:</h3>
                    <ul style="margin-left: 2rem; margin-top: 1rem;">
                        <li><strong>Business:</strong> Manage your business information, vsm, processes and workflows</li>
                        <li><strong>Backlog:</strong> Manage your product backlog items with priority and size estimates</li>
                        <li><strong>Board:</strong> Visualize and manage work flow</li>
                        <li><strong>Team:</strong> View and manage team members</li>
                        <li><strong>Admin:</strong> Configure board settings and permissions</li>
                        <li><strong>Metrics:</strong> View flow efficiency and performance charts</li>
                        <li><strong>Reviews:</strong> Conduct service reviews, operations reviews, and manage experiments</li>
                        <li><strong>Help:</strong> Learn about Kanban principles and practices</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Backlog Page -->
        <div id="backlog" class="page">
            <div class="board-container">
                <div class="board-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="text" id="backlogTitle" class="board-title-input" 
                            style="border: none; background: transparent; font-size: 2rem; color: #333; font-weight: normal; min-width: 300px;"
                            value="Product Backlog" onblur="saveBacklogTitle()" onkeydown="handleBacklogTitleKeydown(event)">
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div class="checkbox-group" style="display: flex; align-items: center; gap: 0.3rem;">
                            <input type="checkbox" id="showBoardedItems" onchange="toggleBoardedItems()">
                            <label for="showBoardedItems" style="font-size: 0.9rem; color: #666; margin: 0;">Show Boarded Items</label>
                        </div>
                        <button class="btn btn-primary" onclick="showAddItemModal()">Add Item</button>
                    </div>
                </div>
                <div id="backlogItems"></div>
            </div>
        </div>

        <!-- Board Page -->
        <div id="board" class="page">
            <div class="board-container">
                <div class="board-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="text" id="boardTitle" class="board-title-input" 
                               style="border: none; background: transparent; font-size: 2rem; color: #333; font-weight: normal; min-width: 300px;"
                               value="Kanban Board" onblur="saveBoardTitle()" onkeydown="handleBoardTitleKeydown(event)">
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <!-- Board Controls -->
                        <div style="display: flex; gap: 1rem; align-items: center; background: rgba(255,255,255,0.1); padding: 0.5rem 1rem; border-radius: 25px;">
                            <div class="checkbox-group" style="display: flex; align-items: center; gap: 0.3rem;">
                                <input type="checkbox" id="showSubColumns" checked onchange="toggleSubColumns()">
                                <label for="showSubColumns" style="font-size: 0.9rem; color: #666; margin: 0;">Sub-columns</label>
                            </div>
                            <div class="checkbox-group" style="display: flex; align-items: center; gap: 0.3rem;">
                                <input type="checkbox" id="showBufferColumns" checked onchange="toggleBufferColumns()">
                                <label for="showBufferColumns" style="font-size: 0.9rem; color: #666; margin: 0;">Buffers</label>
                            </div>
                            <div class="checkbox-group" style="display: flex; align-items: center; gap: 0.3rem;">
                                <input type="checkbox" id="showSwimlanes" onchange="toggleSwimlanes()">
                                <label for="showSwimlanes" style="font-size: 0.9rem; color: #666; margin: 0;">Swimlanes</label>
                            </div>
                            <div class="checkbox-group" style="display: flex; align-items: center; gap: 0.3rem;">
                                <input type="checkbox" id="showClassesOfService" onchange="toggleClassesOfService()">
                                <label for="showClassesOfService" style="font-size: 0.9rem; color: #666; margin: 0;">Classes of Service</label>
                            </div>
                            <div class="checkbox-group" style="display: flex; align-items: center; gap: 0.3rem;">
                                <input type="checkbox" id="showPolicies" checked onchange="togglePolicies()">
                                <label for="showPolicies" style="font-size: 0.9rem; color: #666; margin: 0;">Policies</label>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="showAddCardModal()">Add Card</button>
                    </div>
                </div>
                
                <div class="kanban-board" id="kanbanBoard"></div>
                
                <!-- Policies Section -->
                <div class="policies-section" id="policiesSection">
                    <div class="policies-header-common">
                        <h3>Common Board Policies</h3>
                        <button class="policy-edit-btn" onclick="editCommonPolicies()" title="Edit common board policies">✏️</button>
                    </div>
                    <div id="policiesDisplay">
                        <div class="common-policies-content">
                            <div class="policy-bullet">Definition of Ready: All requirements understood, acceptance criteria defined, dependencies identified</div>
                            <div class="policy-bullet">Definition of Done: Code complete, tested, reviewed, documented, deployed to staging</div>
                            <div class="policy-bullet">WIP Limits: To Do: 5 items, In Progress: 3 items - No exceptions without team discussion</div>
                            <div class="policy-bullet">Blocked Items: Mark items as blocked immediately, discuss in daily standup, resolve within 2 days</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Page -->
        <div id="team" class="page">
            <div class="team-container">
                <div class="board-header">
                    <h1 class="board-title">Team Members</h1>
                    <button class="btn btn-primary" onclick="showAddMemberModal()">Add Member</button>
                </div>
                <div class="team-grid" id="teamGrid"></div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="admin" class="page">
            <div class="board-container">
                <h1>Admin Panel</h1>
                <div style="margin-top: 2rem;">
                    <h3>Board Configuration</h3>
                    <button class="btn btn-primary" onclick="showBoardConfigModal()" style="margin-top: 1rem;">Configure Board</button>
                    
                    <h3 style="margin-top: 2rem;">Data Management</h3>
                    <button class="btn btn-warning" onclick="exportData()" style="margin-top: 1rem; margin-right: 1rem;">Export Data</button>
                    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                </div>
            </div>
        </div>

        <!-- Metrics Page -->
        <div id="metrics" class="page">
            <div class="metrics-container">
                <h1 class="board-title">Metrics & Analytics</h1>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-title">Flow Efficiency</div>
                        <div class="metric-value" id="flowEfficiencyValue">75%</div>
                        <div>Percentage of time work is actively progressing</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">Average Cycle Time</div>
                        <div class="metric-value" id="cycleTimeValue">8.5 days</div>
                        <div>Average time from start to completion</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">Throughput</div>
                        <div class="metric-value" id="throughputValue">12 items</div>
                        <div>Items completed this week</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="cumulativeFlowChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Reviews Page -->
        <div id="reviews" class="page">
            <div class="board-container">
                <h1 class="board-title">Reviews & Experiments</h1>
                
               <div class="review-tab-nav">
                    <button class="review-tab-btn active" id="serviceReviewTab" onclick="showReviewTab('service')">Service Review</button>
                    <button class="review-tab-btn" id="operationsReviewTab" onclick="showReviewTab('operations')">Operations Review</button>
                    <button class="review-tab-btn" id="experimentsTab" onclick="showReviewTab('experiments')">Experiments</button>
                </div>

                <div id="serviceReview" class="review-tab active">
                    <div class="review-content">
                        <div class="review-header">
                            <div>
                                <h2>Service Review</h2>
                                <p>Focus on what we're delivering to customers - value delivery, customer satisfaction, and service quality.</p>
                            </div>
                            <button class="btn btn-primary" onclick="showAddServiceReviewModal()">Add Service Review</button>
                        </div>
                        
                        <div class="sort-controls">
                            <label>Sort by date:</label>
                            <button class="sort-btn active" id="serviceSort" onclick="toggleServiceSort()">Newest First</button>
                            <button class="btn btn-warning" onclick="toggleServiceTrash()">View Trash</button>
                        </div>
                        
                        <div id="serviceReviewsList" class="review-list"></div>
                        
                        <div id="serviceTrashSection" class="trash-section" style="display: none;">
                            <h3>Deleted Service Reviews</h3>
                            <div id="serviceTrashList" class="review-list"></div>
                        </div>
                    </div>
                </div>

                <div id="operationsReview" class="review-tab">
                    <div class="review-content">
                        <div class="review-header">
                            <div>
                                <h2>Operations Review</h2>
                                <p>Focus on how we're working - processes, flow, and team effectiveness.</p>
                            </div>
                            <button class="btn btn-primary" onclick="showAddOperationsReviewModal()">Add Operations Review</button>
                        </div>
                        
                        <div class="sort-controls">
                            <label>Sort by date:</label>
                            <button class="sort-btn active" id="operationsSort" onclick="toggleOperationsSort()">Newest First</button>
                            <button class="btn btn-warning" onclick="toggleOperationsTrash()">View Trash</button>
                        </div>
                        
                        <div id="operationsReviewsList" class="review-list"></div>
                        
                        <div id="operationsTrashSection" class="trash-section" style="display: none;">
                            <h3>Deleted Operations Reviews</h3>
                            <div id="operationsTrashList" class="review-list"></div>
                        </div>
                    </div>
                </div>

                <div id="experiments" class="review-tab">
                    <div class="review-content">
                        <div class="review-header">
                            <div>
                                <h2>Experiments</h2>
                                <p>Manage and prioritize your improvement experiments</p>
                            </div>
                            <button class="btn btn-primary" onclick="showAddExperimentModal()">Add Experiment</button>
                        </div>
                        
                        
                        <!-- Tab navigation for Prioritize and Board views (swapped order) -->
                        <div class="experiment-tab-nav">
                            <button class="experiment-view-btn active" id="prioritizeViewBtn" onclick="showExperimentView('prioritize')">Prioritize View</button>
                            <button class="experiment-view-btn" id="boardViewBtn" onclick="showExperimentView('board')">Board View</button>
                        </div>

                        <!-- Prioritize View (Quadrant Matrix) - Now first and active -->
                        <div id="experimentPrioritizeView" class="experiment-view active">
                            <div class="prioritize-matrix">
                                <div class="matrix-labels">
                                    <div class="y-axis-label">Impact</div>
                                    <div class="matrix-container">
                                        <div class="x-axis-labels">
                                            <div class="x-label-left">Hard to Implement</div>
                                            <div class="x-label-right">Easy to Implement</div>
                                        </div>
                                        <div class="matrix-grid">
                                            <!-- TOP ROW - HIGH IMPACT -->
                                            <div class="quadrant high-impact-hard" id="high-impact-hard">
                                                <div class="quadrant-title">High Impact<br>Hard to Implement</div>
                                                <div class="quadrant-content"></div>
                                            </div>
                                            <div class="quadrant high-impact-easy" id="high-impact-easy">
                                                <div class="quadrant-title">High Impact<br>Easy to Implement</div>
                                                <div class="quadrant-content"></div>
                                            </div>
                                            <!-- BOTTOM ROW - LOW IMPACT -->
                                            <div class="quadrant low-impact-hard" id="low-impact-hard">
                                                <div class="quadrant-title">Low Impact<br>Hard to Implement</div>
                                                <div class="quadrant-content"></div>
                                            </div>
                                            <div class="quadrant low-impact-easy" id="low-impact-easy">
                                                <div class="quadrant-title">Low Impact<br>Easy to Implement</div>
                                                <div class="quadrant-content"></div>
                                            </div>
                                        </div>
                                        <div class="axis-labels">
                                            <div class="y-high">High</div>
                                            <div class="y-low">Low</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Board View - Now second -->
                        <div id="experimentBoardView" class="experiment-view">
                            <div class="kanban-board" id="experimentBoard">
                                <div class="column">
                                    <div class="column-header">
                                        <span class="column-title">Ideas</span>
                                        <span class="wip-limit ok" id="ideasCount">0</span>
                                    </div>
                                    <div class="column-content" id="ideas-column"></div>
                                </div>
                                <div class="column">
                                    <div class="column-header">
                                        <span class="column-title">In Progress</span>
                                        <span class="wip-limit ok" id="inProgressCount">0</span>
                                    </div>
                                    <div class="column-content" id="in-progress-column"></div>
                                </div>
                                <div class="column">
                                    <div class="column-header">
                                        <span class="column-title">Done</span>
                                        <span class="wip-limit ok" id="doneCount">0</span>
                                    </div>
                                    <div class="column-content" id="done-column"></div>
                                </div>
                            </div>
                        </div>
                                                








                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Edit Service Review Modal -->
        <div id="editServiceReviewModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Service Review</h2>
                    <span class="close" onclick="closeModal('editServiceReviewModal')">&times;</span>
                </div>
                <form id="editServiceReviewForm">
                    <input type="hidden" id="editServiceReviewId">
                    <div class="form-group">
                        <label for="editServiceReviewTitle">Title:</label>
                        <input type="text" id="editServiceReviewTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editServiceReviewDate">Date:</label>
                        <input type="date" id="editServiceReviewDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editServiceReviewAttendees">Attendees:</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="editServiceReviewAttendees" class="form-control" placeholder="Selected attendees will appear here..." readonly>
                            <button type="button" class="btn btn-primary" onclick="openAttendeeModal('editServiceReview')">Select</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editServiceReviewContent">Review Content:</label>
                        <textarea id="editServiceReviewContent" class="form-control" rows="5" placeholder="What was discussed, key points, insights..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editServiceReviewOutcomes">Key Outcomes & Action Items:</label>
                        <textarea id="editServiceReviewOutcomes" class="form-control" rows="4" placeholder="Decisions made, action items, follow-ups..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Service Review</button>
                </form>
            </div>
        </div>

        <!-- Edit Operations Review Modal -->
        <div id="editOperationsReviewModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Operations Review</h2>
                    <span class="close" onclick="closeModal('editOperationsReviewModal')">&times;</span>
                </div>
                <form id="editOperationsReviewForm">
                    <input type="hidden" id="editOperationsReviewId">
                    <div class="form-group">
                        <label for="editOperationsReviewTitle">Title:</label>
                        <input type="text" id="editOperationsReviewTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editOperationsReviewDate">Date:</label>
                        <input type="date" id="editOperationsReviewDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editOperationsReviewAttendees">Attendees:</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="editOperationsReviewAttendees" class="form-control" placeholder="Selected attendees will appear here..." readonly>
                            <button type="button" class="btn btn-primary" onclick="openAttendeeModal('editOperationsReview')">Select</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editOperationsReviewContent">Review Content:</label>
                        <textarea id="editOperationsReviewContent" class="form-control" rows="5" placeholder="Process improvements, team feedback, workflow analysis..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editOperationsReviewOutcomes">Key Outcomes & Action Items:</label>
                        <textarea id="editOperationsReviewOutcomes" class="form-control" rows="4" placeholder="Process changes, action items, improvements to implement..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Operations Review</button>
                </form>
            </div>
        </div>



        <!-- Add Experiment Modal -->
        <div id="addExperimentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add Experiment</h2>
                    <span class="close" onclick="closeModal('addExperimentModal')">&times;</span>
                </div>
                <form id="addExperimentForm">
                    <div class="form-group">
                        <label for="experimentTitle">Title:</label>
                        <input type="text" id="experimentTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="experimentDescription">Description:</label>
                        <textarea id="experimentDescription" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="experimentImpact">Expected Impact:</label>
                        <select id="experimentImpact" class="form-control" required>
                            <option value="">Select Impact</option>
                            <option value="high">High Impact</option>
                            <option value="low">Low Impact</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="experimentImplementation">Implementation Difficulty:</label>
                        <select id="experimentImplementation" class="form-control" required>
                            <option value="">Select Difficulty</option>
                            <option value="easy">Easy to Implement</option>
                            <option value="hard">Hard to Implement</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="experimentStatus">Status:</label>
                        <select id="experimentStatus" class="form-control">
                            <option value="Ideas" selected>Ideas</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Done">Done</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="experimentOwner">Owner:</label>
                        <select id="experimentOwner" class="form-control"></select>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Experiment</button>
                </form>
            </div>
        </div>
        <!-- Edit Experiment Modal -->
        <!-- Edit Experiment Modal -->
        <div id="editExperimentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Experiment</h2>
                    <span class="close" onclick="closeModal('editExperimentModal')">&times;</span>
                </div>
                <form id="editExperimentForm">
                    <input type="hidden" id="editExperimentId">
                    <div class="form-group">
                        <label for="editExperimentTitle">Title:</label>
                        <input type="text" id="editExperimentTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editExperimentDescription">Description:</label>
                        <textarea id="editExperimentDescription" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editExperimentImpact">Expected Impact:</label>
                        <select id="editExperimentImpact" class="form-control" required>
                            <option value="">Select Impact</option>
                            <option value="high">High Impact</option>
                            <option value="low">Low Impact</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editExperimentImplementation">Implementation Difficulty:</label>
                        <select id="editExperimentImplementation" class="form-control" required>
                            <option value="">Select Difficulty</option>
                            <option value="easy">Easy to Implement</option>
                            <option value="hard">Hard to Implement</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editExperimentStatus">Status:</label>
                        <select id="editExperimentStatus" class="form-control">
                            <option value="Ideas">Ideas</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Done">Done</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editExperimentOwner">Owner:</label>
                        <select id="editExperimentOwner" class="form-control"></select>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Experiment</button>
                </form>
            </div>
        </div>

        <!-- Delete Experiment Confirmation Modal -->
        <div id="deleteExperimentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Confirm Delete Experiment</h2>
                    <span class="close" onclick="closeModal('deleteExperimentModal')">&times;</span>
                </div>
                <div style="margin-bottom: 2rem;">
                    <p>Are you sure you want to delete this experiment?</p>
                    <div id="experimentToDelete" style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 1rem 0;">
                        <!-- Experiment details will be populated here -->
                    </div>
                    <p style="color: #dc3545; font-size: 0.9rem; font-weight: bold;">This action cannot be undone.</p>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeModal('deleteExperimentModal')">Cancel</button>
                    <button class="btn btn-danger" id="confirmDeleteExperimentBtn">Delete Experiment</button>
                </div>
            </div>
        </div>


       

        <!-- Business Page -->
        <div id="business" class="page">
            <div class="board-container">
                <div class="board-header">
                    <h1 class="board-title">Business Overview</h1>
                </div>
                
                <!-- Main Tab Navigation -->
                <div class="business-main-tab-nav">
                    <button class="business-main-tab-btn active" id="businessInfoTab" onclick="showBusinessMainTab('businessInfo')">Business Information</button>
                    <button class="business-main-tab-btn" id="vsmTab" onclick="showBusinessMainTab('vsm')">VSM</button>
                </div>

                <!-- Business Information Tab Content -->
                <div id="businessInfoContent" class="business-main-tab-content active">
                    <div class="business-document">
                        <!-- Company Name -->
                        <div class="business-doc-section" data-section="name">
                            <h2 class="business-doc-title">Company/Product Name</h2>
                            <div class="business-doc-content" id="businessNameDisplay" onclick="editBusinessSection('name')">
                                <div class="edit-overlay">Click to edit</div>
                            </div>
                        </div>

                        <!-- Vision Statement -->
                        <div class="business-doc-section" data-section="vision">
                            <h2 class="business-doc-title">Vision Statement</h2>
                            <div class="business-doc-content" id="businessVisionDisplay" onclick="editBusinessSection('vision')">
                                <div class="edit-overlay">Click to edit</div>
                            </div>
                        </div>

                        <!-- Mission Statement -->
                        <div class="business-doc-section" data-section="mission">
                            <h2 class="business-doc-title">Mission Statement</h2>
                            <div class="business-doc-content" id="businessMissionDisplay" onclick="editBusinessSection('mission')">
                                <div class="edit-overlay">Click to edit</div>
                            </div>
                        </div>

                        <!-- Value Statement -->
                        <div class="business-doc-section" data-section="values">
                            <h2 class="business-doc-title">Value Statement</h2>
                            <div class="business-doc-content" id="businessValuesDisplay" onclick="editBusinessSection('values')">
                                <div class="edit-overlay">Click to edit</div>
                            </div>
                        </div>

                        <!-- Strategy -->
                        <div class="business-doc-section" data-section="strategy">
                            <h2 class="business-doc-title">Business Strategy</h2>
                            <div class="business-doc-content" id="businessStrategyDisplay" onclick="editBusinessSection('strategy')">
                                <div class="edit-overlay">Click to edit</div>
                            </div>
                        </div>

                        <!-- Structure -->
                        <div class="business-doc-section" data-section="structure">
                            <h2 class="business-doc-title">Organizational Structure</h2>
                            <div class="business-doc-content" id="businessStructureDisplay" onclick="editBusinessSection('structure')">
                                <div class="edit-overlay">Click to edit</div>
                            </div>
                        </div>

                        <!-- Goals -->
                        <div class="business-doc-section" data-section="goals">
                            <h2 class="business-doc-title">Strategic Goals</h2>
                            <div class="business-doc-content" id="businessGoalsDisplay" onclick="editBusinessSection('goals')">
                                <div class="edit-overlay">Click to edit</div>
                            </div>
                        </div>

                        <!-- Outcomes -->
                        <div class="business-doc-section" data-section="outcomes">
                            <h2 class="business-doc-title">Expected Outcomes</h2>
                            <div class="business-doc-content" id="businessOutcomesDisplay" onclick="editBusinessSection('outcomes')">
                                <div class="edit-overlay">Click to edit</div>
                            </div>
                        </div>

                        <!-- Milestones -->
                        <div class="business-doc-section" data-section="milestones">
                            <h2 class="business-doc-title">Key Milestones</h2>
                            <div class="business-doc-content" id="businessMilestonesDisplay" onclick="editBusinessSection('milestones')">
                                <div class="edit-overlay">Click to edit</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VSM Tab Content -->
                    <div id="vsmContent" class="business-main-tab-content">
                        <div class="vsm-container">
                            <div class="vsm-header">
                                <h2>Value Stream Mapping</h2>
                                <p>Design, analyze and optimize your value stream process.</p>
                            </div>

                            <!-- VSM Sub-tab Navigation -->
                            <div class="vsm-sub-tab-nav">
                                <button class="vsm-sub-tab-btn active" id="vsmStepsTab" onclick="showVSMSubTab('steps')">Process Steps</button>
                                <button class="vsm-sub-tab-btn" id="vsmViewTab" onclick="showVSMSubTab('view')">Value Stream View</button>
                                <button class="vsm-sub-tab-btn" id="vsmHelpTab" onclick="showVSMSubTab('help')">Help</button>
                            </div>

                            <!-- Process Steps Sub-tab -->
                            <div id="vsmStepsContent" class="vsm-sub-tab-content active">
                                <div class="steps-header">
                                    <h3>Process Steps Management</h3>
                                    <button class="btn btn-primary" onclick="showAddStepModal()">Add Step</button>
                                </div>
                                <div class="steps-container">
                                    <div id="vsmStepsList" class="steps-list"></div>
                                </div>
                            </div>

                            <!-- Value Stream View Sub-tab -->
                            <div id="vsmViewContent" class="vsm-sub-tab-content">
                                <div class="vsm-view-container">
                                    <div class="vsm-metrics-card">
                                        <h3>VSM Report Card</h3>
                                        <div class="metrics-grid">
                                            <div class="metric-item">
                                                <span class="metric-label">Total Steps:</span>
                                                <span class="metric-value" id="totalSteps">0</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Total Value Added Time:</span>
                                                <span class="metric-value" id="totalValueTime">0 min</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Total Delay Time:</span>
                                                <span class="metric-value" id="totalDelayTime">0 min</span>
                                            </div>
                                            <div class="metric-item">
                                                <span class="metric-label">Total Process Time:</span>
                                                <span class="metric-value" id="totalProcessTime">0 min</span>
                                            </div>
                                            <div class="metric-item highlight">
                                                <span class="metric-label">Process Efficiency:</span>
                                                <span class="metric-value" id="processEfficiency">0.00%</span>
                                            </div>
                                            <div class="metric-item highlight">
                                                <span class="metric-label">Average Accuracy:</span>
                                                <span class="metric-value" id="averageAccuracy">0.00%</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="value-stream-flow">
                                        <div class="flow-legend">
                                            <div class="legend-item"><span class="value-indicator"></span> Value Added</div>
                                            <div class="legend-item"><span class="delay-indicator"></span> Delay/Waste</div>
                                            <div class="legend-item"><span class="trigger-indicator"></span> Start/Trigger</div>
                                            <div class="legend-item"><span class="outcome-indicator"></span> Value/Outcome</div>
                                        </div>
                                        <div id="valueStreamFlow" class="flow-container"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>




                </div>
            </div>
        </div>


        <!-- VSM Step Modal -->
        <div id="vsmStepModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="vsmStepModalTitle">Add Process Step</h2>
                    <span class="close" onclick="closeModal('vsmStepModal')">&times;</span>
                </div>
                <form id="vsmStepForm">
                    <input type="hidden" id="vsmStepId">
                    <div class="form-group">
                        <label for="stepName">Step Name:</label>
                        <input type="text" id="stepName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="stepDescription">Description:</label>
                        <textarea id="stepDescription" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="stepType">Step Type:</label>
                        <select id="stepType" class="form-control" required>
                            <option value="">Select Type</option>
                            <option value="trigger">Start/Trigger</option>
                            <option value="process">Process Step</option>
                            <option value="value">Value/Outcome</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="valueAddedTime">Value Added Time (minutes):</label>
                        <input type="number" id="valueAddedTime" class="form-control" min="0" step="0.1" value="0">
                    </div>
                    <div class="form-group">
                        <label for="delayTime">Delay Time (minutes):</label>
                        <input type="number" id="delayTime" class="form-control" min="0" step="0.1" value="0">
                    </div>
                    <div class="form-group">
                        <label for="accuracyPercent">Accuracy (%):</label>
                        <input type="number" id="accuracyPercent" class="form-control" min="0" max="100" step="0.1" value="100">
                    </div>
                    <button type="submit" class="btn btn-primary" id="vsmStepSubmitBtn">Add Step</button>
                </form>
            </div>
        </div>



        <!-- VSM Help Sub-tab -->
        <div id="vsmHelpContent" class="vsm-sub-tab-content">
            <div class="vsm-help-content">
                <div class="help-intro">
                    <h2>Value Stream Mapping Guide</h2>
                    <p>Learn how to use Value Stream Mapping to identify waste, improve flow efficiency, and optimize your processes.</p>
                </div>

                <div class="help-section">
                    <h3>What is Value Stream Mapping?</h3>
                    <p>Value Stream Mapping (VSM) is a lean manufacturing technique used to analyze and design the flow of materials and information required to bring a product or service to a customer. It helps visualize the current state of a process and design a future state with improved flow and reduced waste.</p>
                </div>

                <div class="help-section">
                    <h3>Key Components</h3>
                    <ul>
                        <li><strong>Process Steps:</strong> Individual activities in your workflow</li>
                        <li><strong>Value-Added Time:</strong> Time spent on activities that directly add value for the customer</li>
                        <li><strong>Delay Time:</strong> Non-value-added time (waiting, handoffs, rework)</li>
                        <li><strong>Process Efficiency:</strong> (Value-Added Time ÷ Total Time) × 100</li>
                        <li><strong>Accuracy Rate:</strong> Quality measure for each process step</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>Step Types</h3>
                    <div class="help-example">
                        <p><span style="color: #6f42c1;">🔵 <strong>Start/Trigger:</strong></span> The initial event that begins the process (customer request, scheduled event, etc.)</p>
                        <p><span style="color: #007bff;">🔵 <strong>Process Step:</strong></span> Core activities that transform inputs into outputs</p>
                        <p><span style="color: #28a745;">🟢 <strong>Value/Outcome:</strong></span> The final deliverable that provides value to the customer</p>
                    </div>
                </div>

                <div class="help-section">
                    <h3>How to Use This Tool</h3>
                    <p><strong>1. Process Steps Tab:</strong></p>
                    <ul>
                        <li>Add each step in your process with accurate time measurements</li>
                        <li>Classify steps as Start/Trigger, Process, or Value/Outcome</li>
                        <li>Record value-added time (actual work time)</li>
                        <li>Record delay time (waiting, handoffs, interruptions)</li>
                        <li>Set accuracy percentage for quality tracking</li>
                        <li>Drag and drop to reorder steps in the correct sequence</li>
                    </ul>
                    
                    <p><strong>2. Value Stream View Tab:</strong></p>
                    <ul>
                        <li>View your complete process flow visually</li>
                        <li>Analyze the VSM Report Card for key metrics</li>
                        <li>Identify bottlenecks and improvement opportunities</li>
                        <li>Track process efficiency over time</li>
                    </ul>
                </div>

                <div class="help-benefits">
                    <h3>Benefits of Value Stream Mapping</h3>
                    <ul>
                        <li><strong>Waste Identification:</strong> Clearly see where time is lost in delays and non-value activities</li>
                        <li><strong>Flow Visualization:</strong> Understand the complete process from start to finish</li>
                        <li><strong>Data-Driven Decisions:</strong> Make improvements based on actual time measurements</li>
                        <li><strong>Process Standardization:</strong> Document and standardize your best practices</li>
                        <li><strong>Continuous Improvement:</strong> Track metrics to measure improvement over time</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>Improving Flow Efficiency</h3>
                    <div class="help-tip">
                        <p><strong>💡 Tip:</strong> Focus on reducing delay time and increasing value-added time to improve your process efficiency percentage.</p>
                    </div>
                    <ul>
                        <li><strong>Eliminate Waste:</strong> Remove unnecessary steps, reduce waiting time, minimize handoffs</li>
                        <li><strong>Parallel Processing:</strong> Identify steps that can be done simultaneously</li>
                        <li><strong>Automation:</strong> Automate repetitive, low-value tasks</li>
                        <li><strong>Standardize:</strong> Create consistent procedures to reduce variation</li>
                        <li><strong>Continuous Flow:</strong> Minimize batch processing and work-in-progress queues</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>Connecting to Kanban Board Design</h3>
                    <div class="help-example">
                        <p>Use your VSM insights to optimize your Kanban board:</p>
                        <ul>
                            <li><strong>Column Design:</strong> Align board columns with your VSM process steps</li>
                            <li><strong>WIP Limits:</strong> Set work-in-progress limits based on capacity at each step</li>
                            <li><strong>Buffer Columns:</strong> Add buffers before bottleneck steps identified in VSM</li>
                            <li><strong>Policies:</strong> Define clear policies based on your process standards</li>
                            <li><strong>Metrics:</strong> Track cycle time and throughput improvements</li>
                        </ul>
                    </div>
                </div>

                <div class="help-section">
                    <h3>Example Metrics to Track</h3>
                    <ul>
                        <li><strong>Process Efficiency:</strong> Target 70%+ (industry varies)</li>
                        <li><strong>Cycle Time:</strong> Total time from start to finish</li>
                        <li><strong>Lead Time:</strong> Time from customer request to delivery</li>
                        <li><strong>First Pass Yield:</strong> Percentage of work completed without rework</li>
                        <li><strong>Queue Time:</strong> Time work waits between process steps</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="help" class="page">
            <div class="help-content">
                <h1>Kanban Help & Guide</h1>
                

                <div class="help-section">
                    <h2>What is Kanban?</h2>
                    <p>Kanban is a visual work management method that helps teams visualize their work, limit work in progress, and maximize efficiency. It uses a board with columns to represent different stages of the workflow, and cards to represent work items.</p>
                </div>

                <div class="help-section">
                    <h2>Quick Overview</h2>
                    <p>Kanban focuses on continuous delivery without overburdening the development team. Like Scrum, Kanban is a process designed to help teams work together more effectively.</p>
                    <h3>Key Benefits:</h3>
                    <ul>
                        <li>Visualize workflow and identify bottlenecks</li>
                        <li>Limit work in progress to improve focus</li>
                        <li>Increase collaboration and communication</li>
                        <li>Improve continuously based on data</li>
                        <li>Deliver value more predictably</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h2>Kanban Values</h2>
                    <ul class="values-list">
                        <li><strong>Transparency:</strong> Make work and policies visible to everyone</li>
                        <li><strong>Balance:</strong> Match demand with capability; avoid overloading</li>
                        <li><strong>Collaboration:</strong> Improve together as a team</li>
                        <li><strong>Customer Focus:</strong> Deliver value continuously to customers</li>
                        <li><strong>Flow:</strong> Focus on smooth movement of work items</li>
                        <li><strong>Respect:</strong> Trust people and acknowledge differences</li>
                        <li><strong>Leadership:</strong> Everyone demonstrates leadership at all levels</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h2>Kanban Principles</h2>
                    <h3>Change Management Principles:</h3>
                    <ul class="principles-list">
                        <li><strong>Start with what you do now:</strong> No need to redesign your process upfront</li>
                        <li><strong>Agree to pursue evolutionary change:</strong> Improve step by step, not big-bang changes</li>
                        <li><strong>Respect current roles, responsibilities, and titles:</strong> Don't disrupt existing structure immediately</li>
                    </ul>
                    <h3>Service Delivery Principles:</h3>
                    <ul class="principles-list">
                        <li><strong>Focus on customer needs and expectations:</strong> Align work with value delivery</li>
                        <li><strong>Manage work, not people:</strong> Control flow instead of micromanaging individuals</li>
                        <li><strong>Improve collaboratively, evolve experimentally:</strong> Use data and feedback loops</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h2>Kanban Practices</h2>
                    <ul class="practices-list">
                        <li><strong>Visualize the work:</strong> Use boards/cards to show work stages</li>
                        <li><strong>Limit Work in Progress (WIP):</strong> Set WIP limits to prevent multitasking and bottlenecks</li>
                        <li><strong>Manage flow:</strong> Track work movement and resolve slowdowns</li>
                        <li><strong>Make policies explicit:</strong> Define rules (e.g., "Definition of Done") clearly</li>
                        <li><strong>Implement feedback loops:</strong> Use daily standups, service reviews, retrospectives</li>
                        <li><strong>Improve collaboratively, evolve experimentally:</strong> Continuous improvement through small experiments</li>
                    </ul>
                </div>

                
                <div class="help-section">
                    <h2>Classes of Service (CoS)</h2>
                    <p>Kanban Classes of Service (CoS) <strong>categorize work items by their priority, urgency, and expected delivery</strong>, allowing teams to prioritize work effectively and manage risk. Common classes include Expedite for critical, immediate tasks; Fixed Date for tasks with specific deadlines; Standard for regular work following a First-In, First-Out (FIFO) principle; and Intangible for tasks with long-term benefits but low urgency. By establishing distinct policies for each CoS, teams ensure that work is handled according to its specific requirements, balancing priorities and maintaining workflow efficiency.</p>
                    
                    <h3>Common Classes of Service</h3>
                    <ul class="principles-list">
                        <li><strong>Expedite:</strong> Reserved for high-impact, urgent tasks that require immediate attention. These items preempt other work and must be processed quickly, often disrupting the standard workflow.</li>
                        <li><strong>Fixed Date:</strong> For tasks with a specific deadline or due date that cannot be missed. Delaying these items can result in significant negative consequences, such as missed opportunities or penalties.</li>
                        <li><strong>Standard:</strong> Represents normal, regular work that does not have a fixed deadline. These tasks are important but can be handled within the team's standard workflow, typically following a First-In, First-Out (FIFO) principle.</li>
                        <li><strong>Intangible:</strong> Tasks that may have long-term benefits or potential but have low urgency and immediate impact. They are low-priority items like maintenance or quality improvements that can be deferred without immediate visible effects.</li>
                    </ul>
                    
                    <h3>Benefits of Using Classes of Service</h3>
                    <ul>
                        <li><strong>Prioritization:</strong> Teams can easily distinguish and prioritize work based on its importance and urgency.</li>
                        <li><strong>Efficiency:</strong> By defining different policies for each CoS, teams can manage their workload better, avoid bottlenecks, and ensure that critical tasks receive timely attention.</li>
                        <li><strong>Risk Management:</strong> CoS helps teams address potential risks associated with delaying certain types of work, aligning tasks with business goals and customer needs.</li>
                        <li><strong>Improved Flow:</strong> CoS helps prevent work from aging out of the system by providing a framework for managing urgent items without completely derailing the normal workflow.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Card Modal -->
    <div id="addCardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Card</h2>
                <span class="close" onclick="closeModal('addCardModal')">&times;</span>
            </div>
            <form id="addCardForm">
                <div class="form-group">
                    <label for="cardTitle">Title:</label>
                    <input type="text" id="cardTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="cardDescription">Description:</label>
                    <textarea id="cardDescription" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="cardAssignee">Owned By:</label>
                    <select id="cardAssignee" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label for="cardClassOfService">Class of Service:</label>
                    <select id="cardClassOfService" class="form-control">
                        <option value="Standard" selected>Standard</option>
                        <option value="Expedite">Expedite</option>
                        <option value="Fixed Date">Fixed Date</option>
                        <option value="Intangible">Intangible</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cardColumn">Column:</label>
                    <select id="cardColumn" class="form-control"></select>
                </div>
                <!-- Sub-column field will be dynamically inserted here -->
                <button type="submit" class="btn btn-primary">Add Card</button>
            </form>
        </div>
    </div>

    

    <!-- Add Item Modal -->
    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Backlog Item</h2>
                <span class="close" onclick="closeModal('addItemModal')">&times;</span>
            </div>
            <form id="addItemForm">
                <div class="form-group">
                    <label for="itemTitle">Title:</label>
                    <input type="text" id="itemTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="itemDescription">Description:</label>
                    <textarea id="itemDescription" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="itemProgress">Progress:</label>
                    <select id="itemProgress" class="form-control">
                        <option value="not-started">Not Started</option>
                        <option value="in-progress">In Progress</option>
                        <option value="blocked">Blocked</option>
                        <option value="completed">Completed</option>
                        <option value="on-hold">On Hold</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="itemPriority">Priority:</label>
                    <select id="itemPriority" class="form-control">
                        <option value="high">High</option>
                        <option value="medium" selected>Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="itemClassOfService">Class of Service:</label>
                    <select id="itemClassOfService" class="form-control">
                        <option value="Standard" selected>Standard</option>
                        <option value="Expedite">Expedite</option>
                        <option value="Fixed Date">Fixed Date</option>
                        <option value="Intangible">Intangible</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="itemSize">Size:</label>
                    <select id="itemSize" class="form-control">
                        <option value="xs">XS (Extra Small)</option>
                        <option value="s">S (Small)</option>
                        <option value="m" selected>M (Medium)</option>
                        <option value="l">L (Large)</option>
                        <option value="xl">XL (Extra Large)</option>
                        <option value="xxl">XXL (2X Large)</option>
                        <option value="xxxl">XXXL (3X Large)</option>
                        <option value="xxxxl">XXXXL (4X Large)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Add Item</button>
            </form>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Team Member</h2>
                <span class="close" onclick="closeModal('addMemberModal')">&times;</span>
            </div>
            <form id="addMemberForm">
                <div class="form-group">
                    <label for="memberName">Name:</label>
                    <input type="text" id="memberName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="memberRole">Role:</label>
                    <select id="memberRole" class="form-control">
                        <option value="developer">Developer</option>
                        <option value="tester">Tester</option>
                        <option value="designer">Designer</option>
                        <option value="product-owner">Product Owner</option>
                        <option value="project-manager">Project Manager</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Add Member</button>
            </form>
        </div>
    </div>

    <!-- Board Config Modal -->
    <div id="boardConfigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Configure Board</h2>
                <span class="close" onclick="closeModal('boardConfigModal')">&times;</span>
            </div>
            <form id="boardConfigForm">
                <div class="form-group">
                    <label>Board Columns (JSON format):</label>
                    <textarea id="boardColumns" class="form-control" rows="10"></textarea>
                    <small>Example: [{"name": "To Do", "wipLimit": 5, "subColumns": ["Ready", "Buffer"]}]</small>
                </div>
                <button type="submit" class="btn btn-primary">Save Configuration</button>
            </form>
        </div>
    </div>

    <!-- Column Policy Modal -->
    <div id="columnPolicyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="policyModalTitle">Edit Column Policies</h2>
                <span class="close" onclick="closeModal('columnPolicyModal')">&times;</span>
            </div>
            <form id="columnPolicyForm">
                <div class="form-group">
                    <label for="columnPolicies">Policies (one per line):</label>
                    <textarea id="columnPolicies" class="form-control" rows="6" 
                              placeholder="Enter each policy on a new line...
Example:
All work items must have clear acceptance criteria
Definition of Ready: Requirements understood
Code must be reviewed before moving to Done"></textarea>
                    <small style="color: #666; margin-top: 0.5rem; display: block;">Each line will be displayed as a bullet point</small>
                </div>
                <button type="submit" class="btn btn-primary">Save Policies</button>
            </form>
        </div>
    </div>

    <!-- Add Service Review Modal -->
    <div id="addServiceReviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Service Review</h2>
                <span class="close" onclick="closeModal('addServiceReviewModal')">&times;</span>
            </div>
            <form id="addServiceReviewForm">
                <div class="form-group">
                    <label for="serviceReviewTitle">Title:</label>
                    <input type="text" id="serviceReviewTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="serviceReviewDate">Date:</label>
                    <input type="date" id="serviceReviewDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="serviceReviewAttendees">Attendees:</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="serviceReviewAttendees" class="form-control" placeholder="Selected attendees will appear here..." readonly>
                        <button type="button" class="btn btn-primary" onclick="openAttendeeModal('serviceReview')">Select</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="serviceReviewContent">Review Content:</label>
                    <textarea id="serviceReviewContent" class="form-control" rows="5" placeholder="What was discussed, key points, insights..."></textarea>
                </div>
                <div class="form-group">
                    <label for="serviceReviewOutcomes">Key Outcomes & Action Items:</label>
                    <textarea id="serviceReviewOutcomes" class="form-control" rows="4" placeholder="Decisions made, action items, follow-ups..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Service Review</button>
            </form>
        </div>
    </div>

    <!-- Add Operations Review Modal -->
    <div id="addOperationsReviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Operations Review</h2>
                <span class="close" onclick="closeModal('addOperationsReviewModal')">&times;</span>
            </div>
            <form id="addOperationsReviewForm">
                <div class="form-group">
                    <label for="operationsReviewTitle">Title:</label>
                    <input type="text" id="operationsReviewTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="operationsReviewDate">Date:</label>
                    <input type="date" id="operationsReviewDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="operationsReviewAttendees">Attendees:</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="operationsReviewAttendees" class="form-control" placeholder="Selected attendees will appear here..." readonly>
                        <button type="button" class="btn btn-primary" onclick="openAttendeeModal('operationsReview')">Select</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="operationsReviewContent">Review Content:</label>
                    <textarea id="operationsReviewContent" class="form-control" rows="5" placeholder="Process improvements, team feedback, workflow analysis..."></textarea>
                </div>
                <div class="form-group">
                    <label for="operationsReviewOutcomes">Key Outcomes & Action Items:</label>
                    <textarea id="operationsReviewOutcomes" class="form-control" rows="4" placeholder="Process changes, action items, improvements to implement..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Operations Review</button>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Delete</h2>
                <span class="close" onclick="closeModal('deleteConfirmModal')">&times;</span>
            </div>
            <div style="margin-bottom: 2rem;">
                <p>Are you sure you want to delete this review?</p>
                <p style="color: #666; font-size: 0.9rem;">This will move the review to trash where it can be restored later.</p>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('deleteConfirmModal')">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
    <div id="commonPolicyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Common Board Policies</h2>
                <span class="close" onclick="closeModal('commonPolicyModal')">&times;</span>
            </div>
            <form id="commonPolicyForm">
                <div class="form-group">
                    <label for="commonPolicies">Common Board Policies (one per line):</label>
                    <textarea id="commonPolicies" class="form-control" rows="8" 
                              placeholder="Enter each policy on a new line...
Example:
Definition of Ready: All requirements understood
Definition of Done: Code complete and tested
WIP Limits: Respect agreed limits
Blocked Items: Escalate immediately"></textarea>
                    <small style="color: #666; margin-top: 0.5rem; display: block;">Each line will be displayed as a bullet point</small>
                </div>
                <button type="submit" class="btn btn-primary">Save Common Policies</button>
            </form>
        </div>
    </div>

    <!-- Attendee Selection Modal -->
    <div id="attendeeModal" class="attendee-modal">
        <div class="attendee-modal-content">
            <div class="modal-header">
                <h3>Select Attendees</h3>
                <span class="close" onclick="closeAttendeeModal()">&times;</span>
            </div>
            <div>
                <button type="button" class="select-all-btn" onclick="toggleSelectAll()">Select All</button>
                <div class="attendee-list" id="attendeeList"></div>
                <div class="additional-attendees">
                    <label for="additionalAttendees">Additional Attendees (one per line):</label>
                    <textarea id="additionalAttendees" placeholder="Enter additional attendees not in the team list..."></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAttendeeModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmAttendees()">Confirm Selection</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Business Edit Modal -->
    <div id="businessEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="businessModalTitle">Edit Business Section</h2>
                <span class="close" onclick="closeModal('businessEditModal')">&times;</span>
            </div>
            <form id="businessEditForm">
                <input type="hidden" id="businessSectionType">
                <div class="form-group">
                    <label id="businessFieldLabel" for="businessContent">Content:</label>
                    <textarea id="businessContent" class="form-control" rows="8" placeholder="Enter content... You can also use Mermaid.js syntax for diagrams."></textarea>
                    <small style="color: #666; margin-top: 0.5rem; display: block;">
                        💡 Tip: Use ```mermaid at the start of a line to create diagrams. 
                        <a href="https://mermaid-js.github.io/mermaid/" target="_blank">Learn Mermaid syntax</a>
                    </small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="supportMermaid" checked> Enable Mermaid diagrams
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">Save Content</button>
            </form>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <script>
        // Global state management
        let appState = {
            currentUser: 'admin',
            boardTitle: 'Kanban Board',
            showSubColumns: true,
            showBufferColumns: true,
            showSwimlanes: false,
            showClassesOfService: false,
            showPolicies: true,
            backlogTitle: 'Product Backlog',
            cards: [],
            businessInfo: {
                name: '',
                vision: '',
                mission: '',
                values: '',
                strategy: '',
                structure: '',
                goals: '',
                outcomes: '',
                milestones: ''
            },
            vsmSteps: [],
            backlogItems: [],
            teamMembers: [
                {id: 1, name: 'Admin User', role: 'admin', avatar: 'A', color: '#4CAF50'},
                {id: 2, name: 'John Developer', role: 'developer', avatar: 'J', color: '#2196F3'},
                {id: 3, name: 'Sarah Tester', role: 'tester', avatar: 'S', color: '#FF9800'},
                {id: 4, name: 'Mike Designer', role: 'designer', avatar: 'M', color: '#9C27B0'}
            ],
            boardConfig: [
                
                {
                    name: 'To Do', 
                    wipLimit: 5, 
                    subColumns: ['Ready', 'Analyzing'],
                    bufferColumns: ['Buffer']
                },
                {
                    name: 'In Progress', 
                    wipLimit: 3, 
                    subColumns: ['Development', 'Code Review', 'Testing'],
                    bufferColumns: ['Dev Buffer', 'Review Buffer'],
                    subColumnTypes: {
                        'Development': 'doing',
                        'Code Review': 'doing', 
                        'Testing': 'doing'
                    }
                },
                {
                    name: 'Done', 
                    wipLimit: null, 
                    subColumns: ['Deployed', 'Verified'],
                    bufferColumns: ['Done Buffer'],
                    subColumnTypes: {
                        'Deployed': 'done',
                        'Verified': 'done'
                    }
                }
            ],
            classesOfService: [
                { name: 'Expedite', color: '#dc3545', description: 'Critical, immediate tasks' },
                { name: 'Fixed Date', color: '#fd7e14', description: 'Tasks with specific deadlines' },
                { name: 'Standard', color: '#28a745', description: 'Regular work, FIFO principle' },
                { name: 'Intangible', color: '#6c757d', description: 'Long-term benefits, low urgency' }
            ],
            dailySnapshots: [],
            serviceReviews: [],
            operationsReviews: [],
            serviceReviewsTrash: [],
            operationsReviewsTrash: [],
            serviceSortDesc: true,
            operationsSortDesc: true
        };


        function updateBacklogTitle() {
            const titleInput = document.getElementById('backlogTitle');
            if (titleInput) {
                titleInput.value = appState.backlogTitle;
            }
        }

        function saveBacklogTitle() {
            const titleInput = document.getElementById('backlogTitle');
            if (titleInput) {
                appState.backlogTitle = titleInput.value || 'Product Backlog';
                saveData();
            }
        }

        function handleBacklogTitleKeydown(event) {
            if (event.key === 'Enter') {
                event.target.blur(); // This will trigger the onblur event
            }
        }


        // Helper function to get progress color
        function getProgressColor(progress) {
            const progressColors = {
                'not-started': '#6c757d',    // Gray
                'in-progress': '#007bff',    // Blue
                'blocked': '#dc3545',       // Red
                'completed': '#28a745',     // Green
                'on-hold': '#ffc107'        // Yellow
            };
            return progressColors[progress] || '#6c757d';
        }

        // Helper function to get size color
        function getSizeColor(size) {
            const sizeColors = {
                'xs': '#28a745',    // Green
                's': '#20c997',     // Teal
                'm': '#007bff',     // Blue
                'l': '#6610f2',     // Purple
                'xl': '#e83e8c',    // Pink
                'xxl': '#fd7e14',   // Orange
                'xxxl': '#dc3545',  // Red
                'xxxxl': '#6f42c1'  // Indigo
            };
            return sizeColors[size] || '#6c757d'; // Default gray
        }

        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('kanbanAppState');
            if (saved) {
                const savedState = JSON.parse(saved);
                appState = { ...appState, ...savedState };
                
                // Ensure defaults if not set
                if (appState.showSubColumns === undefined) appState.showSubColumns = true;
                if (appState.showBufferColumns === undefined) appState.showBufferColumns = true;
                if (appState.showSwimlanes === undefined) appState.showSwimlanes = false;
                if (appState.showClassesOfService === undefined) appState.showClassesOfService = false;
                if (appState.showPolicies === undefined) appState.showPolicies = true;
                if (appState.boardTitle === undefined) appState.boardTitle = 'Kanban Board';
                if (appState.backlogTitle === undefined) appState.backlogTitle = 'Product Backlog';
                if (appState.serviceSortDesc === undefined) appState.serviceSortDesc = true;
                if (appState.operationsSortDesc === undefined) appState.operationsSortDesc = true;
                if (!appState.classesOfService) {
                    appState.classesOfService = [
                        { name: 'Expedite', color: '#dc3545', description: 'Critical, immediate tasks' },
                        { name: 'Fixed Date', color: '#fd7e14', description: 'Tasks with specific deadlines' },
                        { name: 'Standard', color: '#28a745', description: 'Regular work, FIFO principle' },
                        { name: 'Intangible', color: '#6c757d', description: 'Long-term benefits, low urgency' }
                    ];
                }
                if (!appState.commonPolicies) {
                    appState.commonPolicies = [
                        'Definition of Ready: All requirements understood, acceptance criteria defined, dependencies identified',
                        'Definition of Done: Code complete, tested, reviewed, documented, deployed to staging',
                        'WIP Limits: To Do: 5 items, In Progress: 3 items - No exceptions without team discussion',
                        'Blocked Items: Mark items as blocked immediately, discuss in daily standup, resolve within 2 days'
                    ];
                }
                if (!appState.businessInfo) {
                    appState.businessInfo = {
                        name: '',
                        vision: '',
                        mission: '',
                        values: '',
                        strategy: '',
                        structure: '',
                        goals: '',
                        outcomes: '',
                        milestones: ''
                    };
                }
                if (!appState.vsmSteps) {
                    appState.vsmSteps = [];
                }
               
                // Add position to existing cards that don't have it
                if (appState.cards) {
                    appState.cards.forEach((card, index) => {
                        if (card.position === undefined) {
                            card.position = index + 1;
                        }
                    });
                    saveData();
                }

            } else {
                // Set defaults for new users
                appState.showSubColumns = true;
                appState.showBufferColumns = true;
                appState.showSwimlanes = false;
                appState.showClassesOfService = false;
                appState.showPolicies = true;
                appState.boardTitle = 'Kanban Board';
                appState.commonPolicies = [
                    'Definition of Ready: All requirements understood, acceptance criteria defined, dependencies identified',
                    'Definition of Done: Code complete, tested, reviewed, documented, deployed to staging',
                    'WIP Limits: To Do: 5 items, In Progress: 3 items - No exceptions without team discussion',
                    'Blocked Items: Mark items as blocked immediately, discuss in daily standup, resolve within 2 days'
                ];
            }
            
            // Generate sample data if none exists
            if (appState.cards.length === 0) {
                generateSampleData();
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('kanbanAppState', JSON.stringify(appState));
        }

        // Generate sample data
        function generateSampleData() {
            appState.cards = [
                {
                    id: 1,
                    title: 'User Authentication System',
                    description: 'Implement secure login and registration',
                    assignee: 'John Developer',
                    classOfService: 'Standard',
                    column: 'In Progress',
                    subColumn: 'Development',
                    createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), // 5 days ago
                    isBlocked: false
                },
                {
                    id: 2,
                    title: 'UI Design Review',
                    description: 'Review and update main dashboard design',
                    assignee: 'Mike Designer',
                    classOfService: 'Standard',
                    column: 'To Do',
                    subColumn: 'Ready',
                    createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000), // 2 days ago
                    isBlocked: false
                },
                {
                    id: 3,
                    title: 'Database Migration',
                    description: 'Migrate user data to new schema',
                    assignee: 'Sarah Tester',
                    classOfService: 'Fixed Date',
                    column: 'In Progress',
                    subColumn: 'Code Review',
                    createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 7 days ago
                    isBlocked: true
                },
                {
                    id: 4,
                    title: 'API Documentation',
                    description: 'Update REST API documentation',
                    assignee: 'John Developer',
                    classOfService: 'Intangible',
                    column: 'Done',
                    subColumn: 'Deployed',
                    createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000), // 10 days ago
                    isBlocked: false
                },
                {
                    id: 5,
                    title: 'Performance Testing',
                    description: 'Run load tests on new features',
                    assignee: 'Sarah Tester',
                    classOfService: 'Standard',
                    column: 'In Progress',
                    subColumn: 'Testing',
                    createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000), // 3 days ago
                    isBlocked: false
                },
                {
                    id: 6,
                    title: 'Critical Security Fix',
                    description: 'Fix urgent security vulnerability',
                    assignee: 'Admin User',
                    classOfService: 'Expedite',
                    column: 'To Do',
                    subColumn: 'Buffer',
                    createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000), // 1 day ago
                    isBlocked: false
                }
            ];

            appState.backlogItems = [
                {
                    id: 1,
                    title: 'Mobile App Integration',
                    description: 'Integrate with mobile application',
                    progress: 'not-started',
                    priority: 'high',
                    size: 'xl'
                },
                {
                    id: 2,
                    title: 'Performance Optimization',
                    description: 'Optimize database queries and API responses',
                    progress: 'in-progress',
                    priority: 'medium',
                    size: 'l'
                },
                {
                    id: 3,
                    title: 'Bug Fix: Login Form',
                    description: 'Fix validation issue in login form',
                    progress: 'blocked',
                    priority: 'high',
                    size: 'xs'
                }
            ];

            // Generate daily snapshots for the past 14 days
            for (let i = 14; i >= 0; i--) {
                const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                appState.dailySnapshots.push({
                    date: date.toISOString().split('T')[0],
                    'Backlog': Math.floor(Math.random() * 5) + 3,
                    'To Do': Math.floor(Math.random() * 4) + 2,
                    'In Progress': Math.floor(Math.random() * 3) + 1,
                    'Done': Math.floor(Math.random() * 10) + i // Increasing over time
                });
            }


          
        }

        // Navigation
        function initNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.dataset.page;
                    if (page) {
                        showPage(page);
                        updateActiveNavLink(link);
                    }
                });
            });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
           
            document.getElementById(pageId).classList.add('active');
            // Always check VSM Help visibility when switching pages
            renderVSMHelp();

            // Always render and update board checkboxes when any page is shown
            if (pageId === 'board') {
                renderKanbanBoard();
                setTimeout(updateCheckboxStates, 50);
                updateBoardTitle();
                // Render common policies after board is rendered
                setTimeout(renderCommonPolicies, 100);
            }
            
            // Refresh other page content
            switch (pageId) {
                case 'business':
                    renderBusinessPage();
                    renderVSMPage();
                    break;
                case 'backlog':
                    renderBacklog();
                    updateBacklogTitle(); // Add this line
                    break;
                case 'board':
                    syncBacklogItemsToBoard();
                    renderKanbanBoard();
                    break;
                case 'team':
                    renderTeam();
                    break;
                case 'metrics':
                    renderMetrics();
                    break;
                // Update the reviews case in showPage() function
                case 'reviews':
                    renderServiceReviews();
                    renderOperationsReviews();
                    // Initialize experiments view - default to prioritize
                    if (document.querySelector('.experiment-view.active')) {
                        const activeView = document.querySelector('.experiment-view.active');
                        if (activeView.id === 'experimentBoardView') {
                            renderExperimentBoard();
                        } else if (activeView.id === 'experimentPrioritizeView') {
                            renderExperimentMatrix();
                        }
                    } else {
                        // Default to prioritize view instead of board view
                        showExperimentView('prioritize');
                    }
                    break;
            }
        }

        // Business page functions
        // Business page functions
        function renderBusinessPage() {
            const sections = ['name', 'vision', 'mission', 'values', 'strategy', 'structure', 'goals', 'outcomes', 'milestones'];
            
            sections.forEach(section => {
                const displayElement = document.getElementById(`business${section.charAt(0).toUpperCase() + section.slice(1)}Display`);
                if (displayElement) {
                    let content = appState.businessInfo[section] || '';
                    
                    // Process Mermaid diagrams if content contains them
                    if (content.includes('```mermaid')) {
                        content = processMermaidContent(content);
                    }
                    
                    displayElement.innerHTML = content;
                    
                    // Initialize Mermaid if diagrams are present
                    if (content.includes('<div class="mermaid">')) {
                        if (typeof mermaid !== 'undefined') {
                            mermaid.init();
                        }
                    }
                }
            });
        }

        // NEW: Separate VSM Help rendering function
        function renderVSMHelp() {
            // Check if we're in business page AND vsm tab AND help sub-tab
            const businessPage = document.getElementById('business');
            const vsmContent = document.getElementById('vsmContent');
            const vsmHelpContent = document.getElementById('vsmHelpContent');
            
            const isBusinessActive = businessPage && businessPage.classList.contains('active');
            const isVsmActive = vsmContent && vsmContent.classList.contains('active');
            const isHelpActive = vsmHelpContent && vsmHelpContent.classList.contains('active');
            
            // Only render if all conditions are met
            if (isBusinessActive && isVsmActive && isHelpActive) {
                // VSM Help content is already in HTML, just make it visible
                const helpContentDiv = document.querySelector('.vsm-help-content');
                if (helpContentDiv) {
                    helpContentDiv.style.display = 'block';
                }
            } else {
                // Hide VSM Help content
                const helpContentDiv = document.querySelector('.vsm-help-content');
                if (helpContentDiv) {
                    helpContentDiv.style.display = 'none';
                }
            }
        }
        function processMermaidContent(content) {
            // Replace ```mermaid blocks with proper mermaid divs
            return content.replace(/```mermaid\n([\s\S]*?)\n```/g, function(match, diagram) {
                return `<div class="mermaid">${diagram.trim()}</div>`;
            });
        }

        function editBusinessSection(sectionType) {
            const titles = {
                name: 'Company/Product Name',
                vision: 'Vision Statement', 
                mission: 'Mission Statement',
                values: 'Value Statement',
                strategy: 'Business Strategy',
                structure: 'Organizational Structure', 
                goals: 'Strategic Goals',
                outcomes: 'Expected Outcomes',
                milestones: 'Key Milestones'
            };
            
            document.getElementById('businessModalTitle').textContent = `Edit ${titles[sectionType]}`;
            document.getElementById('businessFieldLabel').textContent = `${titles[sectionType]}:`;
            document.getElementById('businessSectionType').value = sectionType;
            document.getElementById('businessContent').value = appState.businessInfo[sectionType] || '';
            
            document.getElementById('businessEditModal').style.display = 'block';
        }

        function saveBusinessSection() {
            const sectionType = document.getElementById('businessSectionType').value;
            const content = document.getElementById('businessContent').value;
            
            appState.businessInfo[sectionType] = content;
            saveData();
            renderBusinessPage();
        }

        function handleBusinessEdit(e) {
            e.preventDefault();
            saveBusinessSection();
            closeModal('businessEditModal');
        }





        function updateActiveNavLink(activeLink) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            activeLink.classList.add('active');
        }

        // Avatar management
        function initAvatarSelector() {
            const avatarElement = document.getElementById('currentAvatar');
            const dropdown = document.getElementById('avatarDropdown');
            
            avatarElement.addEventListener('click', () => {
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                renderAvatarDropdown();
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!avatarElement.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
            
            updateCurrentAvatar();
        }

        function renderAvatarDropdown() {
            const dropdown = document.getElementById('avatarDropdown');
            dropdown.innerHTML = appState.teamMembers.map(member => `
                <div class="avatar-option" onclick="switchUser('${member.name}')">
                    <div class="avatar" style="background: ${member.color}; width: 30px; height: 30px; font-size: 0.8rem;">
                        ${member.avatar}
                    </div>
                    <div>
                        <div style="font-weight: bold;">${member.name}</div>
                        <div style="font-size: 0.8rem; color: #666;">${member.role}</div>
                    </div>
                </div>
            `).join('');
        }

        function switchUser(userName) {
            appState.currentUser = userName;
            updateCurrentAvatar();
            document.getElementById('avatarDropdown').style.display = 'none';
            saveData();
        }

        function updateCurrentAvatar() {
            const currentMember = appState.teamMembers.find(m => m.name === appState.currentUser) || appState.teamMembers[0];
            const avatarElement = document.getElementById('currentAvatar');
            avatarElement.textContent = currentMember.avatar;
            avatarElement.style.background = currentMember.color;
        }

        // Kanban Board
        function renderKanbanBoard() {
            console.log('Rendering board with config:', appState.boardConfig);
            
            // Remove the syncBacklogItemsToBoard call since we're not syncing anymore
            const boardElement = document.getElementById('kanbanBoard');
            
            if (appState.showClassesOfService) {
                renderBoardWithClassesOfService(boardElement);
            } else if (appState.showSwimlanes) {
                renderBoardWithSwimlanes(boardElement);
            } else {
                renderBoardNormal(boardElement);
            }
            
            initializeDragAndDrop();
        }
        
        function canEditCard(card) {
            const currentMember = appState.teamMembers.find(m => m.name === appState.currentUser);
            
            // Admin and project managers can edit any card
            if (currentMember && (currentMember.role === 'admin' || currentMember.role === 'project-manager')) {
                return { canEdit: true, isOwner: true };
            }
            
            // Check if user is the card owner
            const isOwner = card.assignee === appState.currentUser;
            
            return { canEdit: true, isOwner: isOwner };
        }

        function syncBacklogItemsToBoard() {
           return;
        }



        function renderColumnPolicies() {
            // This function is no longer needed as policies are rendered inline with columns
        }

        function renderCommonPolicies() {
            const container = document.getElementById('policiesDisplay');
            if (container) {
                const commonPoliciesContent = container.querySelector('.common-policies-content');
                if (commonPoliciesContent) {
                    commonPoliciesContent.innerHTML = appState.commonPolicies.map(policy => 
                        `<div class="policy-bullet">${policy}</div>`
                    ).join('');
                }
            }
        }


function renderBoardNormal(boardElement) {
    const columnsHtml = appState.boardConfig.map(column => {
        const cardsInColumn = appState.cards.filter(card => card.column === column.name);
        const visibleCards = getVisibleCardsInColumn(column, cardsInColumn);
        const wipExceeded = column.wipLimit && visibleCards.length > column.wipLimit;
        const wipStatus = wipExceeded ? '' : 'ok';
        const columnPolicies = column.policies || [];
        
        let columnHtml = `
            <div class="column-with-policies" data-column="${column.name}">
                <div class="column ${wipExceeded ? 'wip-exceeded' : ''}" data-column="${column.name}">
                    <div class="column-header">
                        <span class="column-title">${column.name}</span>
                        ${column.wipLimit ? 
                            `<span class="wip-limit ${wipStatus}">${visibleCards.length}/${column.wipLimit}</span>` : 
                            `<span class="wip-limit ok">${visibleCards.length}</span>`
                        }
                    </div>
                    <div class="column-content" id="column-${column.name.replace(/\s+/g, '-')}">
                        ${renderSubColumns(column, cardsInColumn)}
                    </div>
                </div>
                ${appState.showPolicies ? `
                <div class="column-policies" data-column="${column.name}">
                    <div class="policies-header">
                        <span>📋 ${column.name} Policies</span>
                        <button class="policy-edit-btn" onclick="editColumnPolicies('${column.name}')" title="Edit ${column.name} policies">✏️</button>
                    </div>
                    <div class="policies-content">
                        ${columnPolicies.length > 0 ? 
                            columnPolicies.map(policy => `<div class="policy-bullet">${policy}</div>`).join('') : 
                            `<div class="policy-placeholder" onclick="editColumnPolicies('${column.name}')">Click to add ${column.name} policies...</div>`
                        }
                    </div>
                </div>` : ''}
            </div>`;
        
        return columnHtml;
    }).join('');
    
    boardElement.innerHTML = `<div class="board-with-policies">${columnsHtml}</div>`;
}



        function renderBoardWithSwimlanes(boardElement) {
            const assignees = [...new Set(appState.cards.map(card => card.assignee))];
            
            let swimlaneHtml = '<div class="swimlanes-container">';
            
            // Header row with column names and WIP limits
            swimlaneHtml += '<div class="swimlane-header-row">';
            swimlaneHtml += '<div class="swimlane-assignee-header">Owner</div>';
            appState.boardConfig.forEach(column => {
                const cardsInColumn = appState.cards.filter(card => card.column === column.name);
                const visibleCards = getVisibleCardsInColumn(column, cardsInColumn);
                const wipExceeded = column.wipLimit && visibleCards.length > column.wipLimit;
                const wipStatus = wipExceeded ? '' : 'ok';
                
                swimlaneHtml += `<div class="swimlane-column-header">
                    <div>${column.name}</div>
                    ${column.wipLimit ? 
                        `<span class="wip-limit ${wipStatus}" style="font-size: 0.8rem; margin-top: 0.25rem; display: inline-block;">${visibleCards.length}/${column.wipLimit}</span>` : 
                        `<span class="wip-limit ok" style="font-size: 0.8rem; margin-top: 0.25rem; display: inline-block;">${visibleCards.length}</span>`
                    }
                </div>`;
            });
            swimlaneHtml += '</div>';
            
            // Swimlanes for each assignee
            assignees.forEach(assignee => {
                swimlaneHtml += `<div class="swimlane" data-assignee="${assignee}">`;
                swimlaneHtml += `<div class="swimlane-assignee">${assignee}</div>`;
                
                appState.boardConfig.forEach(column => {
                    const cardsInColumn = appState.cards.filter(card => 
                        card.column === column.name && card.assignee === assignee
                    );
                    
                    swimlaneHtml += `
                        <div class="swimlane-column" data-column="${column.name}">
                            <div class="column-content swimlane-content" id="swimlane-${assignee.replace(/\s+/g, '-')}-${column.name.replace(/\s+/g, '-')}">
                                ${cardsInColumn.map(card => renderCard(card)).join('')}
                            </div>
                        </div>
                    `;
                });
                
                swimlaneHtml += '</div>';
            });
            
            // Add policies row if enabled
            if (appState.showPolicies) {
                swimlaneHtml += '<div class="swimlane policies-row">';
                swimlaneHtml += '<div class="swimlane-assignee" style="background: #f8f9fa; color: #333;">Column Policies</div>';
                
                appState.boardConfig.forEach(column => {
                    const columnPolicies = column.policies || [];
                    swimlaneHtml += `
                        <div class="swimlane-column" data-column="${column.name}">
                            <div class="column-policies" style="height: auto; margin: 0; padding: 0.5rem;">
                                <div class="policies-header">
                                    <span>📋 ${column.name} Policies</span>
                                    <button class="policy-edit-btn" onclick="editColumnPolicies('${column.name}')" title="Edit ${column.name} policies">✏️</button>
                                </div>
                                <div class="policies-content">
                                    ${columnPolicies.length > 0 ? 
                                        columnPolicies.map(policy => `<div class="policy-bullet">${policy}</div>`).join('') : 
                                        `<div class="policy-placeholder" onclick="editColumnPolicies('${column.name}')">Click to add ${column.name} policies...</div>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                swimlaneHtml += '</div>';
            }
            
            swimlaneHtml += '</div>';
            boardElement.innerHTML = swimlaneHtml;
        }


        function renderBoardWithClassesOfService(boardElement) {
            let cosHtml = '<div class="cos-container">';
            
            // Header row with column names and WIP limits
            cosHtml += '<div class="cos-header-row">';
            cosHtml += '<div class="cos-class-header">Class of Service</div>';
            appState.boardConfig.forEach(column => {
                const cardsInColumn = appState.cards.filter(card => card.column === column.name);
                const visibleCards = getVisibleCardsInColumn(column, cardsInColumn);
                const wipExceeded = column.wipLimit && visibleCards.length > column.wipLimit;
                const wipStatus = wipExceeded ? '' : 'ok';
                
                cosHtml += `<div class="cos-column-header">
                    <div>${column.name}</div>
                    ${column.wipLimit ? 
                        `<span class="wip-limit ${wipStatus}" style="font-size: 0.8rem; margin-top: 0.25rem; display: inline-block;">${visibleCards.length}/${column.wipLimit}</span>` : 
                        `<span class="wip-limit ok" style="font-size: 0.8rem; margin-top: 0.25rem; display: inline-block;">${visibleCards.length}</span>`
                    }
                </div>`;
            });
            cosHtml += '</div>';
            
            // Swimlanes for each class of service
            appState.classesOfService.forEach(cos => {
                cosHtml += `<div class="cos-lane" data-cos="${cos.name}">`;
                cosHtml += `<div class="cos-class" style="background: ${cos.color}; color: white;">
                    <div style="font-weight: bold;">${cos.name}</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">${cos.description}</div>
                </div>`;
                
                appState.boardConfig.forEach(column => {
                    const cardsInColumn = appState.cards.filter(card => 
                        card.column === column.name && (card.classOfService || 'Standard') === cos.name
                    );
                    
                    cosHtml += `
                        <div class="cos-column" data-column="${column.name}">
                            <div class="column-content cos-content" id="cos-${cos.name.replace(/\s+/g, '-')}-${column.name.replace(/\s+/g, '-')}">
                                ${cardsInColumn.map(card => renderCard(card)).join('')}
                            </div>
                        </div>
                    `;
                });
                
                cosHtml += '</div>';
            });
            
            // Add policies row if enabled
            if (appState.showPolicies) {
                cosHtml += '<div class="cos-lane policies-row">';
                cosHtml += '<div class="cos-class" style="background: #f8f9fa; color: #333; border: 1px solid #dee2e6;">Column Policies</div>';
                
                appState.boardConfig.forEach(column => {
                    const columnPolicies = column.policies || [];
                    cosHtml += `
                        <div class="cos-column" data-column="${column.name}">
                            <div class="column-policies" style="height: auto; margin: 0;">
                                <div class="policies-header">
                                    <span>📋 ${column.name} Policies</span>
                                    <button class="policy-edit-btn" onclick="editColumnPolicies('${column.name}')" title="Edit ${column.name} policies">✏️</button>
                                </div>
                                <div class="policies-content">
                                    ${columnPolicies.length > 0 ? 
                                        columnPolicies.map(policy => `<div class="policy-bullet">${policy}</div>`).join('') : 
                                        `<div class="policy-placeholder" onclick="editColumnPolicies('${column.name}')">Click to add ${column.name} policies...</div>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                cosHtml += '</div>';
            }
            
            cosHtml += '</div>';
            boardElement.innerHTML = cosHtml;
        }

        function toggleSubColumns() {
            appState.showSubColumns = document.getElementById('showSubColumns').checked;
            saveData();
            renderKanbanBoard();
        }

        function toggleBufferColumns() {
            appState.showBufferColumns = document.getElementById('showBufferColumns').checked;
            saveData();
            renderKanbanBoard();
        }

        function toggleSwimlanes() {
            appState.showSwimlanes = document.getElementById('showSwimlanes').checked;
            if (appState.showSwimlanes) {
                appState.showClassesOfService = false;
                document.getElementById('showClassesOfService').checked = false;
            }
            saveData();
            renderKanbanBoard();
        }

        function toggleClassesOfService() {
            appState.showClassesOfService = document.getElementById('showClassesOfService').checked;
            if (appState.showClassesOfService) {
                appState.showSwimlanes = false;
                document.getElementById('showSwimlanes').checked = false;
            }
            saveData();
            renderKanbanBoard();
        }

        function togglePolicies() {
            appState.showPolicies = document.getElementById('showPolicies').checked;
            const policiesSection = document.getElementById('policiesSection');
            
            if (appState.showPolicies) {
                policiesSection.style.display = 'block';
            } else {
                policiesSection.style.display = 'none';
            }
            
            // Update column policies visibility
            const columnPolicies = document.querySelectorAll('.column-policies');
            columnPolicies.forEach(policy => {
                policy.style.display = appState.showPolicies ? 'block' : 'none';
            });
            
            saveData();
        }

        function updateBoardTitle() {
            const titleInput = document.getElementById('boardTitle');
            if (titleInput) {
                titleInput.value = appState.boardTitle;
            }
        }

        function saveBoardTitle() {
            const titleInput = document.getElementById('boardTitle');
            if (titleInput) {
                appState.boardTitle = titleInput.value || 'Kanban Board';
                saveData();
            }
        }

        function handleBoardTitleKeydown(event) {
            if (event.key === 'Enter') {
                event.target.blur(); // This will trigger the onblur event
            }
        }


        function renderCard(card) {
            const age = Math.floor((new Date() - new Date(card.createdAt)) / (1000 * 60 * 60 * 24));
            const ageDots = Array.from({length: Math.min(age, 10)}, (_, i) => 
                `<div class="age-dot ${age > 5 ? 'old' : ''}"></div>`
            ).join('');
            
            // Check if current user can edit this card
            const permission = canEditCard(card);
            const isMyCard = card.assignee === appState.currentUser;
            const cardOwnershipClass = isMyCard ? 'my-card' : 'other-card';
            
            return `
                <div class="card ${card.isBlocked ? 'blocked' : ''} ${cardOwnershipClass}" data-card-id="${card.id}">
                    <div class="card-header">
                        <div class="card-title">${card.title}</div>
                        <div class="card-age" title="${age} days old">
                            ${ageDots}
                        </div>
                    </div>
                    <div class="card-assignee">🏷️ Owned by: ${card.assignee} ${isMyCard ? '(You)' : ''}</div>
                    <div class="card-description">${card.description}</div>
                    <div class="card-actions">
                        ${card.backlogItemId ? 
                            // Actions for backlog cards
                            `<button class="icon-btn" onclick="editBacklogFromBoard('${card.backlogItemId}')" title="Edit in Backlog">
                                📝
                            </button>
                            <button class="icon-btn" onclick="moveBacklogItemToReady('${card.backlogItemId}')" title="Move to Ready">
                                ➡️
                            </button>` :
                            // Actions for regular cards
                            `<button class="icon-btn edit" onclick="editCard(${card.id})" title="Edit${!isMyCard ? ' (Not your card)' : ''}">
                                ✏️
                            </button>
                            <button class="icon-btn ${card.isBlocked ? 'blocked' : 'block'}" 
                                    onclick="toggleBlockCard(${card.id})" 
                                    title="${card.isBlocked ? 'Unblock' : 'Block'}">
                                ${card.isBlocked ? '🚫' : '⚠️'}
                            </button>
                            <button class="icon-btn" onclick="moveCardToBacklog(${card.id})" title="Move to Backlog">
                                📋
                            </button>
                            ${canDeleteCard() ? `<button class="icon-btn delete" onclick="deleteCard(${card.id})" title="Delete">🗑️</button>` : ''}`
                        }
                    </div>
                </div>
            `;
        }

        function editBacklogFromBoard(backlogItemId) {
            // Extract the item ID from backlogItemId (remove 'backlog_' prefix)
            const itemId = parseInt(backlogItemId.replace('backlog_', ''));
            
            // Switch to backlog page and edit the item
            showPage('backlog');
            updateActiveNavLink(document.querySelector('[data-page="backlog"]'));
            
            // Small delay to ensure page is rendered, then edit the item
            setTimeout(() => {
                editBacklogItem(itemId);
            }, 100);
        }

        function moveBacklogItemToReady(backlogItemId) {
            const itemId = parseInt(backlogItemId.replace('backlog_', ''));
            const item = appState.backlogItems.find(i => i.id === itemId);
            
            if (item && confirm('Move this backlog item to Ready in To Do column?')) {
                // Create new card in Ready sub-column
                const newCard = {
                    id: Date.now(),
                    title: item.title,
                    description: item.description,
                    assignee: appState.currentUser,
                    column: 'To Do',
                    subColumn: 'Ready',
                    classOfService: item.priority === 'high' ? 'Expedite' : 
                                item.priority === 'medium' ? 'Standard' : 'Intangible',
                    size: item.size,
                    createdAt: new Date(),
                    isBlocked: false
                };
                
                // Add card and remove from backlog
                appState.cards.push(newCard);
                appState.backlogItems = appState.backlogItems.filter(i => i.id !== itemId);
                
                saveData();
                renderKanbanBoard();
                renderBacklog(); // Update backlog page if visible
                alert('Item moved to Ready successfully!');
            }
        }




        function initializeDragAndDrop() {
            // Clear existing sortable instances first
            document.querySelectorAll('.sortable-initialized').forEach(el => {
                if (el.sortable) {
                    el.sortable.destroy();
                }
            });

            appState.boardConfig.forEach(column => {
                // Main column drag and drop
                const columnElement = document.getElementById(`column-${column.name.replace(/\s+/g, '-')}`);
                if (columnElement && !appState.showSubColumns && !appState.showBufferColumns) {
                    initSortableForElement(columnElement);
                }
                
                // Sub-column and buffer column drag and drop
                if (appState.showSubColumns || appState.showBufferColumns) {
                    const subColumns = columnElement ? columnElement.querySelectorAll('.sub-column-content') : [];
                    subColumns.forEach(subCol => {
                        initSortableForElement(subCol);
                    });
                }
            });

            // Special handling for swimlanes and classes of service
            if (appState.showSwimlanes) {
                initSwimlaneDragDrop();
            }
            if (appState.showClassesOfService) {
                initClassOfServiceDragDrop();
            }
        }


        function initializeDragAndDrop() {
            // Clear existing sortable instances first
            document.querySelectorAll('.sortable-initialized').forEach(el => {
                if (el.sortable) {
                    el.sortable.destroy();
                }
            });

            appState.boardConfig.forEach(column => {
                const columnElement = document.getElementById(`column-${column.name.replace(/\s+/g, '-')}`);
                if (!columnElement) return;

                // 1. PLAIN COLUMN CONTENT (when no sub-columns or buffers are shown)
                if (!appState.showSubColumns && !appState.showBufferColumns) {
                    initSortableForElement(columnElement.querySelector('.column-content') || columnElement);
                }

                // 2. SUB-COLUMN CONTENT (plain sub-columns without buffers)
                if (appState.showSubColumns && column.subColumns && column.subColumns.length > 0) {
                    column.subColumns.forEach(subCol => {
                        // Plain sub-column content
                        const subColElement = columnElement.querySelector(`[data-sub-column="${subCol.name}"] .sub-column-content`);
                        if (subColElement) {
                            initSortableForElement(subColElement);
                        }

                        // Sub-column buffer content
                        if (appState.showBufferColumns && subCol.bufferColumns && subCol.bufferColumns.length > 0) {
                            subCol.bufferColumns.forEach(buffer => {
                                const bufferElement = columnElement.querySelector(`[data-sub-column="${buffer.name}"] .buffer-content`);
                                if (bufferElement) {
                                    initSortableForElement(bufferElement);
                                }
                            });
                        }
                    });
                }

                // 3. COLUMN-LEVEL BUFFER CONTENT
                if (appState.showBufferColumns && column.bufferColumns && column.bufferColumns.length > 0) {
                    column.bufferColumns.forEach(buffer => {
                        const bufferElement = columnElement.querySelector(`[data-sub-column="${buffer.name}"] .buffer-content`);
                        if (bufferElement) {
                            initSortableForElement(bufferElement);
                        }
                    });
                }
            });

            // Handle swimlanes and classes of service
            if (appState.showSwimlanes) {
                initSwimlaneDragDrop();
            }
            if (appState.showClassesOfService) {
                initClassOfServiceDragDrop();
            }
        }

        function initSwimlaneDragDrop() {
            document.querySelectorAll('.swimlane-content').forEach(content => {
                if (!content.classList.contains('sortable-initialized')) {
                    initSortableForElement(content);
                }
            });
        }

function initClassOfServiceDragDrop() {
    document.querySelectorAll('.cos-content').forEach(content => {
        if (!content.classList.contains('sortable-initialized')) {
            content.classList.add('sortable-initialized');
            content.sortable = new Sortable(content, {
                group: 'kanban',
                animation: 150,
                ghostClass: 'card-ghost',
                chosenClass: 'card-chosen',
                onEnd: function(evt) {
                    const cardId = parseInt(evt.item.dataset.cardId);
                    const targetElement = evt.to;
                    
                    // Get the class of service from the row
                    const cosLane = targetElement.closest('.cos-lane');
                    const cosName = cosLane.dataset.cos;
                    
                    // Get the column from the cell
                    const cosColumn = targetElement.closest('.cos-column');
                    const columnName = cosColumn.dataset.column;
                    
                    // Update card's class of service and column
                    const card = appState.cards.find(c => c.id === cardId);
                    if (card) {
                        card.classOfService = cosName;
                        moveCard(cardId, columnName, null, null, false);
                    }
                }
            });
        }
    });
}


function moveCard(cardId, newColumn, newSubColumn = null, newPosition = null, isBuffer = false) {
    const card = appState.cards.find(c => c.id === cardId);
    if (!card) return;
    
    const oldColumn = card.column;
    const oldSubColumn = card.subColumn;
    const oldIsBuffer = card.isInBuffer;
    
    // Update card location
    card.column = newColumn;
    card.subColumn = newSubColumn;
    
    // Determine if new location is a buffer (override parameter with actual check)
    card.isInBuffer = isSubColumnABuffer(newColumn, newSubColumn);
    
    card.movedAt = new Date();
    
    // Ensure card has a classOfService when moved in CoS view
    if (appState.showClassesOfService && !card.classOfService) {
        card.classOfService = 'Standard';
    }
    
    // Set position if specified
    if (newPosition !== null) {
        card.position = newPosition + 1;
    } else {
        // Calculate new position at end of target location
        const cardsInTarget = appState.cards.filter(c => 
            c.column === newColumn && 
            c.subColumn === newSubColumn && 
            c.isInBuffer === card.isInBuffer &&
            c.id !== cardId
        );
        card.position = cardsInTarget.length > 0 ? 
            Math.max(...cardsInTarget.map(c => c.position || 0)) + 1 : 1;
    }
    
    // Track movement for metrics
    trackCardMovement(card, oldColumn, oldSubColumn, oldIsBuffer);
    
    // Check WIP limits (excluding Expedite for CoS)
    checkWipLimits(newColumn);
    
    saveData();
    renderKanbanBoard();
}

function updateCardPosition(cardId, newIndex) {
    const card = appState.cards.find(c => c.id === cardId);
    if (!card) return;
    
    // Get all cards in the same location (same column, sub-column, and buffer status)
    const cardsInSameLocation = appState.cards.filter(c => 
        c.column === card.column && 
        c.subColumn === card.subColumn &&
        c.isInBuffer === card.isInBuffer &&
        c.id !== cardId
    ).sort((a, b) => (a.position || 0) - (b.position || 0));
    
    // Insert the moved card at the new position
    cardsInSameLocation.splice(newIndex, 0, card);
    
    // Update all positions in this location
    cardsInSameLocation.forEach((c, index) => {
        c.position = index + 1;
    });
    
    console.log(`Card ${card.title} moved to position ${card.position} in ${card.column}/${card.subColumn}`);
}

        function reorderCardsInLocation(column, subColumn, excludeCardId = null) {
            const cardsInLocation = appState.cards
                .filter(c => c.column === column && c.subColumn === subColumn && c.id !== excludeCardId)
                .sort((a, b) => (a.position || 0) - (b.position || 0));
            
            cardsInLocation.forEach((card, index) => {
                card.position = index + 1;
            });
        }

        // Card management
        function showAddCardModal() {
            populateAssigneeSelect();
            populateColumnSelect();
            document.getElementById('addCardModal').style.display = 'block';
        }

        function populateAssigneeSelect() {
            const select = document.getElementById('cardAssignee');
            select.innerHTML = appState.teamMembers.map(member => 
                `<option value="${member.name}">${member.name}</option>`
            ).join('');
        }


function populateColumnSelect() {
    const select = document.getElementById('cardColumn');
    if (!select) return;
    
    select.innerHTML = appState.boardConfig.map(column => 
        `<option value="${column.name}">${column.name}</option>`
    ).join('');
    
    let subColumnSelect = document.getElementById('cardSubColumn');
    if (!subColumnSelect) {
        const formGroup = document.createElement('div');
        formGroup.className = 'form-group';
        formGroup.innerHTML = `
            <label for="cardSubColumn">Sub-column:</label>
            <select id="cardSubColumn" class="form-control">
                <option value="">Select Sub-column</option>
            </select>
        `;
        const submitButton = select.closest('form').querySelector('button[type="submit"]');
        submitButton.parentNode.insertBefore(formGroup, submitButton);
        select.addEventListener('change', updateSubColumnOptions);
    }
    updateSubColumnOptions();
}

        function updateSubColumnOptions() {
            const columnSelect = document.getElementById('cardColumn');
            const subColumnSelect = document.getElementById('cardSubColumn');
            
            if (!columnSelect || !subColumnSelect) {
                return;
            }
            
            const columnName = columnSelect.value;
            const column = appState.boardConfig.find(c => c.name === columnName);
            
            let options = '<option value="">Select Sub-column</option>';
            
            if (column && column.subColumns && column.subColumns.length > 0) {
                column.subColumns.forEach(subCol => {
                    // Handle both string format and object format
                    const subColName = typeof subCol === 'string' ? subCol : subCol.name;
                    options += `<option value="${subColName}">${subColName}</option>`;
                });
            }
            
            if (column && column.bufferColumns && column.bufferColumns.length > 0) {
                column.bufferColumns.forEach(buffer => {
                    // Handle both string format and object format
                    const bufferName = typeof buffer === 'string' ? buffer : buffer.name;
                    options += `<option value="${bufferName}">🔦 ${bufferName}</option>`;
                });
            }
            
            subColumnSelect.innerHTML = options;
        }


function addCard(title, description, assignee, classOfService, column, subColumn) {
    const newCard = {
        id: Date.now(),
        title,
        description,
        assignee,
        classOfService: classOfService || 'Standard',
        column,
        subColumn: subColumn || null,
        createdAt: new Date(),
        isBlocked: false,
        isInBuffer: isSubColumnABuffer(column, subColumn) // Properly set buffer status
    };
    
    appState.cards.push(newCard);
    saveData();
    renderKanbanBoard();
}

        function moveCardToBacklog(cardId) {
            const card = appState.cards.find(c => c.id === cardId);
            if (card && confirm('Move this card back to backlog? This will remove it from the board.')) {
                const backlogItem = {
                    id: Date.now(),
                    title: card.title,
                    description: card.description,
                    progress: card.isBlocked ? 'blocked' : 'in-progress',
                    priority: 'medium', // Default priority
                    size: card.size || 'm', // Use card size if available
                    classOfService: card.classOfService || 'Standard'
                };
                
                appState.backlogItems.push(backlogItem);
                appState.cards = appState.cards.filter(c => c.id !== cardId);
                saveData();
                renderKanbanBoard();
                renderBacklog(); // Refresh backlog page if visible
                alert('Card moved to backlog successfully!');
            }
        }

function editCard(cardId) {
    const card = appState.cards.find(c => c.id === cardId);
    if (!card) return;
    
    // Check permissions
    const permission = canEditCard(card);
    
    if (!permission.isOwner && permission.canEdit) {
        const proceed = confirm(`Warning: This card is assigned to "${card.assignee}" but you are logged in as "${appState.currentUser}".\n\nYou are allowed to edit this card, but please consider if this is appropriate.\n\nDo you want to proceed with editing?`);
        
        if (!proceed) {
            return;
        }
    }
    
    // Store the editing card ID globally
    window.editingCardId = cardId;
    
    // Populate dropdowns first
    populateAssigneeSelect();
    populateColumnSelect();
    
    // Pre-populate modal with card data
    document.getElementById('cardTitle').value = card.title;
    document.getElementById('cardDescription').value = card.description;
    document.getElementById('cardAssignee').value = card.assignee;
    document.getElementById('cardClassOfService').value = card.classOfService || 'Standard';
    document.getElementById('cardColumn').value = card.column;
    
    // Set sub-column after ensuring options are populated
    setTimeout(() => {
        updateSubColumnOptions();
        const subColumnSelect = document.getElementById('cardSubColumn');
        if (subColumnSelect && card.subColumn) {
            subColumnSelect.value = card.subColumn;
        }
    }, 100);
    
    // Update modal title and button
    const modalTitle = document.querySelector('#addCardModal .modal-header h2');
    const submitButton = document.querySelector('#addCardModal button[type="submit"]');
    
    if (permission.isOwner) {
        modalTitle.textContent = 'Edit Card';
        modalTitle.style.color = '';
    } else {
        modalTitle.textContent = `Edit Card (Owner: ${card.assignee})`;
        modalTitle.style.color = '#fd7e14';
    }
    
    submitButton.textContent = 'Update Card';
    
    document.getElementById('addCardModal').style.display = 'block';
}


function updateCard(cardId, title, description, assignee, classOfService, column, subColumn) {
    const card = appState.cards.find(c => c.id === cardId);
    if (card) {
        // If parameters are provided, use them; otherwise get from form
        if (title !== undefined) {
            card.title = title;
            card.description = description;
            card.assignee = assignee;
            card.classOfService = classOfService;
            card.column = column;
            card.subColumn = subColumn; // Allow null/empty values
            
            // Determine if the new sub-column is a buffer
            card.isInBuffer = isSubColumnABuffer(column, subColumn);
        } else {
            // Legacy support - get from form fields
            card.title = document.getElementById('cardTitle').value;
            card.description = document.getElementById('cardDescription').value;
            card.assignee = document.getElementById('cardAssignee').value;
            card.classOfService = document.getElementById('cardClassOfService').value;
            card.column = document.getElementById('cardColumn').value;
            const newSubColumn = document.getElementById('cardSubColumn').value || null;
            card.subColumn = newSubColumn;
            card.isInBuffer = isSubColumnABuffer(card.column, newSubColumn);
        }
        
        saveData();
        renderKanbanBoard();
    }
}


function isSubColumnABuffer(columnName, subColumnName) {
    if (!subColumnName) return false;
    
    const column = appState.boardConfig.find(c => c.name === columnName);
    if (!column) return false;
    
    // Check column-level buffers
    if (column.bufferColumns && column.bufferColumns.some(buffer => {
        const bufferName = typeof buffer === 'string' ? buffer : buffer.name;
        return bufferName === subColumnName;
    })) {
        return true;
    }
    
    // Check sub-column buffers
    if (column.subColumns) {
        for (const subCol of column.subColumns) {
            if (subCol.bufferColumns && subCol.bufferColumns.some(buffer => {
                const bufferName = typeof buffer === 'string' ? buffer : buffer.name;
                return bufferName === subColumnName;
            })) {
                return true;
            }
        }
    }
    
    return false;
}

        function toggleBlockCard(cardId) {
            const card = appState.cards.find(c => c.id === cardId);
            if (card) {
                card.isBlocked = !card.isBlocked;
                saveData();
                renderKanbanBoard();
            }
        }

        function deleteCard(cardId) {
            if (confirm('Are you sure you want to delete this card?')) {
                appState.cards = appState.cards.filter(c => c.id !== cardId);
                saveData();
                renderKanbanBoard();
            }
        }

        function canDeleteCard() {
            const currentMember = appState.teamMembers.find(m => m.name === appState.currentUser);
            return currentMember && (currentMember.role === 'admin' || currentMember.role === 'project-manager');
        }
        // Helper function to get class of service color
        function getClassOfServiceColor(classOfService) {
            const cosColors = {
                'Expedite': '#dc3545',      // Red
                'Fixed Date': '#fd7e14',    // Orange
                'Standard': '#28a745',      // Green
                'Intangible': '#6c757d'     // Gray
            };
            return cosColors[classOfService] || '#6c757d'; // Default gray
        }
        // Backlog management        
        function renderBacklog() {
            const container = document.getElementById('backlogItems');
            const showBoarded = document.getElementById('showBoardedItems')?.checked || false;
            
            let allItems = [...appState.backlogItems];
            
            // Add boarded items if checkbox is checked
            if (showBoarded) {
                const boardedItems = appState.cards.map(card => ({
                    id: `card-${card.id}`,
                    title: card.title,
                    description: card.description,
                    progress: card.isBlocked ? 'blocked' : 'boarded',
                    priority: card.classOfService === 'Expedite' ? 'high' : 
                            card.classOfService === 'Standard' ? 'medium' : 'low',
                    size: card.size || 'm',
                    classOfService: card.classOfService || 'Standard',
                    currentLocation: `${card.column}${card.subColumn ? ' > ' + card.subColumn : ''}`,
                    isBoarded: true,
                    originalCard: card
                }));
                allItems = [...allItems, ...boardedItems];
            }
            
            container.innerHTML = allItems.map((item, index) => {
                const isBoarded = item.isBoarded;
                const locationBadge = isBoarded ? 
                    `<div style="display: flex; align-items: center; gap: 0.25rem;">
                        <span style="font-size: 0.75rem; color: #6c757d; font-weight: 500;">Location:</span>
                        <span class="badge location-badge" style="padding: 0.25rem 0.5rem; border-radius: 15px; font-size: 0.8rem; 
                            background: #17a2b8; color: white;">
                            ${item.currentLocation}
                        </span>
                    </div>` : '';
                
                return `
                    <div class="card backlog-item ${isBoarded ? 'boarded-item' : ''}" style="margin-bottom: 1rem; cursor: move;" data-item-id="${item.id}">
                        <div class="card-header">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${!isBoarded ? '<span class="drag-handle" style="cursor: grab; color: #6c757d; font-size: 1.2rem;" title="Drag to reorder">⋮⋮</span>' : ''}
                                <div class="card-title" style="flex-grow: 1;">${item.title}</div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 0.25rem;">
                                    <span style="font-size: 0.75rem; color: #6c757d; font-weight: 500;">Progress:</span>
                                    <span class="badge progress-badge" style="padding: 0.25rem 0.5rem; border-radius: 15px; font-size: 0.8rem; 
                                        background: ${getProgressColor(item.progress)}; color: white;">
                                        ${(item.progress || 'not-started').replace('-', ' ').toUpperCase()}
                                    </span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.25rem;">
                                    <span style="font-size: 0.75rem; color: #6c757d; font-weight: 500;">Priority:</span>
                                    <span class="badge ${item.priority}" style="padding: 0.25rem 0.5rem; border-radius: 15px; font-size: 0.8rem; 
                                        background: ${item.priority === 'high' ? '#dc3545' : item.priority === 'medium' ? '#ffc107' : '#28a745'}; 
                                        color: ${item.priority === 'medium' ? '#212529' : 'white'};">
                                        ${item.priority.toUpperCase()}
                                    </span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.25rem;">
                                    <span style="font-size: 0.75rem; color: #6c757d; font-weight: 500;">Size:</span>
                                    <span class="badge size-badge" style="padding: 0.25rem 0.5rem; border-radius: 15px; font-size: 0.8rem; 
                                        background: ${getSizeColor(item.size)}; color: white;">
                                        ${(item.size || 'm').toUpperCase()}
                                    </span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.25rem;">
                                    <span style="font-size: 0.75rem; color: #6c757d; font-weight: 500;">CoS:</span>
                                    <span class="badge cos-badge" style="padding: 0.25rem 0.5rem; border-radius: 15px; font-size: 0.8rem; 
                                        background: ${getClassOfServiceColor(item.classOfService)}; color: white;">
                                        ${(item.classOfService || 'Standard').toUpperCase()}
                                    </span>
                                </div>
                                ${locationBadge}
                            </div>
                        </div>
                        <div class="card-description">${item.description}</div>
                        <div class="card-actions">
                            ${isBoarded ? 
                                `<button class="btn btn-warning" onclick="moveBoardedItemToBacklog('${item.id}')">Move to Backlog</button>` :
                                `<button class="btn btn-primary" onclick="moveToBoard(${item.id})">Move to Board</button>`
                            }
                            ${canEditBacklog() && !isBoarded ? `
                                <button class="btn btn-warning" onclick="editBacklogItem(${item.id})">Edit</button>
                                <button class="btn btn-danger" onclick="deleteBacklogItem(${item.id})">Delete</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Only initialize drag and drop for non-boarded items
            if (!showBoarded) {
                initializeBacklogSorting();
            }
        }


        function toggleBoardedItems() {
            renderBacklog();
        }

        function moveBoardedItemToBacklog(itemId) {
            const cardId = parseInt(itemId.replace('card-', ''));
            const card = appState.cards.find(c => c.id === cardId);
            
            if (card && confirm('Move this card back to backlog? This will remove it from the board.')) {
                const backlogItem = {
                    id: Date.now(),
                    title: card.title,
                    description: card.description,
                    progress: card.isBlocked ? 'blocked' : 'not-started',
                    priority: card.classOfService === 'Expedite' ? 'high' : 
                            card.classOfService === 'Standard' ? 'medium' : 'low',
                    size: card.size || 'm',
                    classOfService: card.classOfService || 'Standard'
                };
                
                appState.backlogItems.push(backlogItem);
                appState.cards = appState.cards.filter(c => c.id !== cardId);
                saveData();
                renderBacklog();
                renderKanbanBoard(); // Refresh board if visible
                alert('Card moved to backlog successfully!');
            }
        }
        function initializeBacklogSorting() {
            const container = document.getElementById('backlogItems');
            if (container) {
                new Sortable(container, {
                    animation: 150,
                    ghostClass: 'card-ghost',
                    chosenClass: 'card-chosen',
                    handle: '.drag-handle', // Only allow dragging by the handle
                    onEnd: function(evt) {
                        const itemId = parseInt(evt.item.dataset.itemId);
                        const newIndex = evt.newIndex;
                        reorderBacklogItem(itemId, newIndex);
                    }
                });
            }
        }

        function reorderBacklogItem(itemId, newIndex) {
            const item = appState.backlogItems.find(i => i.id === itemId);
            if (item) {
                // Remove item from current position
                const currentIndex = appState.backlogItems.findIndex(i => i.id === itemId);
                appState.backlogItems.splice(currentIndex, 1);
                
                // Insert at new position
                appState.backlogItems.splice(newIndex, 0, item);
                
                saveData();
                // No need to re-render since Sortable already moved the DOM element
            }
        }

        function saveConfiguration() {
            // Get the configuration from wherever it's defined (form, JSON editor, etc.)
            const newConfig = getConfigurationFromUI(); // You'll need to implement this
            
            // Update app state
            appState.boardConfig = newConfig;
            
            // Save to localStorage  
            saveData();
            
            // IMMEDIATE REFRESH
            renderKanbanBoard();
            
            // Update any dependent UI elements
            updateAllDropdowns();
            
            console.log('Configuration saved and refreshed');
        }

        function updateAllDropdowns() {
            if (document.getElementById('cardColumn')) {
                populateColumnSelect();
                updateSubColumnOptions();
            }
        }

        let editingItemId = null; // Track which item is being edited
        let editingColumnName = null; // Track which column policies are being edited

        function editCommonPolicies() {
            document.getElementById('commonPolicies').value = appState.commonPolicies.join('\n');
            document.getElementById('commonPolicyModal').style.display = 'block';
        }

        function saveCommonPolicies() {
            const policiesText = document.getElementById('commonPolicies').value;
            const policies = policiesText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            appState.commonPolicies = policies;
            saveData();
            renderCommonPolicies();
            closeModal('commonPolicyModal');
        }

        function editColumnPolicies(columnName) {
            editingColumnName = columnName;
            const column = appState.boardConfig.find(c => c.name === columnName);
            const policies = column.policies || [];
            
            document.getElementById('policyModalTitle').textContent = `Edit ${columnName} Policies`;
            document.getElementById('columnPolicies').value = policies.join('\n');
            document.getElementById('columnPolicyModal').style.display = 'block';
        }

        function saveColumnPolicies() {
            if (editingColumnName) {
                const column = appState.boardConfig.find(c => c.name === editingColumnName);
                const policiesText = document.getElementById('columnPolicies').value;
                const policies = policiesText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                column.policies = policies;
                saveData();
                renderKanbanBoard();
                closeModal('columnPolicyModal');
            }
        }

        function showAddItemModal() {
            editingItemId = null; // Reset editing state
            document.getElementById('addItemModal').style.display = 'block';
        }

        function addBacklogItem(title, description, progress, priority, size, classOfService) {
            const newItem = {
                id: Date.now(),
                title,
                description,
                progress,
                priority,
                size,
                classOfService: classOfService || 'Standard'
            };
            
            appState.backlogItems.push(newItem);
            saveData();
            renderBacklog();
        }

        function moveToBoard(itemId) {
            const item = appState.backlogItems.find(i => i.id === itemId);
            if (item) {
                // Calculate position as the highest position in the Ready sub-column + 1
                const cardsInReady = appState.cards.filter(c => 
                    c.column === 'To Do' && c.subColumn === 'Ready'
                );
                const maxPosition = cardsInReady.length > 0 ? 
                    Math.max(...cardsInReady.map(c => c.position || 0)) : 0;
                
                const newCard = {
                    id: Date.now(),
                    title: item.title,
                    description: item.description,
                    assignee: appState.currentUser,
                    column: 'To Do',
                    subColumn: 'Ready',
                    classOfService: item.classOfService || (
                        item.priority === 'high' ? 'Expedite' : 
                        item.priority === 'medium' ? 'Standard' : 'Intangible'
                    ),
                    size: item.size,
                    position: maxPosition + 1,
                    createdAt: new Date(),
                    isBlocked: false
                };
                
                appState.cards.push(newCard);
                appState.backlogItems = appState.backlogItems.filter(i => i.id !== itemId);
                
                saveData();
                
                // Refresh both views
                renderBacklog();
                if (document.getElementById('board').classList.contains('active')) {
                    renderKanbanBoard();
                }
                
                alert('Item moved to Ready in To Do column successfully!');
            }
        }


        function canEditBacklog() {
            const currentMember = appState.teamMembers.find(m => m.name === appState.currentUser);
            return currentMember && (currentMember.role === 'admin' || currentMember.role === 'product-owner');
        }

        function editBacklogItem(itemId) {
            const item = appState.backlogItems.find(i => i.id === itemId);
            if (item) {
                editingItemId = itemId; // Set the item being edited
                
                document.getElementById('itemTitle').value = item.title;
                document.getElementById('itemDescription').value = item.description;
                document.getElementById('itemProgress').value = item.progress || 'not-started';
                document.getElementById('itemPriority').value = item.priority;
                document.getElementById('itemSize').value = item.size || 'm';
                document.getElementById('itemClassOfService').value = item.classOfService || 'Standard';
                
                const submitButton = document.querySelector('#addItemForm button[type="submit"]');
                
                document.querySelector('#addItemModal h2').textContent = 'Update Backlog Item';
                submitButton.textContent = 'Update Item';
                document.getElementById('addItemModal').style.display = 'block';
            }
        }

        function updateBacklogItem(itemId) {
            const item = appState.backlogItems.find(i => i.id === itemId);
            if (item) {
                item.title = document.getElementById('itemTitle').value;
                item.description = document.getElementById('itemDescription').value;
                item.progress = document.getElementById('itemProgress').value;
                item.priority = document.getElementById('itemPriority').value;
                item.size = document.getElementById('itemSize').value;
                item.classOfService = document.getElementById('itemClassOfService').value;
                saveData();
                renderBacklog();
            }
        }

        function deleteBacklogItem(itemId) {
            if (confirm('Are you sure you want to delete this backlog item?')) {
                appState.backlogItems = appState.backlogItems.filter(i => i.id !== itemId);
                saveData();
                renderBacklog();
            }
        }

        // Team management
        function renderTeam() {
            const container = document.getElementById('teamGrid');
            container.innerHTML = appState.teamMembers.map(member => `
                <div class="team-member">
                    <div class="member-avatar" style="background: ${member.color}">
                        ${member.avatar}
                    </div>
                    <div class="member-name">${member.name}</div>
                    <div class="member-role">${member.role.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                    ${canManageTeam() ? `
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-warning" onclick="editMember(${member.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteMember(${member.id})">Delete</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function showAddMemberModal() {
            document.getElementById('addMemberModal').style.display = 'block';
        }

        function addMember(name, role) {
            const newMember = {
                id: Date.now(),
                name,
                role,
                avatar: name.charAt(0).toUpperCase(),
                color: `#${Math.floor(Math.random()*16777215).toString(16)}`
            };
            
            appState.teamMembers.push(newMember);
            saveData();
            renderTeam();
        }

        function canManageTeam() {
            const currentMember = appState.teamMembers.find(m => m.name === appState.currentUser);
            return currentMember && (currentMember.role === 'admin' || currentMember.role === 'project-manager');
        }

        function editMember(memberId) {
            const member = appState.teamMembers.find(m => m.id === memberId);
            if (member) {
                document.getElementById('memberName').value = member.name;
                document.getElementById('memberRole').value = member.role;
                
                const form = document.getElementById('addMemberForm');
                form.onsubmit = function(e) {
                    e.preventDefault();
                    updateMember(memberId);
                    closeModal('addMemberModal');
                    form.onsubmit = handleAddMember;
                };
                
                document.querySelector('#addMemberModal h2').textContent = 'Edit Team Member';
                document.getElementById('addMemberModal').style.display = 'block';
            }
        }

        function updateMember(memberId) {
            const member = appState.teamMembers.find(m => m.id === memberId);
            if (member) {
                member.name = document.getElementById('memberName').value;
                member.role = document.getElementById('memberRole').value;
                member.avatar = member.name.charAt(0).toUpperCase();
                saveData();
                renderTeam();
                updateCurrentAvatar(); // In case current user was updated
            }
        }

        function deleteMember(memberId) {
            if (confirm('Are you sure you want to delete this team member?')) {
                appState.teamMembers = appState.teamMembers.filter(m => m.id !== memberId);
                saveData();
                renderTeam();
            }
        }

        // Metrics
        function renderMetrics() {
            calculateAndDisplayMetrics();
            renderCumulativeFlowChart();
        }

        function calculateAndDisplayMetrics() {
            // Calculate flow efficiency
            const completedCards = appState.cards.filter(card => card.column === 'Done');
            let totalCycleTime = 0;
            let totalActiveTime = 0;
            
            completedCards.forEach(card => {
                const cycleTime = card.movedAt ? 
                    (new Date(card.movedAt) - new Date(card.createdAt)) / (1000 * 60 * 60 * 24) : 
                    (new Date() - new Date(card.createdAt)) / (1000 * 60 * 60 * 24);
                totalCycleTime += cycleTime;
                totalActiveTime += cycleTime * 0.6; // Assume 60% active time (simplified)
            });
            
            const flowEfficiency = completedCards.length > 0 ? 
                Math.round((totalActiveTime / totalCycleTime) * 100) : 0;
            
            const avgCycleTime = completedCards.length > 0 ? 
                (totalCycleTime / completedCards.length).toFixed(1) : 0;
                
            // Count items completed in the last 7 days
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const throughput = completedCards.filter(card => 
                card.movedAt && new Date(card.movedAt) > weekAgo
            ).length;
            
            document.getElementById('flowEfficiencyValue').textContent = `${flowEfficiency}%`;
            document.getElementById('cycleTimeValue').textContent = `${avgCycleTime} days`;
            document.getElementById('throughputValue').textContent = `${throughput} items`;
        }

        function renderCumulativeFlowChart() {
            const ctx = document.getElementById('cumulativeFlowChart').getContext('2d');
            
            // Prepare data
            const labels = appState.dailySnapshots.map(snapshot => snapshot.date);
            const datasets = [];
            
            const columns = ['Done', 'In Progress', 'To Do', 'Backlog'];
            const colors = ['#28a745', '#ffc107', '#007bff', '#6c757d'];
            
            columns.forEach((column, index) => {
                datasets.push({
                    label: column,
                    data: appState.dailySnapshots.map(snapshot => snapshot[column] || 0),
                    backgroundColor: colors[index],
                    borderColor: colors[index],
                    fill: true
                });
            });
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cumulative Flow Diagram'
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    elements: {
                        line: {
                            fill: true
                        }
                    }
                }
            });
        }

        // Reviews page functionality
       function showReviewTab(tabName) {
            // Hide all review tabs
            document.querySelectorAll('.review-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.review-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            if (tabName === 'experiments') {
                document.getElementById('experiments').classList.add('active');
                document.getElementById('experimentsTab').classList.add('active');
            } else {
                document.getElementById(tabName + 'Review').classList.add('active');
                document.getElementById(tabName + 'ReviewTab').classList.add('active');
            }
        }


        // Service Review Functions
        function renderServiceReviews() {
            const container = document.getElementById('serviceReviewsList');
            if (!container) return;
            
            const reviews = appState.serviceSortDesc 
                ? appState.serviceReviews.sort((a, b) => new Date(b.date) - new Date(a.date))  // Newest first
                : appState.serviceReviews.sort((a, b) => new Date(a.date) - new Date(b.date)); // Oldest first
            
            container.innerHTML = reviews.map(review => `
                <div class="review-item service-review">
                    <div class="review-item-header">
                        <div>
                            <div class="review-item-title">${review.title}</div>
                            <div class="review-item-attendees"><strong>Attendees:</strong> ${review.attendees}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                            <div class="review-item-date">${new Date(review.date).toLocaleDateString()}</div>
                            <div class="review-item-actions">
                                <button class="icon-btn edit" onclick="editServiceReview(${review.id})" title="Edit">✏️</button>
                                <button class="icon-btn delete" onclick="deleteServiceReview(${review.id})" title="Delete">🗑️</button>
                            </div>
                        </div>
                    </div>
                    <div class="review-item-content">${review.content}</div>
                    ${review.outcomes ? `<div class="review-item-outcomes"><strong>Key Outcomes:</strong><br>${review.outcomes}</div>` : ''}
                </div>
            `).join('');
            
            // Render trash
            const trashContainer = document.getElementById('serviceTrashList');
            if (trashContainer) {
                trashContainer.innerHTML = appState.serviceReviewsTrash.map(review => `
                    <div class="review-item trash-item">
                        <div class="review-item-header">
                            <div>
                                <div class="review-item-title">${review.title}</div>
                                <div class="review-item-attendees"><strong>Attendees:</strong> ${review.attendees}</div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                                <div class="review-item-date">${new Date(review.date).toLocaleDateString()}</div>
                                <div class="review-item-actions">
                                    <button class="btn btn-primary restore-btn" onclick="restoreServiceReview(${review.id})">Restore</button>
                                </div>
                            </div>
                        </div>
                        <div class="review-item-content">${review.content}</div>
                        ${review.outcomes ? `<div class="review-item-outcomes"><strong>Key Outcomes:</strong><br>${review.outcomes}</div>` : ''}
                    </div>
                `).join('');
            }
        }

        function showAddServiceReviewModal() {
            // Clear the form first
            document.getElementById('addServiceReviewForm').reset();
            
            // Set default date to today
            document.getElementById('serviceReviewDate').value = getTodayDate();
            
            // Clear attendees field specifically
            document.getElementById('serviceReviewAttendees').value = '';
            
            // Clear text areas specifically
            document.getElementById('serviceReviewContent').value = '';
            document.getElementById('serviceReviewOutcomes').value = '';
            
            document.getElementById('addServiceReviewModal').style.display = 'block';
        }

        function addServiceReview(title, date, attendees, content, outcomes) {
            const newReview = {
                id: Date.now(),
                title,
                date,
                attendees,
                content,
                outcomes,
                createdAt: new Date()
            };
            
            appState.serviceReviews.push(newReview);
            saveData();
            renderServiceReviews();
        }

      function editServiceReview(reviewId) {
            const review = appState.serviceReviews.find(r => r.id === reviewId);
            if (review) {
                document.getElementById('editServiceReviewId').value = reviewId;
                document.getElementById('editServiceReviewTitle').value = review.title;
                document.getElementById('editServiceReviewDate').value = review.date;
                document.getElementById('editServiceReviewAttendees').value = review.attendees;
                document.getElementById('editServiceReviewContent').value = review.content;
                document.getElementById('editServiceReviewOutcomes').value = review.outcomes || '';
                
                document.getElementById('editServiceReviewModal').style.display = 'block';
            }
        }
        

        function updateServiceReview(reviewId) {
            const review = appState.serviceReviews.find(r => r.id === reviewId);
            if (review) {
                review.title = document.getElementById('serviceReviewTitle').value;
                review.date = document.getElementById('serviceReviewDate').value;
                review.attendees = document.getElementById('serviceReviewAttendees').value;
                review.content = document.getElementById('serviceReviewContent').value;
                review.outcomes = document.getElementById('serviceReviewOutcomes').value;
                saveData();
                renderServiceReviews();
            }
        }

        function deleteServiceReview(reviewId) {
            const review = appState.serviceReviews.find(r => r.id === reviewId);
            if (review && confirm('Are you sure you want to delete this service review?')) {
                appState.serviceReviews = appState.serviceReviews.filter(r => r.id !== reviewId);
                appState.serviceReviewsTrash.push(review);
                saveData();
                renderServiceReviews();
            }
        }

        function restoreServiceReview(reviewId) {
            const review = appState.serviceReviewsTrash.find(r => r.id === reviewId);
            if (review) {
                appState.serviceReviewsTrash = appState.serviceReviewsTrash.filter(r => r.id !== reviewId);
                appState.serviceReviews.push(review);
                saveData();
                renderServiceReviews();
            }
        }

        function toggleServiceSort() {
            appState.serviceSortDesc = !appState.serviceSortDesc;
            const sortBtn = document.getElementById('serviceSort');
            sortBtn.textContent = appState.serviceSortDesc ? 'Newest First' : 'Oldest First';
            saveData();
            renderServiceReviews();
        }

        function toggleServiceTrash() {
            const trashSection = document.getElementById('serviceTrashSection');
            const isVisible = trashSection.style.display !== 'none';
            trashSection.style.display = isVisible ? 'none' : 'block';
        }


        // Modal management
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';

    // Close attendee modal if it's open
    if (document.getElementById('attendeeModal').style.display === 'block') {
        closeAttendeeModal();
    }
    
    // Reset editing state
    editingItemId = null;
    editingColumnName = null;
    window.editingCardId = null; // Clear card editing state

    // Reset form states and visual elements
    if (modalId === 'addCardModal') {
        // Reset modal title and button text
        document.querySelector('#addCardModal .modal-header h2').textContent = 'Add New Card';
        document.querySelector('#addCardModal .modal-header h2').style.color = '';
        document.querySelector('#addCardModal button[type="submit"]').textContent = 'Add Card';
    }
    
    // Reset visual elements only if they weren't already reset by the update function
    document.getElementById('addCardForm').reset();
    document.getElementById('addItemForm').reset();
    document.getElementById('addMemberForm').reset();
    document.getElementById('columnPolicyForm')?.reset();
    document.getElementById('commonPolicyForm')?.reset();
    document.getElementById('experimentPolicyForm')?.reset();
    
    document.querySelector('#addItemModal h2').textContent = 'Add Backlog Item';
    document.querySelector('#addMemberModal h2').textContent = 'Add Team Member';
    
    // Reset button text
    const addItemButton = document.querySelector('#addItemForm button[type="submit"]');
    if (addItemButton) addItemButton.textContent = 'Add Item';
    
    // Clear forms
    if (document.getElementById('columnPolicyForm')) {
        document.getElementById('columnPolicyForm').reset();
    }
    if (document.getElementById('commonPolicyForm')) {
        document.getElementById('commonPolicyForm').reset();
    }

    // Handle experiment modals
    if (modalId === 'addExperimentModal') {
        document.getElementById('addExperimentForm').reset();
    } else if (modalId === 'editExperimentModal') {
        document.getElementById('editExperimentForm').reset();
    }
}

        // Admin functions
        function showBoardConfigModal() {
            document.getElementById('boardColumns').value = JSON.stringify(appState.boardConfig, null, 2);
            document.getElementById('boardConfigModal').style.display = 'block';
        }

        function saveBoardConfig() {
            try {
                const newConfig = JSON.parse(document.getElementById('boardColumns').value);
                
                // Update the board configuration
                appState.boardConfig = newConfig;
                
                // Save to localStorage
                saveData();
                
                // REFRESH THE BOARD IMMEDIATELY
                renderKanbanBoard();
                
                // Update dropdowns and other UI elements that depend on board config
                if (document.getElementById('cardColumn')) {
                    populateColumnSelect();
                }
                
                alert('Board configuration saved successfully!');
                closeModal('boardConfigModal');
                
            } catch (error) {
                alert('Invalid JSON format. Please check your configuration.');
                console.error('Config parse error:', error);
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(appState, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'kanban-data.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                localStorage.removeItem('kanbanAppState');
                location.reload();
            }
        }


        // Operations Review Functions
        function renderOperationsReviews() {
            const container = document.getElementById('operationsReviewsList');
            if (!container) return;
            
            const reviews = appState.operationsSortDesc 
                ? appState.operationsReviews.sort((a, b) => new Date(b.date) - new Date(a.date))  // Newest first
                : appState.operationsReviews.sort((a, b) => new Date(a.date) - new Date(b.date)); // Oldest first
                
            container.innerHTML = reviews.map(review => `
                <div class="review-item operations-review">
                    <div class="review-item-header">
                        <div>
                            <div class="review-item-title">${review.title}</div>
                            <div class="review-item-attendees"><strong>Attendees:</strong> ${review.attendees}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                            <div class="review-item-date">${new Date(review.date).toLocaleDateString()}</div>
                            <div class="review-item-actions">
                                <button class="icon-btn edit" onclick="editOperationsReview(${review.id})" title="Edit">✏️</button>
                                <button class="icon-btn delete" onclick="deleteOperationsReview(${review.id})" title="Delete">🗑️</button>
                            </div>
                        </div>
                    </div>
                    <div class="review-item-content">${review.content}</div>
                    ${review.outcomes ? `<div class="review-item-outcomes"><strong>Key Outcomes:</strong><br>${review.outcomes}</div>` : ''}
                </div>
            `).join('');
            
            // Render trash
            const trashContainer = document.getElementById('operationsTrashList');
            if (trashContainer) {
                trashContainer.innerHTML = appState.operationsReviewsTrash.map(review => `
                    <div class="review-item trash-item">
                        <div class="review-item-header">
                            <div>
                                <div class="review-item-title">${review.title}</div>
                                <div class="review-item-attendees"><strong>Attendees:</strong> ${review.attendees}</div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                                <div class="review-item-date">${new Date(review.date).toLocaleDateString()}</div>
                                <div class="review-item-actions">
                                    <button class="btn btn-primary restore-btn" onclick="restoreOperationsReview(${review.id})">Restore</button>
                                </div>
                            </div>
                        </div>
                        <div class="review-item-content">${review.content}</div>
                        ${review.outcomes ? `<div class="review-item-outcomes"><strong>Key Outcomes:</strong><br>${review.outcomes}</div>` : ''}
                    </div>
                `).join('');
            }
        }

        function toggleServiceSort() {
            appState.serviceSortDesc = !appState.serviceSortDesc;
            const sortBtn = document.getElementById('serviceSort');
            sortBtn.textContent = appState.serviceSortDesc ? 'Newest First' : 'Oldest First';
            saveData();
            renderServiceReviews();
        }

        function toggleOperationsSort() {
            appState.operationsSortDesc = !appState.operationsSortDesc;
            const sortBtn = document.getElementById('operationsSort');
            sortBtn.textContent = appState.operationsSortDesc ? 'Newest First' : 'Oldest First';
            saveData();
            renderOperationsReviews();
        }

        function showAddOperationsReviewModal() {
            // Clear the form first
            document.getElementById('addOperationsReviewForm').reset();
            
            // Set default date to today
            document.getElementById('operationsReviewDate').value = getTodayDate();
            
            // Clear attendees field specifically
            document.getElementById('operationsReviewAttendees').value = '';
            
            // Clear text areas specifically
            document.getElementById('operationsReviewContent').value = '';
            document.getElementById('operationsReviewOutcomes').value = '';
            
            document.getElementById('addOperationsReviewModal').style.display = 'block';
        }

        function addOperationsReview(title, date, attendees, content, outcomes) {
            const newReview = {
                id: Date.now(),
                title,
                date,
                attendees,
                content,
                outcomes,
                createdAt: new Date()
            };
            
            appState.operationsReviews.push(newReview);
            saveData();
            renderOperationsReviews();
        }

        function editOperationsReview(reviewId) {
            const review = appState.operationsReviews.find(r => r.id === reviewId);
            if (review) {
                document.getElementById('editOperationsReviewId').value = reviewId;
                document.getElementById('editOperationsReviewTitle').value = review.title;
                document.getElementById('editOperationsReviewDate').value = review.date;
                document.getElementById('editOperationsReviewAttendees').value = review.attendees;
                document.getElementById('editOperationsReviewContent').value = review.content;
                document.getElementById('editOperationsReviewOutcomes').value = review.outcomes || '';
                
                document.getElementById('editOperationsReviewModal').style.display = 'block';
            }
        }

        function updateOperationsReview(reviewId) {
            const review = appState.operationsReviews.find(r => r.id === reviewId);
            if (review) {
                review.title = document.getElementById('operationsReviewTitle').value;
                review.date = document.getElementById('operationsReviewDate').value;
                review.attendees = document.getElementById('operationsReviewAttendees').value;
                review.content = document.getElementById('operationsReviewContent').value;
                review.outcomes = document.getElementById('operationsReviewOutcomes').value;
                saveData();
                renderOperationsReviews();
            }
        }

        function handleEditServiceReview(e) {
            e.preventDefault();
            const reviewId = parseInt(document.getElementById('editServiceReviewId').value);
            const review = appState.serviceReviews.find(r => r.id === reviewId);
            
            if (review) {
                review.title = document.getElementById('editServiceReviewTitle').value;
                review.date = document.getElementById('editServiceReviewDate').value;
                review.attendees = document.getElementById('editServiceReviewAttendees').value;
                review.content = document.getElementById('editServiceReviewContent').value;
                review.outcomes = document.getElementById('editServiceReviewOutcomes').value;
                
                saveData();
                renderServiceReviews();
            }
            
            closeModal('editServiceReviewModal');
        }

        function handleEditOperationsReview(e) {
            e.preventDefault();
            const reviewId = parseInt(document.getElementById('editOperationsReviewId').value);
            const review = appState.operationsReviews.find(r => r.id === reviewId);
            
            if (review) {
                review.title = document.getElementById('editOperationsReviewTitle').value;
                review.date = document.getElementById('editOperationsReviewDate').value;
                review.attendees = document.getElementById('editOperationsReviewAttendees').value;
                review.content = document.getElementById('editOperationsReviewContent').value;
                review.outcomes = document.getElementById('editOperationsReviewOutcomes').value;
                
                saveData();
                renderOperationsReviews();
            }
            
            closeModal('editOperationsReviewModal');
        }


        function deleteOperationsReview(reviewId) {
            const review = appState.operationsReviews.find(r => r.id === reviewId);
            if (review && confirm('Are you sure you want to delete this operations review?')) {
                appState.operationsReviews = appState.operationsReviews.filter(r => r.id !== reviewId);
                appState.operationsReviewsTrash.push(review);
                saveData();
                renderOperationsReviews();
            }
        }

        function restoreOperationsReview(reviewId) {
            const review = appState.operationsReviewsTrash.find(r => r.id === reviewId);
            if (review) {
                appState.operationsReviewsTrash = appState.operationsReviewsTrash.filter(r => r.id !== reviewId);
                appState.operationsReviews.push(review);
                saveData();
                renderOperationsReviews();
            }
        }

        function toggleOperationsSort() {
            appState.operationsSortDesc = !appState.operationsSortDesc;
            const sortBtn = document.getElementById('operationsSort');
            sortBtn.textContent = appState.operationsSortDesc ? 'Newest First' : 'Oldest First';
            saveData();
            renderOperationsReviews();
        }

        function toggleOperationsTrash() {
            const trashSection = document.getElementById('operationsTrashSection');
            const isVisible = trashSection.style.display !== 'none';
            trashSection.style.display = isVisible ? 'none' : 'block';
        }


        // Attendee Selection Functions
        let currentAttendeeField = null;
        let selectedAttendees = [];

       function openAttendeeModal(reviewType) {
            currentAttendeeField = reviewType;
            renderAttendeeList();
            
            // Get the correct attendees field based on review type
            let attendeesField;
            if (reviewType === 'serviceReview') {
                attendeesField = document.getElementById('serviceReviewAttendees');
            } else if (reviewType === 'operationsReview') {
                attendeesField = document.getElementById('operationsReviewAttendees');
            } else if (reviewType === 'editServiceReview') {
                attendeesField = document.getElementById('editServiceReviewAttendees');
            } else if (reviewType === 'editOperationsReview') {
                attendeesField = document.getElementById('editOperationsReviewAttendees');
            }
            
            // Pre-populate with existing attendees if editing
            if (attendeesField && attendeesField.value) {
                const existingAttendees = attendeesField.value.split(', ');
                selectedAttendees = [...existingAttendees];
                updateAttendeeCheckboxes();
            } else {
                selectedAttendees = [];
            }
            
            document.getElementById('additionalAttendees').value = '';
            document.getElementById('attendeeModal').style.display = 'block';
        }

        function renderAttendeeList() {
            const container = document.getElementById('attendeeList');
            container.innerHTML = appState.teamMembers.map(member => `
                <div class="attendee-item">
                    <input type="checkbox" id="attendee_${member.id}" value="${member.name}" onchange="toggleAttendee('${member.name}')">
                    <div class="member-avatar" style="background: ${member.color}; width: 30px; height: 30px; font-size: 0.8rem;">
                        ${member.avatar}
                    </div>
                    <div>
                        <div style="font-weight: bold;">${member.name}</div>
                        <div style="font-size: 0.8rem; color: #666;">${member.role}</div>
                    </div>
                </div>
            `).join('');
        }

        function updateAttendeeCheckboxes() {
            appState.teamMembers.forEach(member => {
                const checkbox = document.getElementById(`attendee_${member.id}`);
                if (checkbox) {
                    checkbox.checked = selectedAttendees.includes(member.name);
                }
            });
        }

        function toggleAttendee(memberName) {
            const index = selectedAttendees.indexOf(memberName);
            if (index > -1) {
                selectedAttendees.splice(index, 1);
            } else {
                selectedAttendees.push(memberName);
            }
        }

        function toggleSelectAll() {
            const allSelected = selectedAttendees.length === appState.teamMembers.length;
            
            if (allSelected) {
                selectedAttendees = [];
                document.querySelector('.select-all-btn').textContent = 'Select All';
            } else {
                selectedAttendees = appState.teamMembers.map(member => member.name);
                document.querySelector('.select-all-btn').textContent = 'Deselect All';
            }
            
            updateAttendeeCheckboxes();
        }

        function confirmAttendees() {
            // Get additional attendees
            const additionalText = document.getElementById('additionalAttendees').value.trim();
            const additionalAttendees = additionalText ? 
                additionalText.split('\n').map(name => name.trim()).filter(name => name.length > 0) : [];
            
            // Combine team members and additional attendees
            const allAttendees = [...selectedAttendees, ...additionalAttendees];
            
            // Update the appropriate field based on review type
            let attendeesField;
            if (currentAttendeeField === 'serviceReview') {
                attendeesField = document.getElementById('serviceReviewAttendees');
            } else if (currentAttendeeField === 'operationsReview') {
                attendeesField = document.getElementById('operationsReviewAttendees');
            } else if (currentAttendeeField === 'editServiceReview') {
                attendeesField = document.getElementById('editServiceReviewAttendees');
            } else if (currentAttendeeField === 'editOperationsReview') {
                attendeesField = document.getElementById('editOperationsReviewAttendees');
            }
            
            if (attendeesField) {
                attendeesField.value = allAttendees.join(', ');
            }
            
            closeAttendeeModal();
        }

        function closeAttendeeModal() {
            document.getElementById('attendeeModal').style.display = 'none';
            currentAttendeeField = null;
            selectedAttendees = [];
        }

        // Helper function to get today's date in YYYY-MM-DD format
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

function initSortableForElement(element) {
    if (!element || element.classList.contains('sortable-initialized')) return;
    
    element.classList.add('sortable-initialized');
    element.sortable = new Sortable(element, {
        group: 'kanban',
        animation: 150,
        ghostClass: 'card-ghost',
        chosenClass: 'card-chosen',
        onEnd: function(evt) {
            const cardId = parseInt(evt.item.dataset.cardId);
            const targetElement = evt.to;
            const sourceElement = evt.from;
            
            // Check if we're reordering within the same container
            if (targetElement === sourceElement) {
                // Handle reordering within same sub-column
                updateCardPosition(cardId, evt.newIndex);
                saveData();
                return;
            }
            
            // Handle moving between different containers
            const targetInfo = getTargetLocationInfo(targetElement);
            if (targetInfo) {
                moveCard(cardId, targetInfo.column, targetInfo.subColumn, evt.newIndex, targetInfo.isBuffer);
            }
        }
    });
}
        function getTargetLocationInfo(targetElement) {
            // Find the column this element belongs to
            const columnElement = targetElement.closest('[data-column]');
            if (!columnElement) return null;
            
            const column = columnElement.dataset.column;
            
            // Check if it's a buffer column
            const bufferElement = targetElement.closest('[data-sub-column]');
            if (bufferElement) {
                const subColumn = bufferElement.dataset.subColumn;
                const isBuffer = bufferElement.classList.contains('buffer-column') || 
                                bufferElement.querySelector('.buffer-content') === targetElement;
                
                return {
                    column: column,
                    subColumn: subColumn,
                    isBuffer: isBuffer,
                    position: null
                };
            }
            
            // Check if it's a regular sub-column
            const subColElement = targetElement.closest('.sub-column');
            if (subColElement) {
                const subColumn = subColElement.dataset.subColumn;
                return {
                    column: column,
                    subColumn: subColumn,
                    isBuffer: false,
                    position: null
                };
            }
            
            // It's a plain column
            return {
                column: column,
                subColumn: null,
                isBuffer: false,
                position: null
            };
        }


        // Updated experiment management functions
        function showAddExperimentModal() {
            populateExperimentOwnerSelect('experimentOwner');
            // Reset form
            document.getElementById('addExperimentForm').reset();
            document.getElementById('addExperimentModal').style.display = 'block';
        }

        function populateExperimentOwnerSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = appState.teamMembers.map(member => 
                `<option value="${member.name}">${member.name}</option>`
            ).join('');
        }

        function editExperiment(experimentId) {
            const experiment = appState.experiments.find(exp => exp.id === experimentId);
            if (experiment) {
                // Populate edit form fields
                document.getElementById('editExperimentId').value = experimentId;
                document.getElementById('editExperimentTitle').value = experiment.title;
                document.getElementById('editExperimentDescription').value = experiment.description;
                document.getElementById('editExperimentImpact').value = experiment.impact;
                document.getElementById('editExperimentImplementation').value = experiment.implementation;
                document.getElementById('editExperimentStatus').value = experiment.status;
                
                // Populate owner select and set current owner
                populateExperimentOwnerSelect('editExperimentOwner');
                document.getElementById('editExperimentOwner').value = experiment.owner;
                
                document.getElementById('editExperimentModal').style.display = 'block';
            }
        }

        function updateExperiment(experimentId) {
            const experiment = appState.experiments.find(exp => exp.id === experimentId);
            if (experiment) {
                experiment.title = document.getElementById('editExperimentTitle').value;
                experiment.description = document.getElementById('editExperimentDescription').value;
                experiment.impact = document.getElementById('editExperimentImpact').value;
                experiment.implementation = document.getElementById('editExperimentImplementation').value;
                experiment.status = document.getElementById('editExperimentStatus').value;
                experiment.owner = document.getElementById('editExperimentOwner').value;
                
                saveData();
                refreshCurrentExperimentView();
            }
        }

        function deleteExperiment(experimentId) {
            const experiment = appState.experiments.find(exp => exp.id === experimentId);
            if (experiment) {
                // Populate the confirmation modal with experiment details
                const experimentDetails = document.getElementById('experimentToDelete');
                experimentDetails.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">${experiment.title}</div>
                    <div style="color: #666; margin-bottom: 0.5rem;">${experiment.description}</div>
                    <div style="display: flex; gap: 1rem; font-size: 0.9rem;">
                        <span class="priority-badge impact-${experiment.impact}">
                            ${experiment.impact.toUpperCase()} Impact
                        </span>
                        <span class="priority-badge implementation-${experiment.implementation}">
                            ${experiment.implementation.toUpperCase()} to Implement
                        </span>
                        <span style="color: #666;">Owner: ${experiment.owner}</span>
                    </div>
                `;
                
                // Set up the confirm button
                const confirmBtn = document.getElementById('confirmDeleteExperimentBtn');
                confirmBtn.onclick = function() {
                    confirmDeleteExperiment(experimentId);
                };
                
                document.getElementById('deleteExperimentModal').style.display = 'block';
            }
        }

        function confirmDeleteExperiment(experimentId) {
            appState.experiments = appState.experiments.filter(exp => exp.id !== experimentId);
            saveData();
            refreshCurrentExperimentView();
            closeModal('deleteExperimentModal');
        }

        // Helper function to refresh current view
        function refreshCurrentExperimentView() {
            const currentView = document.querySelector('.experiment-view.active');
            if (currentView && currentView.id === 'experimentBoardView') {
                renderExperimentBoard();
            } else if (currentView && currentView.id === 'experimentPrioritizeView') {
                renderExperimentMatrix();
            }
        }

        // Form handlers
        function handleAddExperiment(e) {
            e.preventDefault();
            const title = document.getElementById('experimentTitle').value;
            const description = document.getElementById('experimentDescription').value;
            const impact = document.getElementById('experimentImpact').value;
            const implementation = document.getElementById('experimentImplementation').value;
            const status = document.getElementById('experimentStatus').value;
            const owner = document.getElementById('experimentOwner').value;
            
            addExperiment(title, description, impact, implementation, status, owner);
            closeModal('addExperimentModal');
        }

        function handleEditExperiment(e) {
            e.preventDefault();
            const experimentId = parseInt(document.getElementById('editExperimentId').value);
            updateExperiment(experimentId);
            closeModal('editExperimentModal');
        }

        // Enhanced closeModal function for experiments
        function closeExperimentModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // Reset forms
            if (modalId === 'addExperimentModal') {
                document.getElementById('addExperimentForm').reset();
            } else if (modalId === 'editExperimentModal') {
                document.getElementById('editExperimentForm').reset();
            }
        }



        // Add to appState
        appState.experiments = [];

        // Generate sample experiments
        function generateSampleExperiments() {
            if (appState.experiments.length === 0) {
                appState.experiments = [
                    {
                        id: 1,
                        title: 'Pair Programming',
                        description: 'Try pair programming for complex tasks to improve code quality',
                        impact: 'high',
                        implementation: 'easy',
                        status: 'Ideas',
                        owner: 'John Developer',
                        createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000)
                    },
                    {
                        id: 2,
                        title: 'Daily Customer Check-ins',
                        description: 'Weekly calls with key customers to gather feedback',
                        impact: 'high',
                        implementation: 'hard',
                        status: 'In Progress',
                        owner: 'Admin User',
                        createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
                    },
                    {
                        id: 3,
                        title: 'Cross-training QA',
                        description: 'Developers trained on testing - 40% improvement in bug detection',
                        impact: 'high',
                        implementation: 'easy',
                        status: 'Done',
                        owner: 'Sarah Tester',
                        createdAt: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000)
                    },
                    {
                        id: 4,
                        title: 'Automated Code Formatting',
                        description: 'Set up prettier and eslint for consistent code style',
                        impact: 'low',
                        implementation: 'easy',
                        status: 'Ideas',
                        owner: 'Mike Designer',
                        createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000)
                    }
                ];
            }
        }

        // Experiment view management
        // Updated experiment view management
        function showExperimentView(view) {
            // Hide all views
            document.querySelectorAll('.experiment-view').forEach(v => {
                v.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.experiment-view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected view
            if (view === 'prioritize') {
                document.getElementById('experimentPrioritizeView').classList.add('active');
                document.getElementById('prioritizeViewBtn').classList.add('active');
                renderExperimentMatrix();
            } else if (view === 'board') {
                document.getElementById('experimentBoardView').classList.add('active');
                document.getElementById('boardViewBtn').classList.add('active');
                renderExperimentBoard();
            }
        }

        // Render experiment board
function renderExperimentBoard() {
    const statuses = ['Ideas', 'In Progress', 'Done']; 
    
    statuses.forEach(status => {
        const columnId = status.toLowerCase().replace(' ', '-') + '-column';
        const column = document.getElementById(columnId);
        
        // Fix the count ID mapping
        let countId;
        if (status === 'In Progress') {
            countId = 'inProgressCount'; // This should match the HTML ID
        } else if (status === 'Ideas') {
            countId = 'ideasCount';
        } else if (status === 'Done') {
            countId = 'doneCount';
        }
        
        if (column) {
            const experimentsInStatus = appState.experiments.filter(exp => exp.status === status);
            
            column.innerHTML = experimentsInStatus.map(exp => renderExperimentCard(exp)).join('');
            
            // Update count
            const countElement = document.getElementById(countId);
            if (countElement) {
                countElement.textContent = experimentsInStatus.length;
                countElement.classList.remove('ok');
                countElement.classList.add('ok'); // Ensure the styling is consistent
            }
        }
    });
    
    // Initialize drag and drop
    initializeExperimentDragAndDrop();
}

        // Render experiment card
        function renderExperimentCard(experiment) {
            const impactClass = experiment.impact === 'high' ? 'high-impact' : 'low-impact';
            const implementationClass = experiment.implementation === 'easy' ? 'easy-implementation' : 'hard-implementation';
            
            return `
                <div class="experiment-card ${impactClass} ${implementationClass}" data-experiment-id="${experiment.id}">
                    <div class="experiment-priority-badges">
                        <span class="priority-badge impact-${experiment.impact}">
                            ${experiment.impact.toUpperCase()} Impact
                        </span>
                        <span class="priority-badge implementation-${experiment.implementation}">
                            ${experiment.implementation.toUpperCase()} to Implement
                        </span>
                    </div>
                    <div class="card-title">${experiment.title}</div>
                    <div class="card-description">${experiment.description}</div>
                    <div class="card-assignee">👤 Owner: ${experiment.owner}</div>
                    <div class="card-actions">
                        <button class="icon-btn edit" onclick="editExperiment(${experiment.id})" title="Edit">✏️</button>
                        <button class="icon-btn delete" onclick="deleteExperiment(${experiment.id})" title="Delete">🗑️</button>
                    </div>
                </div>
            `;
        }

        // Render experiment matrix
        function renderExperimentMatrix() {
            const quadrants = [
                { id: 'high-impact-easy', impact: 'high', implementation: 'easy' },
                { id: 'high-impact-hard', impact: 'high', implementation: 'hard' },
                { id: 'low-impact-easy', impact: 'low', implementation: 'easy' },
                { id: 'low-impact-hard', impact: 'low', implementation: 'hard' }
            ];
            
            quadrants.forEach(quadrant => {
                const quadrantElement = document.getElementById(quadrant.id);
                if (quadrantElement) {
                    const content = quadrantElement.querySelector('.quadrant-content');
                    const experimentsInQuadrant = appState.experiments.filter(exp => 
                        exp.impact === quadrant.impact && exp.implementation === quadrant.implementation
                    );
                    
                    content.innerHTML = experimentsInQuadrant.map(exp => renderMatrixExperimentCard(exp)).join('');
                }
            });
            
            // Initialize drag and drop for matrix
            initializeMatrixDragAndDrop();
        }

        // Render matrix experiment card
        function renderMatrixExperimentCard(experiment) {
            return `
                <div class="matrix-experiment-card" data-experiment-id="${experiment.id}">
                    <div class="card-title">${experiment.title}</div>
                    <div class="card-description">${experiment.description}</div>
                    <div class="card-assignee">👤 ${experiment.owner}</div>
                    <div class="card-actions" style="margin-top: 0.5rem;">
                        <button class="icon-btn edit" onclick="editExperiment(${experiment.id})" title="Edit">✏️</button>
                        <button class="icon-btn delete" onclick="deleteExperiment(${experiment.id})" title="Delete">🗑️</button>
                    </div>
                </div>
            `;
        }

        // Add this to ensure prioritize view is shown by default when experiments tab loads
        function initializeExperimentsTab() {
            // Default to prioritize view
            showExperimentView('prioritize');
        }

        // Initialize drag and drop for experiment board
        function initializeExperimentDragAndDrop() {
            const columns = ['ideas-column', 'in-progress-column', 'done-column'];
            
            columns.forEach(columnId => {
                const column = document.getElementById(columnId);
                if (column) {
                    new Sortable(column, {
                        group: 'experiments',
                        animation: 150,
                        ghostClass: 'card-ghost',
                        chosenClass: 'card-chosen',
                        onEnd: function(evt) {
                            const experimentId = parseInt(evt.item.dataset.experimentId);
                            const newStatus = getStatusFromColumnId(evt.to.id);
                            moveExperiment(experimentId, newStatus);
                        }
                    });
                }
            });
        }

        // Initialize drag and drop for matrix
        function initializeMatrixDragAndDrop() {
            const quadrants = ['high-impact-easy', 'high-impact-hard', 'low-impact-easy', 'low-impact-hard'];
            
            quadrants.forEach(quadrantId => {
                const quadrant = document.getElementById(quadrantId);
                if (quadrant) {
                    const content = quadrant.querySelector('.quadrant-content');
                    new Sortable(content, {
                        group: 'matrix-experiments',
                        animation: 150,
                        ghostClass: 'card-ghost',
                        chosenClass: 'card-chosen',
                        onEnd: function(evt) {
                            const experimentId = parseInt(evt.item.dataset.experimentId);
                            const quadrant = evt.to.closest('.quadrant');
                            const { impact, implementation } = getQuadrantProperties(quadrant.id);
                            updateExperimentPriority(experimentId, impact, implementation);
                        }
                    });
                }
            });
        }

        // Helper functions
        function getStatusFromColumnId(columnId) {
            const statusMap = {
                'ideas-column': 'Ideas',
                'in-progress-column': 'In Progress',
                'done-column': 'Done'
            };
            return statusMap[columnId] || 'Ideas';
        }

        function getQuadrantProperties(quadrantId) {
            const quadrantMap = {
                'high-impact-easy': { impact: 'high', implementation: 'easy' },
                'high-impact-hard': { impact: 'high', implementation: 'hard' },
                'low-impact-easy': { impact: 'low', implementation: 'easy' },
                'low-impact-hard': { impact: 'low', implementation: 'hard' }
            };
            return quadrantMap[quadrantId] || { impact: 'low', implementation: 'hard' };
        }

        // Experiment management functions
        function showAddExperimentModal() {
            populateExperimentOwnerSelect();
            document.getElementById('addExperimentModal').style.display = 'block';
        }

        function populateExperimentOwnerSelect(selectId = 'experimentOwner') {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = appState.teamMembers.map(member => 
                    `<option value="${member.name}">${member.name}</option>`
                ).join('');
            }
        }
        function addExperiment(title, description, impact, implementation, status, owner) {
            const newExperiment = {
                id: Date.now(),
                title,
                description,
                impact,
                implementation,
                status,
                owner,
                createdAt: new Date()
            };
            
            appState.experiments.push(newExperiment);
            saveData();
            
            // Re-render current view
            const currentView = document.querySelector('.experiment-view.active');
            if (currentView && currentView.id === 'experimentBoardView') {
                renderExperimentBoard();
            } else if (currentView && currentView.id === 'experimentPrioritizeView') {
                renderExperimentMatrix();
            }
        }

        function moveExperiment(experimentId, newStatus) {
            const experiment = appState.experiments.find(exp => exp.id === experimentId);
            if (experiment && experiment.status !== newStatus) {
                experiment.status = newStatus;
                saveData();
                renderExperimentBoard();
            }
        }

        function updateExperimentPriority(experimentId, impact, implementation) {
            const experiment = appState.experiments.find(exp => exp.id === experimentId);
            if (experiment && (experiment.impact !== impact || experiment.implementation !== implementation)) {
                experiment.impact = impact;
                experiment.implementation = implementation;
                saveData();
                renderExperimentMatrix();
            }
        }

        function editExperiment(experimentId) {
            const experiment = appState.experiments.find(exp => exp.id === experimentId);
            if (experiment) {
                // Use EDIT form fields, not ADD form fields
                document.getElementById('editExperimentId').value = experimentId;
                document.getElementById('editExperimentTitle').value = experiment.title;
                document.getElementById('editExperimentDescription').value = experiment.description;
                document.getElementById('editExperimentImpact').value = experiment.impact;
                document.getElementById('editExperimentImplementation').value = experiment.implementation;
                document.getElementById('editExperimentStatus').value = experiment.status;
                
                // Populate owner select and set current owner
                populateExperimentOwnerSelect('editExperimentOwner');
                document.getElementById('editExperimentOwner').value = experiment.owner;
                
                // Show EDIT modal, not ADD modal
                document.getElementById('editExperimentModal').style.display = 'block';
            }
        }

        function updateExperiment(experimentId) {
            const experiment = appState.experiments.find(exp => exp.id === experimentId);
            if (experiment) {
                // Use EDIT form fields, not ADD form fields
                experiment.title = document.getElementById('editExperimentTitle').value;
                experiment.description = document.getElementById('editExperimentDescription').value;
                experiment.impact = document.getElementById('editExperimentImpact').value;
                experiment.implementation = document.getElementById('editExperimentImplementation').value;
                experiment.status = document.getElementById('editExperimentStatus').value;
                experiment.owner = document.getElementById('editExperimentOwner').value;
                
                saveData();
                refreshCurrentExperimentView();
            }
        }

        function deleteExperiment(experimentId) {
            if (confirm('Are you sure you want to delete this experiment?')) {
                appState.experiments = appState.experiments.filter(exp => exp.id !== experimentId);
                saveData();
                
                // Re-render current view
                const currentView = document.querySelector('.experiment-view.active');
                if (currentView && currentView.id === 'experimentBoardView') {
                    renderExperimentBoard();
                } else if (currentView && currentView.id === 'experimentPrioritizeView') {
                    renderExperimentMatrix();
                }
            }
        }

        // Form handler
        function handleAddExperiment(e) {
            e.preventDefault();
            const title = document.getElementById('experimentTitle').value;
            const description = document.getElementById('experimentDescription').value;
            const impact = document.getElementById('experimentImpact').value;
            const implementation = document.getElementById('experimentImplementation').value;
            const status = document.getElementById('experimentStatus').value;
            const owner = document.getElementById('experimentOwner').value;
            
            addExperiment(title, description, impact, implementation, status, owner);
            closeModal('addExperimentModal');
        }









        // Form handlers
function handleAddCard(e) {
    e.preventDefault();
    const title = document.getElementById('cardTitle').value;
    const description = document.getElementById('cardDescription').value;
    const assignee = document.getElementById('cardAssignee').value;
    const classOfService = document.getElementById('cardClassOfService').value;
    const column = document.getElementById('cardColumn').value;
    const subColumn = document.getElementById('cardSubColumn').value || null; // Allow null/empty sub-column
    
    // Check if we're editing an existing card
    if (window.editingCardId) {
        updateCard(window.editingCardId, title, description, assignee, classOfService, column, subColumn);
        window.editingCardId = null; // Clear the editing state
    } else {
        addCard(title, description, assignee, classOfService, column, subColumn);
    }
    
    closeModal('addCardModal');
}
        function handleAddItem(e) {
            e.preventDefault();
            const title = document.getElementById('itemTitle').value;
            const description = document.getElementById('itemDescription').value;
            const progress = document.getElementById('itemProgress').value;
            const priority = document.getElementById('itemPriority').value;
            const size = document.getElementById('itemSize').value;
            const classOfService = document.getElementById('itemClassOfService').value;
            
            if (editingItemId) {
                // Update existing item
                updateBacklogItem(editingItemId);
            } else {
                // Add new item
                addBacklogItem(title, description, progress, priority, size, classOfService);
            }
            
            closeModal('addItemModal');
        }

        function handleAddMember(e) {
            e.preventDefault();
            const name = document.getElementById('memberName').value;
            const role = document.getElementById('memberRole').value;
            
            addMember(name, role);
            closeModal('addMemberModal');
        }

        function handleBoardConfig(e) {
            e.preventDefault();
            saveBoardConfig();
        }

        function handleColumnPolicy(e) {
            e.preventDefault();
            saveColumnPolicies();
        }

        function handleCommonPolicy(e) {
            e.preventDefault();
            saveCommonPolicies();
        }


        function handleAddServiceReview(e) {
            e.preventDefault();
            const title = document.getElementById('serviceReviewTitle').value;
            const date = document.getElementById('serviceReviewDate').value;
            const attendees = document.getElementById('serviceReviewAttendees').value;
            const content = document.getElementById('serviceReviewContent').value;
            const outcomes = document.getElementById('serviceReviewOutcomes').value;
            
            addServiceReview(title, date, attendees, content, outcomes);
            closeModal('addServiceReviewModal');
        }

        function handleAddOperationsReview(e) {
            e.preventDefault();
            const title = document.getElementById('operationsReviewTitle').value;
            const date = document.getElementById('operationsReviewDate').value;
            const attendees = document.getElementById('operationsReviewAttendees').value;
            const content = document.getElementById('operationsReviewContent').value;
            const outcomes = document.getElementById('operationsReviewOutcomes').value;
            
            addOperationsReview(title, date, attendees, content, outcomes);
            closeModal('addOperationsReviewModal');
        }

        // Optional: Add this function to handle many cards in a quadrant
        function truncateQuadrantCards() {
            const quadrants = document.querySelectorAll('.quadrant-content');
            quadrants.forEach(quadrant => {
                const cards = quadrant.querySelectorAll('.matrix-experiment-card');
                const maxCards = 6; // Maximum cards to show without scrolling
                
                if (cards.length > maxCards) {
                    // Hide extra cards and show a "show more" indicator
                    cards.forEach((card, index) => {
                        if (index >= maxCards) {
                            card.style.display = 'none';
                        }
                    });
                    
                    // Add a "show more" indicator if not already present
                    if (!quadrant.querySelector('.show-more-indicator')) {
                        const indicator = document.createElement('div');
                        indicator.className = 'show-more-indicator';
                        indicator.innerHTML = `<small style="color: #666; font-style: italic;">+${cards.length - maxCards} more items...</small>`;
                        indicator.style.cursor = 'pointer';
                        indicator.onclick = function() {
                            // Show all cards
                            cards.forEach(card => card.style.display = 'block');
                            indicator.remove();
                        };
                        quadrant.appendChild(indicator);
                    }
                }
            });
        }


        // Main business tab management
        function showBusinessMainTab(tabName) {
            // Hide all main tab contents
            document.querySelectorAll('.business-main-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all main tab buttons
            document.querySelectorAll('.business-main-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const tabContent = document.getElementById(tabName + 'Content');
            const tabButton = document.getElementById(tabName + 'Tab');
            
            if (tabContent) tabContent.classList.add('active');
            if (tabButton) tabButton.classList.add('active');
            
            // Render VSM content when VSM tab is shown
            if (tabName === 'vsm') {
                setTimeout(() => {
                    showVSMSubTab('steps'); // Default to steps tab
                }, 100);
            }
            
            // Always check VSM Help visibility
            renderVSMHelp();
        }

        // VSM page functions
        function renderVSMPage() {
            const sections = ['currentStateMap', 'futureStateMap', 'vsmMetrics', 'improvementActions', 'wasteIdentification'];
            
            sections.forEach(section => {
                const displayElement = document.getElementById(`vsm${section.charAt(0).toUpperCase() + section.slice(1).replace(/([A-Z])/g, '$1')}Display`);
                if (displayElement) {
                    let content = appState.vsmInfo[section] || '';
                    
                    // Process Mermaid diagrams if content contains them
                    if (content.includes('```mermaid')) {
                        content = processMermaidContent(content);
                    }
                    
                    displayElement.innerHTML = content;
                    
                    // Initialize Mermaid if diagrams are present
                    if (content.includes('<div class="mermaid">')) {
                        if (typeof mermaid !== 'undefined') {
                            mermaid.init();
                        }
                    }
                }
            });
        }

        function editVSMSection(sectionType) {
            const titles = {
                currentStateMap: 'Current State Map',
                futureStateMap: 'Future State Map',
                vsmMetrics: 'Value Stream Metrics',
                improvementActions: 'Improvement Actions',
                wasteIdentification: 'Waste Identification'
            };
            
            document.getElementById('businessModalTitle').textContent = `Edit ${titles[sectionType]}`;
            document.getElementById('businessFieldLabel').textContent = `${titles[sectionType]}:`;
            document.getElementById('businessSectionType').value = sectionType;
            document.getElementById('businessContent').value = appState.vsmInfo[sectionType] || '';
            
            document.getElementById('businessEditModal').style.display = 'block';
        }

        // Update saveBusinessSection to handle both business and VSM
        function saveBusinessSection() {
            const sectionType = document.getElementById('businessSectionType').value;
            const content = document.getElementById('businessContent').value;
            
            // Determine if this is a VSM section or business section
            const vsmSections = ['currentStateMap', 'futureStateMap', 'vsmMetrics', 'improvementActions', 'wasteIdentification'];
            
            if (vsmSections.includes(sectionType)) {
                appState.vsmInfo[sectionType] = content;
                renderVSMPage();
            } else {
                appState.businessInfo[sectionType] = content;
                renderBusinessPage();
            }
            
            saveData();
        }

        function showVSMSubTab(tabName) {
            // Hide all VSM sub-tab contents
            document.querySelectorAll('.vsm-sub-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all VSM sub-tab buttons
            document.querySelectorAll('.vsm-sub-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const tabContent = document.getElementById(`vsm${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Content`);
            const tabButton = document.getElementById(`vsm${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`);
            
            if (tabContent) tabContent.classList.add('active');
            if (tabButton) tabButton.classList.add('active');
            
            // Render content based on active tab
            if (tabName === 'steps') {
                renderVSMSteps();
            } else if (tabName === 'view') {
                renderVSMView();
            } else if (tabName === 'help') {
                renderVSMHelp(); // Call VSM Help render function
            }
            
            // Always call renderVSMHelp to check visibility
            renderVSMHelp();
        }

        // VSM Steps Management
        function renderVSMSteps() {
            const container = document.getElementById('vsmStepsList');
            if (!container) return;
            
            container.innerHTML = appState.vsmSteps.map(step => `
                <div class="step-item ${step.type}" data-step-id="${step.id}">
                    <span class="drag-handle" title="Drag to reorder">⋮⋮</span>
                    <div class="step-content">
                        <div class="step-title">${step.name}</div>
                        <div class="step-description">${step.description || 'No description'}</div>
                        <div class="step-metrics">
                            <span>Value: ${step.valueAddedTime}min</span>
                            <span>Delay: ${step.delayTime}min</span>
                            <span>Accuracy: ${step.accuracyPercent}%</span>
                            <span>Type: ${step.type.charAt(0).toUpperCase() + step.type.slice(1)}</span>
                        </div>
                    </div>
                    <div class="step-actions">
                        <button class="icon-btn edit" onclick="editVSMStep(${step.id})" title="Edit">✏️</button>
                        <button class="icon-btn delete" onclick="deleteVSMStep(${step.id})" title="Delete">🗑️</button>
                    </div>
                </div>
            `).join('');
            
            // Initialize drag and drop
            initializeVSMStepSorting();
        }

        function initializeVSMStepSorting() {
            const container = document.getElementById('vsmStepsList');
            if (container) {
                new Sortable(container, {
                    animation: 150,
                    ghostClass: 'card-ghost',
                    chosenClass: 'card-chosen',
                    handle: '.drag-handle',
                    onEnd: function(evt) {
                        const stepId = parseInt(evt.item.dataset.stepId);
                        const newIndex = evt.newIndex;
                        reorderVSMStep(stepId, newIndex);
                    }
                });
            }
        }

        function reorderVSMStep(stepId, newIndex) {
            const step = appState.vsmSteps.find(s => s.id === stepId);
            if (step) {
                const currentIndex = appState.vsmSteps.findIndex(s => s.id === stepId);
                appState.vsmSteps.splice(currentIndex, 1);
                appState.vsmSteps.splice(newIndex, 0, step);
                saveData();
            }
        }

        function showAddStepModal() {
            document.getElementById('vsmStepModalTitle').textContent = 'Add Process Step';
            document.getElementById('vsmStepSubmitBtn').textContent = 'Add Step';
            document.getElementById('vsmStepForm').reset();
            document.getElementById('vsmStepId').value = '';
            document.getElementById('vsmStepModal').style.display = 'block';
        }

        function addVSMStep(stepData) {
            const newStep = {
                id: Date.now(),
                name: stepData.name,
                description: stepData.description,
                type: stepData.type,
                valueAddedTime: parseFloat(stepData.valueAddedTime) || 0,
                delayTime: parseFloat(stepData.delayTime) || 0,
                accuracyPercent: parseFloat(stepData.accuracyPercent) || 100,
                createdAt: new Date()
            };
            
            appState.vsmSteps.push(newStep);
            saveData();
            renderVSMSteps();
        }

        function editVSMStep(stepId) {
            const step = appState.vsmSteps.find(s => s.id === stepId);
            if (step) {
                document.getElementById('vsmStepModalTitle').textContent = 'Edit Process Step';
                document.getElementById('vsmStepSubmitBtn').textContent = 'Update Step';
                document.getElementById('vsmStepId').value = stepId;
                document.getElementById('stepName').value = step.name;
                document.getElementById('stepDescription').value = step.description;
                document.getElementById('stepType').value = step.type;
                document.getElementById('valueAddedTime').value = step.valueAddedTime;
                document.getElementById('delayTime').value = step.delayTime;
                document.getElementById('accuracyPercent').value = step.accuracyPercent;
                document.getElementById('vsmStepModal').style.display = 'block';
            }
        }

        function updateVSMStep(stepId, stepData) {
            const step = appState.vsmSteps.find(s => s.id === stepId);
            if (step) {
                step.name = stepData.name;
                step.description = stepData.description;
                step.type = stepData.type;
                step.valueAddedTime = parseFloat(stepData.valueAddedTime) || 0;
                step.delayTime = parseFloat(stepData.delayTime) || 0;
                step.accuracyPercent = parseFloat(stepData.accuracyPercent) || 100;
                saveData();
                renderVSMSteps();
            }
        }

        function deleteVSMStep(stepId) {
            if (confirm('Are you sure you want to delete this step?')) {
                appState.vsmSteps = appState.vsmSteps.filter(s => s.id !== stepId);
                saveData();
                renderVSMSteps();
            }
        }

        // VSM View Management
        function renderVSMView() {
            calculateVSMMetrics();
            renderValueStreamFlow();
        }

        function calculateVSMMetrics() {
            const steps = appState.vsmSteps;
            
            const totalSteps = steps.length;
            const totalValueTime = steps.reduce((sum, step) => sum + step.valueAddedTime, 0);
            const totalDelayTime = steps.reduce((sum, step) => sum + step.delayTime, 0);
            const totalProcessTime = totalValueTime + totalDelayTime;
            const processEfficiency = totalProcessTime > 0 ? ((totalValueTime / totalProcessTime) * 100) : 0;
            const averageAccuracy = steps.length > 0 ? (steps.reduce((sum, step) => sum + step.accuracyPercent, 0) / steps.length) : 0;
            
            // Update metrics display
            document.getElementById('totalSteps').textContent = totalSteps;
            document.getElementById('totalValueTime').textContent = `${totalValueTime.toFixed(1)} min`;
            document.getElementById('totalDelayTime').textContent = `${totalDelayTime.toFixed(1)} min`;
            document.getElementById('totalProcessTime').textContent = `${totalProcessTime.toFixed(1)} min`;
            document.getElementById('processEfficiency').textContent = `${processEfficiency.toFixed(2)}%`;
            document.getElementById('averageAccuracy').textContent = `${averageAccuracy.toFixed(2)}%`;
        }

        function renderValueStreamFlow() {
            const container = document.getElementById('valueStreamFlow');
            if (!container) return;
            
            const steps = appState.vsmSteps;
            
            if (steps.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No steps defined. Go to Process Steps tab to add steps.</div>';
                return;
            }
            
            let flowHtml = '';
            
            steps.forEach((step, index) => {
                const totalStepTime = step.valueAddedTime + step.delayTime;
                
                flowHtml += `
                    <div class="flow-step ${step.type}">
                        <div class="flow-step-name">${step.name}</div>
                        <div class="flow-step-times">
                            VA: ${step.valueAddedTime}min | Delay: ${step.delayTime}min
                        </div>
                        <div class="flow-step-accuracy">${step.accuracyPercent}% accuracy</div>
                        ${step.valueAddedTime > 0 ? `<div class="time-indicator value-added">+${step.valueAddedTime}min</div>` : ''}
                        ${step.delayTime > 0 ? `<div class="time-indicator delay">${step.delayTime}min delay</div>` : ''}
                    </div>
                `;
                
                if (index < steps.length - 1) {
                    flowHtml += '<span class="flow-arrow">→</span>';
                }
            });
            
            container.innerHTML = flowHtml;
        }

        // Form handler
        function handleVSMStep(e) {
            e.preventDefault();
            
            const stepData = {
                name: document.getElementById('stepName').value,
                description: document.getElementById('stepDescription').value,
                type: document.getElementById('stepType').value,
                valueAddedTime: document.getElementById('valueAddedTime').value,
                delayTime: document.getElementById('delayTime').value,
                accuracyPercent: document.getElementById('accuracyPercent').value
            };
            
            const stepId = document.getElementById('vsmStepId').value;
            
            if (stepId) {
                updateVSMStep(parseInt(stepId), stepData);
            } else {
                addVSMStep(stepData);
            }
            
            closeModal('vsmStepModal');
        }

        function migrateData() {
            // Remove Backlog column from board configuration if it exists
            if (appState.boardConfig && appState.boardConfig.length > 0) {
                appState.boardConfig = appState.boardConfig.filter(column => column.name !== 'Backlog');
                
                // Ensure we have the correct board config without Backlog
                if (appState.boardConfig.length === 0 || appState.boardConfig.some(col => col.name === 'Backlog')) {
                    appState.boardConfig = [
                        {
                            name: 'To Do', 
                            wipLimit: 5, 
                            subColumns: ['Ready', 'Analyzing'],
                            bufferColumns: ['Buffer']
                        },
                        {
                            name: 'In Progress', 
                            wipLimit: 3, 
                            subColumns: ['Development', 'Code Review', 'Testing'],
                            bufferColumns: ['Dev Buffer', 'Review Buffer'],
                            subColumnTypes: {
                                'Development': 'doing',
                                'Code Review': 'doing', 
                                'Testing': 'doing'
                            }
                        },
                        {
                            name: 'Done', 
                            wipLimit: null, 
                            subColumns: ['Deployed', 'Verified'],
                            bufferColumns: ['Done Buffer'],
                            subColumnTypes: {
                                'Deployed': 'done',
                                'Verified': 'done'
                            }
                        }
                    ];
                }
            }
            
            // Remove any cards that are in the Backlog column
            if (appState.cards) {
                appState.cards = appState.cards.filter(card => card.column !== 'Backlog');
            }
            
            // Save the migrated data
            saveData();
        }
        


// BOARD CONFIGURATION STRUCTURE
const boardConfigStructure = [
  {
    name: 'Backlog',
    workflowState: 'todo', // Maps to fundamental state for metrics
    wipLimit: null,
    subColumns: [],
    bufferColumns: []
  },
  {
    name: 'To Do',
    workflowState: 'todo',
    wipLimit: 5,
    subColumns: [
      {
        name: 'Ready',
        workflowState: 'todo',
        bufferColumns: [
          { name: 'Ready Doing', state: 'doing' },
          { name: 'Ready Done', state: 'done' }
        ]
      },
      {
        name: 'Analyzing', 
        workflowState: 'todo',
        bufferColumns: [
          { name: 'Analysis Doing', state: 'doing' },
          { name: 'Analysis Done', state: 'done' }
        ]
      }
    ],
    bufferColumns: [
      { name: 'To Do Doing', state: 'doing' },
      { name: 'To Do Done', state: 'done' }
    ]
  },
  {
    name: 'In Progress',
    workflowState: 'in-progress',
    wipLimit: 3,
    subColumns: [
      {
        name: 'Development',
        workflowState: 'in-progress',
        bufferColumns: [
          { name: 'Dev Doing', state: 'doing' },
          { name: 'Dev Done', state: 'done' }
        ]
      },
      {
        name: 'Code Review',
        workflowState: 'in-progress', 
        bufferColumns: [
          { name: 'Review Doing', state: 'doing' },
          { name: 'Review Done', state: 'done' }
        ]
      },
      {
        name: 'Testing',
        workflowState: 'in-progress',
        bufferColumns: [
          { name: 'Test Doing', state: 'doing' },
          { name: 'Test Done', state: 'done' }
        ]
      }
    ],
    bufferColumns: []
  },
  {
    name: 'Done',
    workflowState: 'done',
    wipLimit: null,
    subColumns: [
      {
        name: 'Deployed',
        workflowState: 'done',
        bufferColumns: []
      },
      {
        name: 'Verified',
        workflowState: 'done', 
        bufferColumns: []
      }
    ],
    bufferColumns: []
  }
];

// BOARD CONFIGURATION UI BUILDER
function showBoardConfigurationUI() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'boardConfigModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <div class="modal-header">
                <h2>Board Configuration</h2>
                <span class="close" onclick="closeBoardConfigModal()">&times;</span>
            </div>
            <div id="boardConfigBuilder">
                <div class="config-tabs">
                    <button class="config-tab-btn active" onclick="showConfigTab('columns')">Columns</button>
                    <button class="config-tab-btn" onclick="showConfigTab('preview')">Preview</button>
                    <button class="config-tab-btn" onclick="showConfigTab('json')">JSON Export</button>
                </div>
                
                <div id="columnsConfig" class="config-tab active">
                    <div class="config-header">
                        <h3>Board Columns Configuration</h3>
                        <button class="btn btn-primary" onclick="addNewColumn()">Add Column</button>
                    </div>
                    <div id="columnsContainer"></div>
                </div>
                
                <div id="previewConfig" class="config-tab">
                    <div id="boardPreview"></div>
                </div>
                
                <div id="jsonConfig" class="config-tab">
                    <textarea id="configJSON" rows="20" style="width: 100%; font-family: monospace;"></textarea>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="importFromJSON()">Import Configuration</button>
                        <button class="btn btn-secondary" onclick="exportToJSON()">Copy JSON</button>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-success" onclick="saveConfiguration()">Save Configuration</button>
                <button class="btn btn-secondary" onclick="closeBoardConfigModal()">Cancel</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.style.display = 'block';
    renderColumnsConfig();
}

function renderColumnsConfig() {
    const container = document.getElementById('columnsContainer');
    container.innerHTML = appState.boardConfig.map((column, columnIndex) => `
        <div class="column-config" data-column-index="${columnIndex}">
            <div class="column-header-config">
                <input type="text" value="${column.name}" onchange="updateColumnName(${columnIndex}, this.value)" class="column-name-input">
                <select onchange="updateColumnWorkflowState(${columnIndex}, this.value)" class="workflow-select">
                    <option value="todo" ${column.workflowState === 'todo' ? 'selected' : ''}>To Do State</option>
                    <option value="in-progress" ${column.workflowState === 'in-progress' ? 'selected' : ''}>In Progress State</option>
                    <option value="done" ${column.workflowState === 'done' ? 'selected' : ''}>Done State</option>
                </select>
                <input type="number" value="${column.wipLimit || ''}" placeholder="WIP Limit" onchange="updateColumnWipLimit(${columnIndex}, this.value)" class="wip-input">
                <button class="btn btn-danger" onclick="removeColumn(${columnIndex})">Remove</button>
            </div>
            
            <div class="column-structure">
                <div class="buffer-columns-section">
                    <h4>Column Buffer Columns</h4>
                    <button class="btn btn-sm" onclick="addColumnBuffer(${columnIndex})">Add Buffer Pair</button>
                    <div class="buffer-pairs">
                        ${renderBufferPairs(column.bufferColumns, columnIndex, 'column')}
                    </div>
                </div>
                
                <div class="sub-columns-section">
                    <h4>Sub Columns</h4>
                    <button class="btn btn-sm" onclick="addSubColumn(${columnIndex})">Add Sub Column</button>
                    <div class="sub-columns-list">
                        ${renderSubColumns(column.subColumns, columnIndex)}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function getVisibleCardsInColumn(column, allCardsInColumn) {
    let visibleCards = [];
    
    if (appState.showSubColumns && column.subColumns && column.subColumns.length > 0) {
        // Count cards in sub-columns and their buffers
        column.subColumns.forEach(subCol => {
            // Regular sub-column cards
            visibleCards.push(...allCardsInColumn.filter(card => 
                card.subColumn === subCol.name && !card.isInBuffer));
            
            // Sub-column buffer cards
            if (appState.showBufferColumns && subCol.bufferColumns) {
                subCol.bufferColumns.forEach(buffer => {
                    visibleCards.push(...allCardsInColumn.filter(card => 
                        card.subColumn === buffer.name && card.isInBuffer));
                });
            }
        });
    }
    
    if (appState.showBufferColumns && column.bufferColumns && column.bufferColumns.length > 0) {
        // Count column-level buffer cards
        column.bufferColumns.forEach(buffer => {
            visibleCards.push(...allCardsInColumn.filter(card => 
                card.subColumn === buffer.name && card.isInBuffer));
        });
    }
    
    // If no structure, count all unassigned cards
    if ((!column.subColumns || column.subColumns.length === 0) && 
        (!column.bufferColumns || column.bufferColumns.length === 0)) {
        visibleCards = allCardsInColumn.filter(card => !card.subColumn);
    }
    
    // Exclude Expedite cards from WIP limit calculation when using Classes of Service
    if (appState.showClassesOfService) {
        visibleCards = visibleCards.filter(card => (card.classOfService || 'Standard') !== 'Expedite');
    }
    
    return visibleCards;
}

function renderBufferPairs(bufferColumns, cardsInColumn, parentName, level) {
    let content = '';
    
    for (let i = 0; i < bufferColumns.length; i += 2) {
        const doingBuffer = bufferColumns[i];
        const doneBuffer = bufferColumns[i + 1];
        
        if (doingBuffer && doneBuffer) {
            const doingCards = cardsInColumn.filter(card => 
                card.subColumn === doingBuffer.name && card.isInBuffer
            ).sort((a, b) => (a.position || 0) - (b.position || 0));
            
            const doneCards = cardsInColumn.filter(card => 
                card.subColumn === doneBuffer.name && card.isInBuffer
            ).sort((a, b) => (a.position || 0) - (b.position || 0));
            
            // VERTICAL LAYOUT - Stack doing and done vertically
            content += `
                <div class="buffer-pair-vertical ${level}">
                    <div class="buffer-column doing" data-sub-column="${doingBuffer.name}">
                        <div class="buffer-header">
                            <span class="buffer-title">${doingBuffer.name}</span>
                            <span class="card-count">${doingCards.length}</span>
                        </div>
                        <div class="buffer-content">
                            ${doingCards.map(card => renderCard(card)).join('')}
                        </div>
                    </div>
                    <div class="buffer-separator-horizontal"></div>
                    <div class="buffer-column done" data-sub-column="${doneBuffer.name}">
                        <div class="buffer-header">
                            <span class="buffer-title">${doneBuffer.name}</span>
                            <span class="card-count">${doneCards.length}</span>
                        </div>
                        <div class="buffer-content">
                            ${doneCards.map(card => renderCard(card)).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    return content;
}

// CONFIGURATION MANIPULATION FUNCTIONS
function addNewColumn() {
    appState.boardConfig.push({
        name: 'New Column',
        workflowState: 'todo',
        wipLimit: null,
        subColumns: [],
        bufferColumns: []
    });
    renderColumnsConfig();
}

function addColumnBuffer(columnIndex) {
    if (!appState.boardConfig[columnIndex].bufferColumns) {
        appState.boardConfig[columnIndex].bufferColumns = [];
    }
    appState.boardConfig[columnIndex].bufferColumns.push(
        { name: 'New Doing', state: 'doing' },
        { name: 'New Done', state: 'done' }
    );
    renderColumnsConfig();
}

function addSubColumn(columnIndex) {
    if (!appState.boardConfig[columnIndex].subColumns) {
        appState.boardConfig[columnIndex].subColumns = [];
    }
    appState.boardConfig[columnIndex].subColumns.push({
        name: 'New Sub Column',
        workflowState: 'todo',
        bufferColumns: []
    });
    renderColumnsConfig();
}

function addSubColumnBuffer(columnIndex, subColumnIndex) {
    const subCol = appState.boardConfig[columnIndex].subColumns[subColumnIndex];
    if (!subCol.bufferColumns) subCol.bufferColumns = [];
    subCol.bufferColumns.push(
        { name: 'New Sub Doing', state: 'doing' },
        { name: 'New Sub Done', state: 'done' }
    );
    renderColumnsConfig();
}

// UPDATED RENDERING FOR HIERARCHICAL BOARD
function renderSubColumns(column, cardsInColumn) {
    let content = '';
    
    // Case 1: Neither sub-columns nor buffers are enabled - show all cards in main column
    if (!appState.showSubColumns && !appState.showBufferColumns) {
        const allCards = cardsInColumn.sort((a, b) => (a.position || 0) - (b.position || 0));
        content = allCards.map(card => renderCard(card)).join('');
    }
    // Case 2: Only sub-columns enabled, no buffers
    else if (appState.showSubColumns && !appState.showBufferColumns) {
        if (column.subColumns && column.subColumns.length > 0) {
            content += column.subColumns.map(subCol => {
                const subColCards = cardsInColumn.filter(card => 
                    card.subColumn === subCol.name
                ).sort((a, b) => (a.position || 0) - (b.position || 0));
                
                return `
                    <div class="sub-column" data-sub-column="${subCol.name}">
                        <div class="sub-column-header ${subCol.workflowState || 'todo'}">
                            <strong>${subCol.name}</strong>
                            <span class="card-count">${subColCards.length}</span>
                        </div>
                        <div class="sub-column-content">
                            ${subColCards.map(card => renderCard(card)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Show cards without sub-column assignment
            const unassignedCards = cardsInColumn.filter(card => !card.subColumn)
                .sort((a, b) => (a.position || 0) - (b.position || 0));
            if (unassignedCards.length > 0) {
                content += unassignedCards.map(card => renderCard(card)).join('');
            }
        } else {
            // No sub-columns configured, show all cards
            const allCards = cardsInColumn.sort((a, b) => (a.position || 0) - (b.position || 0));
            content = allCards.map(card => renderCard(card)).join('');
        }
    }
    // Case 3: Only buffers enabled, no sub-columns
    else if (!appState.showSubColumns && appState.showBufferColumns) {
        if (column.bufferColumns && column.bufferColumns.length > 0) {
            content += renderBufferPairs(column.bufferColumns, cardsInColumn, column.name, 'column');
        }
        
        // Show cards not in buffers
        const nonBufferCards = cardsInColumn.filter(card => !card.isInBuffer)
            .sort((a, b) => (a.position || 0) - (b.position || 0));
        if (nonBufferCards.length > 0) {
            content += nonBufferCards.map(card => renderCard(card)).join('');
        }
    }
    // Case 4: Both sub-columns and buffers enabled
    else if (appState.showSubColumns && appState.showBufferColumns) {
        // Column-level buffer pairs
        if (column.bufferColumns && column.bufferColumns.length > 0) {
            content += renderBufferPairs(column.bufferColumns, cardsInColumn, column.name, 'column');
        }
        
        // Sub-columns with potential buffers
        if (column.subColumns && column.subColumns.length > 0) {
            content += column.subColumns.map(subCol => {
                const subColCards = cardsInColumn.filter(card => 
                    card.subColumn === subCol.name && !card.isInBuffer
                ).sort((a, b) => (a.position || 0) - (b.position || 0));
                
                let subContent = `
                    <div class="sub-column" data-sub-column="${subCol.name}">
                        <div class="sub-column-header ${subCol.workflowState || 'todo'}">
                            <strong>${subCol.name}</strong>
                            <span class="card-count">${subColCards.length}</span>
                        </div>
                        <div class="sub-column-content">
                            ${subColCards.map(card => renderCard(card)).join('')}
                        </div>
                    </div>
                `;
                
                // Sub-column buffer pairs
                if (subCol.bufferColumns && subCol.bufferColumns.length > 0) {
                    subContent += renderBufferPairs(subCol.bufferColumns, cardsInColumn, subCol.name, 'subColumn');
                }
                
                return subContent;
            }).join('');
        }
    }
    
    return content || '<div style="min-height: 200px;"></div>';
}

function renderBufferColumnPairs(bufferColumns, cardsInColumn, level) {
    let content = '';
    
    for (let i = 0; i < bufferColumns.length; i += 2) {
        const doingBuffer = bufferColumns[i];
        const doneBuffer = bufferColumns[i + 1];
        
        if (doingBuffer && doneBuffer) {
            const doingCards = cardsInColumn.filter(card => 
                card.subColumn === doingBuffer.name && card.bufferType === 'buffer'
            ).sort((a, b) => (a.position || 0) - (b.position || 0));
            
            const doneCards = cardsInColumn.filter(card => 
                card.subColumn === doneBuffer.name && card.bufferType === 'buffer'
            ).sort((a, b) => (a.position || 0) - (b.position || 0));
            
            content += `
                <div class="buffer-pair-container ${level}">
                    <div class="buffer-column doing" data-sub-column="${doingBuffer.name}">
                        <div class="buffer-header">
                            <strong>${doingBuffer.name}</strong>
                            <span class="card-count">${doingCards.length}</span>
                        </div>
                        <div class="buffer-content">
                            ${doingCards.map(card => renderCard(card)).join('')}
                        </div>
                    </div>
                    <div class="buffer-separator"></div>
                    <div class="buffer-column done" data-sub-column="${doneBuffer.name}">
                        <div class="buffer-header">
                            <strong>${doneBuffer.name}</strong>
                            <span class="card-count">${doneCards.length}</span>
                        </div>
                        <div class="buffer-content">
                            ${doneCards.map(card => renderCard(card)).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    return content;
}

function checkWipLimits(columnName) {
    const column = appState.boardConfig.find(c => c.name === columnName);
    if (column && column.wipLimit) {
        const visibleCards = getVisibleCardsInColumn(column, appState.cards.filter(c => c.column === columnName));
        // Only alert when EXCEEDING the limit (> not >=)
        if (visibleCards.length > column.wipLimit) {
            alert(`Warning: Column "${columnName}" exceeds WIP limit of ${column.wipLimit}! Current: ${visibleCards.length}`);
        }
    }
}

function getCardWorkflowState(columnName, subColumnName) {
    const column = appState.boardConfig.find(col => col.name === columnName);
    if (!column) return 'todo';
    
    // Check if card is in a sub-column
    if (subColumnName && column.subColumns) {
        const subCol = column.subColumns.find(sub => sub.name === subColumnName);
        if (subCol) return subCol.workflowState;
        
        // Check if it's a buffer column belonging to a sub-column
        for (const subCol of column.subColumns) {
            if (subCol.bufferColumns && subCol.bufferColumns.some(buffer => buffer.name === subColumnName)) {
                return subCol.workflowState;
            }
        }
    }
    
    // Default to column's workflow state
    return column.workflowState;
}

function trackCardMovement(card, oldColumn, oldSubColumn, oldIsBuffer) {
    const oldWorkflowState = getCardWorkflowState(oldColumn, oldSubColumn);
    const newWorkflowState = getCardWorkflowState(card.column, card.subColumn);
    
    // Track workflow state transitions for metrics
    if (oldWorkflowState === 'todo' && newWorkflowState === 'in-progress') {
        card.startedAt = new Date();
    }
    
    if (oldWorkflowState !== 'done' && newWorkflowState === 'done') {
        card.completedAt = new Date();
    }
    
    // Log movement for audit trail
    if (!card.movements) card.movements = [];
    card.movements.push({
        from: { 
            column: oldColumn, 
            subColumn: oldSubColumn, 
            isBuffer: oldIsBuffer 
        },
        to: { 
            column: card.column, 
            subColumn: card.subColumn, 
            isBuffer: card.isInBuffer 
        },
        timestamp: new Date(),
        workflowStateChange: oldWorkflowState !== newWorkflowState
    });
}


// METRICS CALCULATION BASED ON WORKFLOW STATES
function calculateWorkflowMetrics() {
    const cards = appState.cards;
    const metrics = {
        cycleTime: [],
        leadTime: [],
        throughput: { todo: 0, inProgress: 0, done: 0 }
    };
    
    cards.forEach(card => {
        const cardLocation = findCardWorkflowState(card);
        metrics.throughput[cardLocation]++;
        
        if (card.startedAt && card.completedAt) {
            metrics.cycleTime.push((new Date(card.completedAt) - new Date(card.startedAt)) / (1000 * 60 * 60 * 24));
        }
        
        if (card.createdAt && card.completedAt) {
            metrics.leadTime.push((new Date(card.completedAt) - new Date(card.createdAt)) / (1000 * 60 * 60 * 24));
        }
    });
    
    return metrics;
}

function findCardWorkflowState(card) {
    const column = appState.boardConfig.find(col => col.name === card.column);
    if (!column) return 'todo';
    
    // Check if card is in a sub-column with specific workflow state
    if (card.subColumn && column.subColumns) {
        const subCol = column.subColumns.find(sub => sub.name === card.subColumn);
        if (subCol) return subCol.workflowState;
    }
    
    // Check if card is in a buffer column
    if (card.bufferType === 'buffer') {
        // Buffer columns inherit the workflow state of their parent
        return column.workflowState;
    }
    
    return column.workflowState;
}

// CARD MOVEMENT TRACKING FOR METRICS

// CSS FOR BUFFER COLUMNS WITH DOTTED SEPARATORS
const bufferColumnCSS = `
.buffer-pair-container {
    display: flex;
    margin: 0.5rem 0;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e9ecef;
}

.buffer-pair-container.column {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
}

.buffer-pair-container.subColumn {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    margin-left: 1rem;
}

.buffer-column {
    flex: 1;
    min-height: 100px;
}

.buffer-separator {
    width: 2px;
    background: repeating-linear-gradient(
        to bottom,
        #333 0,
        #333 5px,
        transparent 5px,
        transparent 15px
    );
}

.buffer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: rgba(255, 255, 255, 0.8);
    border-bottom: 1px solid #dee2e6;
    font-size: 0.9rem;
}

.buffer-content {
    padding: 0.5rem;
    min-height: 80px;
}

.buffer-column.doing .buffer-header {
    border-left: 3px solid #ffc107;
}

.buffer-column.done .buffer-header {
    border-left: 3px solid #28a745;
}
`;






















        // Initialize application
        function init() {
            loadData();
            migrateData();
            initNavigation();
            initAvatarSelector();
            
            // Add event listeners for forms
            document.getElementById('addCardForm').addEventListener('submit', handleAddCard);
            document.getElementById('addItemForm').addEventListener('submit', handleAddItem);
            document.getElementById('addMemberForm').addEventListener('submit', handleAddMember);
            document.getElementById('boardConfigForm').addEventListener('submit', handleBoardConfig);
            document.getElementById('columnPolicyForm').addEventListener('submit', handleColumnPolicy);
            document.getElementById('commonPolicyForm').addEventListener('submit', handleCommonPolicy);
            document.getElementById('addServiceReviewForm').addEventListener('submit', handleAddServiceReview);
            document.getElementById('addOperationsReviewForm').addEventListener('submit', handleAddOperationsReview);
            // Add these two lines with the other event listeners
            document.getElementById('editServiceReviewForm').addEventListener('submit', handleEditServiceReview);
            document.getElementById('editOperationsReviewForm').addEventListener('submit', handleEditOperationsReview);
            // Add these lines with other event listeners in the init() function
            document.getElementById('addExperimentForm').addEventListener('submit', handleAddExperiment);
            document.getElementById('editExperimentForm').addEventListener('submit', handleEditExperiment);
            document.getElementById('businessEditForm').addEventListener('submit', handleBusinessEdit);
            document.getElementById('vsmStepForm').addEventListener('submit', handleVSMStep);
            
            // // Close modals when clicking outside -- FIX TO AVOID ACCIDENTAL CLOSURES
            // window.addEventListener('click', (e) => {
            //     if (e.target.classList.contains('modal')) {
            //         e.target.style.display = 'none';
            //     }
            // });
            
            // Initial render
            renderKanbanBoard();
            // Render common policies on initial load
            setTimeout(renderCommonPolicies, 100);
            
            // Simulate daily snapshot creation
            setInterval(() => {
                const today = new Date().toISOString().split('T')[0];
                if (!appState.dailySnapshots.find(s => s.date === today)) {
                    appState.dailySnapshots.push({
                        date: today,
                        'Backlog': appState.backlogItems.length,
                        'To Do': appState.cards.filter(c => c.column === 'To Do').length,
                        'In Progress': appState.cards.filter(c => c.column === 'In Progress').length,
                        'Done': appState.cards.filter(c => c.column === 'Done').length
                    });
                    saveData();
                }
            }, 60000); // Check every minute
            // Initialize Mermaid
            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({ startOnLoad: true, theme: 'default' });
            }
        }

        // Update checkbox states after DOM is ready
        function updateCheckboxStates() {
            const subColCheckbox = document.getElementById('showSubColumns');
            const bufferCheckbox = document.getElementById('showBufferColumns');
            const swimlanesCheckbox = document.getElementById('showSwimlanes');
            const cosCheckbox = document.getElementById('showClassesOfService');
            const policiesCheckbox = document.getElementById('showPolicies');
            
            if (subColCheckbox) {
                subColCheckbox.checked = appState.showSubColumns;
            }
            if (bufferCheckbox) {
                bufferCheckbox.checked = appState.showBufferColumns;
            }
            if (swimlanesCheckbox) {
                swimlanesCheckbox.checked = appState.showSwimlanes;
            }
            if (cosCheckbox) {
                cosCheckbox.checked = appState.showClassesOfService;
            }
            if (policiesCheckbox) {
                policiesCheckbox.checked = appState.showPolicies;
                // Set initial policies visibility
                togglePolicies();
            }
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
    
</body>
</html>

<!--
boardconfig
[
  {
    "name": "To Do",
    "wipLimit": 5,
    "workflowState": "todo",
    "subColumns": [
      {
        "name": "Ready",
        "workflowState": "todo",
        "bufferColumns": [
          {
            "name": "Ready Doing",
            "state": "doing"
          },
          {
            "name": "Ready Done",
            "state": "done"
          }
        ]
      },
      {
        "name": "Analyzing",
        "workflowState": "todo",
        "bufferColumns": [
          {
            "name": "Analysis Doing",
            "state": "doing"
          },
          {
            "name": "Analysis Done",
            "state": "done"
          }
        ]
      }
    ],
    "bufferColumns": [
      {
        "name": "To Do Doing",
        "state": "doing"
      },
      {
        "name": "To Do Done",
        "state": "done"
      }
    ]
  },
  {
    "name": "In Progress",
    "wipLimit": 3,
    "workflowState": "in-progress",
    "subColumns": [
      {
        "name": "Development",
        "workflowState": "in-progress",
        "bufferColumns": [
          {
            "name": "Dev Doing",
            "state": "doing"
          },
          {
            "name": "Dev Done",
            "state": "done"
          }
        ]
      },
      {
        "name": "Code Review",
        "workflowState": "in-progress",
        "bufferColumns": [
          {
            "name": "Review Doing",
            "state": "doing"
          },
          {
            "name": "Review Done",
            "state": "done"
          }
        ]
      },
      {
        "name": "Testing",
        "workflowState": "in-progress",
        "bufferColumns": [
          {
            "name": "Test Doing",
            "state": "doing"
          },
          {
            "name": "Test Done",
            "state": "done"
          }
        ]
      }
    ],
    "bufferColumns": []
  },
  {
    "name": "Done",
    "wipLimit": null,
    "workflowState": "done",
    "subColumns": [
      {
        "name": "Deployed",
        "workflowState": "done",
        "bufferColumns": []
      },
      {
        "name": "Verified",
        "workflowState": "done",
        "bufferColumns": []
      }
    ],
    "bufferColumns": []
  }
]
-->